title: Notes
icon: mdi:notebook
views:
  - title: Notes
    path: notes
    icon: mdi:note-text
    sections:
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .add-img-label { display: inline-block; padding: 10px 16px; background: var(--secondary-background-color); color: var(--primary-text-color); border: 1px solid var(--divider-color); border-radius: 6px; cursor:      pointer; font-size: 1em; }
                .add-img-label input { display: none; }
                .create-note-form { padding: 16px; }
                .create-note-form h3 { margin: 0 0 12px 0; color: var(--primary-text-color); }
                .create-note-form input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--divider-color); border-radius: 6px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .create-note-form textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--divider-color); border-radius: 6px; resize: vertical; font-family: inherit; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .create-note-form button { padding: 10px 20px; background: var(--primary-color); color: var(--text-primary-color, white); border: none; border-radius: 6px; cursor: pointer; font-size: 1em; margin-top: 10px; }
                .create-note-form button:hover { opacity: 0.9; }
                .create-note-form .btn-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
                .create-img-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
                .create-img-preview .preview-thumb { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; }
                .create-img-preview .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .create-img-preview .preview-thumb button { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; }
                .create-status { font-size: 0.85em; color: var(--primary-color); margin-top: 8px; min-height: 20px; }
                .format-toggle { display: flex; gap: 0; margin-bottom: 10px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); width: fit-content; }
                .format-toggle button { padding: 6px 14px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
                .format-toggle button.active { background: var(--primary-color); color: white; }
                .format-toggle button:hover:not(.active) { background: var(--divider-color); }
                .add-img-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color), color-mix(in srgb, var(--primary-color) 80%, #000)); color: var(--text-primary-color, white); border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
                .add-img-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
                .add-img-btn:active { transform: translateY(0); }
                .add-img-btn input { display: none; }
              </style>
              <div class="create-note-form">
                <h3>New Note</h3>
                <input type="text" class="new-note-title" placeholder="Title">
                <div class="format-toggle">
                  <button type="button" class="format-btn active" data-format="html" onclick="this.classList.add('active');this.nextElementSibling.classList.remove('active');this.closest('.create-note-form').querySelector('.new-note-content').placeholder='Content (HTML tags accepted)';">HTML</button>
                  <button type="button" class="format-btn" data-format="md" onclick="this.classList.add('active');this.previousElementSibling.classList.remove('active');this.closest('.create-note-form').querySelector('.new-note-content').placeholder='Content (Markdown supported)';">Markdown</button>
                </div>
                <textarea class="new-note-content" placeholder="Content (HTML tags accepted)"></textarea>
                <div class="lock-option" style="margin:10px 0;padding:10px;background:var(--secondary-background-color);border-radius:6px;">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;"><input type="checkbox" class="lock-checkbox" onchange="this.closest('.lock-option').querySelector('.lock-password').style.display=this.checked?'block':'none';">Password protect this note</label>
                  <input type="password" class="lock-password" placeholder="Enter password to lock note" style="display:none;width:100%;padding:8px;margin-top:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);box-sizing:border-box;">
                </div>
                <div class="create-img-preview"></div>
                <div class="btn-row">
                  <label class="add-img-btn">Add Image<input type="file" accept="image/*" onchange="var input=this,form=input.closest('.create-note-form'),preview=form.querySelector('.create-img-preview'),status=form.querySelector('.create-status'),maxBytes=15*1024*1024;if(input.files[0]){status.textContent='Processing...';var file=input.files[0];var addThumb=function(dataUrl,name){var div=document.createElement('div');div.className='preview-thumb';div.dataset.name=name;div.dataset.data=dataUrl;var img=document.createElement('img');img.src=dataUrl;div.appendChild(img);var btn=document.createElement('button');btn.textContent='Ã—';btn.onclick=function(e){e.preventDefault();div.remove();};div.appendChild(btn);preview.appendChild(div);status.textContent='Added '+name;};if(file.size<=maxBytes){var reader=new FileReader();reader.onload=function(e){addThumb(e.target.result,file.name);};reader.readAsDataURL(file);}else{var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.width,h=img.height,q=0.9,s=1;var tryIt=function(){canvas.width=w*s;canvas.height=h*s;ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(blob){if(blob.size<=maxBytes||q<0.1){var r2=new FileReader();r2.onload=function(e2){addThumb(e2.target.result,file.name.replace(/\\.[^.]+$/,'.jpg'));};r2.readAsDataURL(blob);}else{q-=0.1;if(q<0.5)s*=0.8;tryIt();}},'image/jpeg',q);};tryIt();};img.src=e.target.result;};reader.readAsDataURL(file);}}input.value='';"></label>
                  <button type="button" class="create-btn" onclick="(function(btn){var form=btn.closest('.create-note-form'),titleEl=form.querySelector('.new-note-title'),contentEl=form.querySelector('.new-note-content'),title=titleEl.value,content=contentEl.value,status=form.querySelector('.create-status'),preview=form.querySelector('.create-img-preview'),thumbs=preview.querySelectorAll('.preview-thumb'),mdBtn=form.querySelector('.format-btn[data-format=md]'),isMd=mdBtn.classList.contains('active'),lockCb=form.querySelector('.lock-checkbox'),lockPw=form.querySelector('.lock-password'),shouldLock=lockCb.checked,password=lockPw.value;if(!title.trim()){alert('Title is required');return;}if(shouldLock&amp;&amp;!password){alert('Please enter a password');return;}if(isMd){content=String.fromCharCode(60)+'!--MD--'+String.fromCharCode(62)+content;}var doCreate=function(finalContent){btn.disabled=true;btn.textContent='Creating...';var noteId='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0;return(c==='x'?r:(r%4+8)).toString(16);});var ha=document.querySelector('home-assistant'),token=ha.hass.auth.data.access_token;ha.hass.callService('jottick','create_note',{title:title,content:finalContent,note_id:noteId});if(thumbs.length>0){status.textContent='Uploading images...';var done=0,total=thumbs.length;thumbs.forEach(function(thumb){fetch(thumb.dataset.data).then(function(r){return r.blob();}).then(function(blob){var fd=new FormData();fd.append('note_id',noteId);fd.append('file',blob,thumb.dataset.name);return fetch('/api/jottick/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd});}).then(function(){done++;status.textContent='Uploaded '+done+'/'+total;if(done>=total){status.textContent='Note created!';btn.disabled=false;btn.textContent='Create';}}).catch(function(e){status.textContent='Error: '+e;});});}else{status.textContent='Note created!';btn.disabled=false;btn.textContent='Create';}titleEl.value='';contentEl.value='';preview.innerHTML='';lockCb.checked=false;lockPw.value='';lockPw.style.display='none';form.querySelector('.format-btn[data-format=html]').classList.add('active');mdBtn.classList.remove('active');contentEl.placeholder='Content (HTML tags accepted)';};if(shouldLock){status.textContent='Encrypting...';var enc=new TextEncoder();var salt=crypto.getRandomValues(new Uint8Array(16));var iv=crypto.getRandomValues(new Uint8Array(12));crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveBits','deriveKey']).then(function(keyMaterial){return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['encrypt']);}).then(function(key){return crypto.subtle.encrypt({name:'AES-GCM',iv:iv},key,enc.encode(content));}).then(function(encrypted){var b64=function(arr){return btoa(String.fromCharCode.apply(null,new Uint8Array(arr)));};var final=String.fromCharCode(60)+'!--ENC:'+b64(salt)+':'+b64(iv)+'--'+String.fromCharCode(62)+b64(encrypted);doCreate(final);}).catch(function(e){status.textContent='Encryption error: '+e;btn.disabled=false;});}else{doCreate(content);}})(this);">Create</button>
                </div>
                <div class="create-status"></div>
              </div>
            grid_options:
              columns: full
              rows: auto
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: >
              <style>
                .reminder-config{padding:16px;font-family:var(--paper-font-body1_-_font-family);}
                .reminder-config h3{margin:0 0 8px 0;color:var(--primary-text-color);font-size:1.1em;}
                .reminder-config .help{font-size:0.85em;color:var(--secondary-text-color);margin-bottom:12px;}
                .reminder-config .section{background:var(--secondary-background-color);border-radius:8px;padding:12px;margin-bottom:12px;}
                .reminder-config .section-title{font-weight:600;font-size:0.95em;margin-bottom:8px;color:var(--primary-text-color);}
                .reminder-config select,.reminder-config input[type=text]{width:100%;padding:10px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:6px;background:var(--card-background-color);color:var(--primary-text-color);font-size:1em;box-sizing:border-box;}
                .reminder-config button.save-btn{padding:8px 16px;background:var(--primary-color);color:var(--text-primary-color,white);border:none;border-radius:6px;cursor:pointer;font-size:0.9em;margin-right:8px;}
                .reminder-config button.save-btn:hover{opacity:0.9;}
                .reminder-config button.save-btn:disabled{opacity:0.5;cursor:not-allowed;}
                .reminder-config .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--card-background-color);border-radius:6px;margin:4px 0;font-size:0.9em;}
                .reminder-config .item .del{padding:4px 10px;background:#ef4444;color:white;font-size:0.8em;margin:0;border:none;border-radius:4px;cursor:pointer;}
                .reminder-config .status{font-size:0.85em;color:var(--primary-color);margin-top:8px;min-height:18px;}
                .reminder-config .empty{font-style:italic;color:var(--secondary-text-color);font-size:0.85em;}
                .reminder-config .pending{padding:6px 10px;background:var(--card-background-color);border-radius:6px;margin:4px 0;font-size:0.85em;}
                .reminder-config .hint{font-size:0.8em;color:var(--secondary-text-color);margin-top:4px;}
              </style>

              {% set notifiers =
              state_attr('sensor.jottick_available_notifiers', 'notifiers') or
              [] %}

              {% set user_devices = state_attr('sensor.jottick_user_devices',
              'user_devices') or {} %}

              {% set aliases = state_attr('sensor.jottick_reminder_aliases',
              'aliases') or {} %}

              {% set schedules = state_attr('sensor.jottick_scheduled_notes',
              'schedules') or {} %}

              <div class="reminder-config">
                <h3>Assist Reminder Settings</h3>
                <p class="help">Say "Remind me to..." or "Remind [name] to..." and notifications go to the right phone!</p>
                <div class="section" id="user-section">
                  <div class="section-title">My Device (for "Remind Me")</div>
                  <select class="user-select">
                    <option value="">-- Select your HA user --</option>
                    {% for state in states.person %}
                      {% if state.attributes.user_id is defined and state.attributes.user_id %}
                    <option value="{{ state.attributes.user_id }}">{{ state.attributes.friendly_name | default(state.entity_id | replace('person.','')) }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <select class="device-select">
                    <option value="">-- Select device --</option>
                    {% for n in notifiers %}
                    <option value="{{ n }}">{{ n | replace('notify.mobile_app_','') | replace('_',' ') | title }}</option>
                    {% endfor %}
                  </select>
                  <button class="save-btn" type="button" onclick="(function(btn){var sec=btn.closest('.section');var u=sec.querySelector('.user-select');var d=sec.querySelector('.device-select');var cfg=btn.closest('.reminder-config');var s=cfg.querySelector('.status');if(!u.value){s.textContent='Select your user';return;}if(!d.value){s.textContent='Select your device';return;}var ha=document.querySelector('home-assistant');var uname=u.options[u.selectedIndex].text;ha.hass.callService('script','jottick_save_user_device',{user_id:u.value,user_name:uname,device:d.value});s.textContent='Saved! Refresh page to see changes.';btn.disabled=true;setTimeout(function(){btn.disabled=false;},2000);})(this);">Save My Device</button>
                  <div class="users-list">
                    {% if user_devices and user_devices | length > 0 %}
                      {% for uid, data in user_devices.items() %}
                    <div class="item">
                      <span>{{ data.name }} â†’ {{ data.device | replace('notify.mobile_app_','') | replace('_',' ') }}</span>
                      <button class="del" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_delete_user_device',{user_id:'{{ uid }}'});this.closest('.reminder-config').querySelector('.status').textContent='Deleted. Refresh page.';">Ã—</button>
                    </div>
                      {% endfor %}
                    {% else %}
                    <div class="empty">No users mapped yet</div>
                    {% endif %}
                  </div>
                </div>
                <div class="section" id="alias-section">
                  <div class="section-title">Name Aliases (for "Remind Mom/Tim/Dad")</div>
                  <input type="text" class="names-input" placeholder="Names separated by commas (e.g. tim, timmy, dad)">
                  <select class="device-select">
                    <option value="">-- Select device --</option>
                    {% for n in notifiers %}
                    <option value="{{ n }}">{{ n | replace('notify.mobile_app_','') | replace('_',' ') | title }}</option>
                    {% endfor %}
                  </select>
                  <button class="save-btn" type="button" onclick="(function(btn){var sec=btn.closest('.section');var n=sec.querySelector('.names-input');var d=sec.querySelector('.device-select');var cfg=btn.closest('.reminder-config');var s=cfg.querySelector('.status');if(!n.value.trim()){s.textContent='Enter at least one name';return;}if(!d.value){s.textContent='Select a device';return;}var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_save_alias_direct',{names:n.value,device:d.value});s.textContent='Saved! Say: remind '+n.value.split(',')[0].trim()+' to... Refresh to see.';n.value='';btn.disabled=true;setTimeout(function(){btn.disabled=false;},2000);})(this);">Save Alias</button>
                  <div class="aliases-list">
                    {% set alias_by_device = namespace(devices={}) %}
                    {% for name, dev in aliases.items() %}
                      {% if dev not in alias_by_device.devices %}
                        {% set alias_by_device.devices = dict(alias_by_device.devices, **{dev: [name]}) %}
                      {% else %}
                        {% set alias_by_device.devices = dict(alias_by_device.devices, **{dev: alias_by_device.devices[dev] + [name]}) %}
                      {% endif %}
                    {% endfor %}
                    {% if alias_by_device.devices | length > 0 %}
                      {% for dev, names in alias_by_device.devices.items() %}
                    <div class="item">
                      <span>{{ names | join(', ') }} â†’ {{ dev | replace('notify.mobile_app_','') | replace('_',' ') }}</span>
                      <button class="del" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_delete_alias_group',{device:'{{ dev }}'});this.closest('.reminder-config').querySelector('.status').textContent='Deleted. Refresh page.';">Ã—</button>
                    </div>
                      {% endfor %}
                    {% else %}
                    <div class="empty">No aliases yet</div>
                    {% endif %}
                  </div>
                </div>
                <div class="section">
                  <div class="section-title">Pending Assist Reminders</div>
                  <div class="pending-list">
                    {% set reminder_count = namespace(val=0) %}
                    {% for sched_id, sched in schedules.items() %}
                      {% if sched.auto_delete | default(false) %}
                        {% set reminder_count.val = reminder_count.val + 1 %}
                    <div class="pending">
                      â€¢ {{ sched.message }} @ {{ as_timestamp(sched.scheduled_time) | timestamp_custom('%b %d %I:%M %p') }}
                      <button style="margin-left:8px;padding:2px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_cancel_scheduled_note',{schedule_id:'{{ sched_id }}'});this.parentElement.remove();">Ã—</button>
                    </div>
                      {% endif %}
                    {% endfor %}
                    {% if reminder_count.val == 0 %}
                    <div class="empty">No pending reminders</div>
                    {% endif %}
                  </div>
                </div>
                <div class="status"></div>
              </div>
            grid_options:
              columns: full
              rows: auto
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .jt-mini-cal{padding:12px;font-family:var(--paper-font-body1_-_font-family);}
                .jt-mini-cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
                .jt-mini-cal-title{font-size:0.95em;font-weight:600;color:var(--primary-text-color);}
                .jt-mini-cal-nav{display:flex;gap:4px;}
                .jt-mini-cal-nav button{background:var(--secondary-background-color);border:1px solid var(--divider-color);color:var(--primary-text-color);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.85em;}
                .jt-mini-cal-nav button:hover{background:var(--divider-color);}
                .jt-mini-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;font-size:0.75em;}
                .jt-mini-cal-dow{text-align:center;padding:4px 2px;color:var(--secondary-text-color);font-weight:600;}
                .jt-mini-cal-day{text-align:center;padding:4px 2px;cursor:pointer;border-radius:4px;position:relative;}
                .jt-mini-cal-day:hover{background:var(--secondary-background-color);}
                .jt-mini-cal-day.other{color:var(--disabled-text-color);}
                .jt-mini-cal-day.today{background:color-mix(in srgb, var(--primary-color) 20%, transparent);font-weight:700;}
                .jt-mini-cal-day.has-events::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--primary-color);}
                .jt-mini-cal-events{margin-top:10px;border-top:1px solid var(--divider-color);padding-top:10px;max-height:150px;overflow-y:auto;}
                .jt-mini-cal-event{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:0.85em;cursor:pointer;}
                .jt-mini-cal-event:hover{color:var(--primary-color);}
                .jt-mini-cal-event-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
                .jt-mini-cal-event-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--primary-text-color);}
                .jt-mini-cal-empty{font-size:0.8em;color:var(--secondary-text-color);text-align:center;padding:8px;}
                .jt-mini-cal-link{display:block;text-align:center;margin-top:8px;font-size:0.8em;color:var(--primary-color);cursor:pointer;}
              </style>
              <div class="jt-mini-cal">
                <div class="jt-mini-cal-header">
                  {% set today = now().strftime('%Y-%m-%d') %}
                  {% set sel_date = states('input_datetime.jottick_calendar_selected_date') %}
                  {% set sel_date = sel_date if sel_date and sel_date != 'unknown' else today %}
                  {% set sel_dt = strptime(sel_date, '%Y-%m-%d') %}
                  <span class="jt-mini-cal-title">ðŸ“… {{ sel_dt.strftime('%b %Y') }}</span>
                  <div class="jt-mini-cal-nav">
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_previous_month');">â—€</button>
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_go_to_today');">â€¢</button>
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_next_month');">â–¶</button>
                  </div>
                </div>
                <div class="jt-mini-cal-grid">
                  {% set week_start = states('input_select.jottick_calendar_week_start') %}
                  {% if week_start == 'monday' %}
                    {% set dow_names = ['M','T','W','T','F','S','S'] %}
                  {% else %}
                    {% set dow_names = ['S','M','T','W','T','F','S'] %}
                  {% endif %}
                  {% for d in dow_names %}<div class="jt-mini-cal-dow">{{ d }}</div>{% endfor %}
                  
                  {% set year = sel_dt.year %}
                  {% set month = sel_dt.month %}
                  {% set first_of_month = sel_dt.replace(day=1) %}
                  {% set first_dow = first_of_month.weekday() %}
                  {% if week_start == 'sunday' %}{% set first_dow = (first_dow + 1) % 7 %}{% endif %}
                  {% set days_in_month = ((first_of_month.replace(month=month%12+1, day=1) if month < 12 else first_of_month.replace(year=year+1, month=1, day=1)) - timedelta(days=1)).day %}
                  {% set prev_month_end = first_of_month - timedelta(days=1) %}
                  {% set ns = namespace(events={}) %}
                  {% for state in states.sensor | selectattr('entity_id', 'match', 'sensor.jottick_note_') %}
                    {% set created = state_attr(state.entity_id, 'created') %}
                    {% set updated = state_attr(state.entity_id, 'updated') %}
                    {% if created %}
                      {% set cdate = created[:10] %}
                      {% set ns.events = dict(ns.events, **{cdate: (ns.events.get(cdate, []) + [{'type':'created','color':states('input_text.jottick_calendar_color_note_created'),'title':state.state,'id':state_attr(state.entity_id,'note_id')}])}) %}
                    {% endif %}
                    {% if updated and updated != created %}
                      {% set udate = updated[:10] %}
                      {% set ns.events = dict(ns.events, **{udate: (ns.events.get(udate, []) + [{'type':'edited','color':states('input_text.jottick_calendar_color_note_edited'),'title':state.state,'id':state_attr(state.entity_id,'note_id')}])}) %}
                    {% endif %}
                  {% endfor %}
                  {% for i in range(first_dow) %}
                    {% set day_num = prev_month_end.day - first_dow + i + 1 %}
                    <div class="jt-mini-cal-day other">{{ day_num }}</div>
                  {% endfor %}
                  {% for day in range(1, days_in_month + 1) %}
                    {% set day_date = '%04d-%02d-%02d' | format(year, month, day) %}
                    {% set is_today = day_date == today %}
                    {% set has_events = day_date in ns.events %}
                    <div class="jt-mini-cal-day{% if is_today %} today{% endif %}{% if has_events %} has-events{% endif %}" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:'{{ day_date }}'});">{{ day }}</div>
                  {% endfor %}
                  {% set total = first_dow + days_in_month %}
                  {% for i in range((7 - total % 7) % 7) %}
                    <div class="jt-mini-cal-day other">{{ i + 1 }}</div>
                  {% endfor %}
                </div>
                <div class="jt-mini-cal-events">
                  {% set day_events = ns.events.get(sel_date, []) %}
                  {% if day_events | length > 0 %}
                    {% for evt in day_events[:4] %}
                    <div class="jt-mini-cal-event" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_note_id',value:'{{ evt.id }}'});">
                      <div class="jt-mini-cal-event-dot" style="background:{{ evt.color }};"></div>
                      <span class="jt-mini-cal-event-text">{{ evt.title }}</span>
                    </div>
                    {% endfor %}
                    {% if day_events | length > 4 %}
                    <div class="jt-mini-cal-empty">+{{ day_events | length - 4 }} more</div>
                    {% endif %}
                  {% else %}
                    <div class="jt-mini-cal-empty">No note events</div>
                  {% endif %}
                </div>
               <div class="jt-mini-cal-link" onclick="history.pushState(null,'',window.location.pathname.split('/').slice(0,-1).join('/')+'/calendar');window.dispatchEvent(new CustomEvent('location-changed'));">View Full Calendar</div>
              </div>
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: >
              <style>
                @keyframes slideDown { from {top:40px;opacity:0;} to {top:60px;opacity:1;} }
                #jottick-loading {
                  display:none;
                  position:fixed;
                  top:60px;
                  left:50%;
                  transform:translateX(-50%);
                  z-index:9999;
                  background:var(--primary-color);
                  color:var(--text-primary-color, white);
                  padding:12px 24px;
                  border-radius:8px;
                  box-shadow:0 4px 12px rgba(0,0,0,0.3);
                  font-weight:600;
                  animation:slideDown 0.3s ease;
                }
                .notes-container { padding: 4px; }
                .note-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 16px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  transition: box-shadow 0.2s;
                }
                .note-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
                .note-title {
                  font-size: 1.4em;
                  font-weight: 600;
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  padding-bottom: 8px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .note-content {
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  white-space: inherit;
                  line-height: 1.6;
                  font-size: 1em;
                }
                .note-content.markdown { white-space: normal; }
                .note-content.markdown h1 { font-size: 1.6em; margin: 0.5em 0; border-bottom: 1px solid var(--divider-color); padding-bottom: 0.3em; }
                .note-content.markdown h2 { font-size: 1.4em; margin: 0.5em 0; }
                .note-content.markdown h3 { font-size: 1.2em; margin: 0.5em 0; }
                .note-content.markdown p { margin: 0.5em 0; }
                .note-content.markdown ul, .note-content.markdown ol { margin: 0.5em 0; padding-left: 1.5em; }
                .note-content.markdown li { margin: 0.25em 0; }
                .note-content.markdown code { background: var(--secondary-background-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
                .note-content.markdown pre { background: var(--secondary-background-color); padding: 12px; border-radius: 6px; overflow-x: auto; }
                .note-content.markdown pre code { background: none; padding: 0; }
                .note-content.markdown blockquote { border-left: 3px solid var(--primary-color); margin: 0.5em 0; padding-left: 1em; color: var(--secondary-text-color); }
                .note-content.markdown a { color: var(--primary-color); }
                .note-content.markdown strong { font-weight: 600; }
                .note-content.markdown em { font-style: italic; }
                .note-content.markdown hr { border: none; border-top: 1px solid var(--divider-color); margin: 1em 0; }
                .note-timestamp {
                  font-size: 0.85em;
                  color: var(--secondary-text-color);
                  font-style: italic;
                  text-align: right;
                }
                .note-image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; margin: 10px 0; }
                .note-image-thumb { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; cursor: pointer; background: var(--secondary-background-color); }
                .note-image-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .note-image-thumb:hover { opacity: 0.9; }
                .note-image-thumb .img-del { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; opacity: 0; transition: opacity 0.2s; line-height: 1; padding: 0; }
                .note-image-thumb:hover .img-del { opacity: 1; }
                .image-count { display: inline-block; padding: 1px 6px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 0.7em; margin-left: 6px; vertical-align: middle; }
                .format-badge { display: inline-block; padding: 1px 6px; background: var(--secondary-background-color); color: var(--secondary-text-color); border-radius: 8px; font-size: 0.65em; margin-left: 6px; vertical-align: middle; text-transform: uppercase; }
                .edit-images { margin: 10px 0; padding: 10px; background: var(--card-background-color); border-radius: 6px; }
                .edit-images h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .edit-upload-label { display: inline-block; padding: 6px 12px; background: var(--primary-color); color: white; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
                .edit-upload-label input { display: none; }
                .upload-status { font-size: 0.8em; color: var(--primary-color); margin-top: 6px; min-height: 16px; }
                .create-img-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
                .create-img-preview .preview-thumb { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; }
                .create-img-preview .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .create-img-preview .preview-thumb button { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; }
                .note-send-section, .note-edit-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: var(--secondary-background-color);
                  border: 1px solid var(--divider-color);
                  border-radius: 8px;
                  display: none;
                }
                .note-send-section.show, .note-edit-section.show { display: block; }
                .note-send-section h4, .note-edit-section h4 { margin: 0 0 12px 0; color: var(--primary-text-color); }
                .send-targets { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
                .send-targets label { display: flex; align-items: center; gap: 4px; font-size: 0.9em; cursor: pointer; }
                .send-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .send-mode-tabs { display: flex; gap: 0; margin-bottom: 12px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); }
                .send-mode-tab { flex: 1; padding: 8px 12px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
                .send-mode-tab.active { background: var(--primary-color); color: white; }
                .send-mode-tab:hover:not(.active) { background: var(--divider-color); }
                .schedule-picker { display: none; margin: 12px 0; padding: 12px; background: var(--card-background-color); border-radius: 6px; }
                .schedule-picker.show { display: block; }
                .schedule-picker label { display: block; font-size: 0.85em; color: var(--secondary-text-color); margin-bottom: 4px; }
                .schedule-picker input[type="datetime-local"] { width: 100%; padding: 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .send-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                .note-edit-section input[type="text"] { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section textarea { width: 100%; min-height: 120px; padding: 8px; border: 1px solid var(--divider-color); border-radius: 4px; resize: vertical; font-family: inherit; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section .edit-actions { display: flex; gap: 8px; margin-top: 8px; }
                .note-edit-section .edit-save-btn { padding: 8px 16px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .note-edit-section .edit-cancel-btn { padding: 8px 16px; background: var(--card-background-color); color: var(--primary-text-color); border: 1px solid var(--divider-color); border-radius: 4px; cursor: pointer; }
                .send-btn-wrapper { position: relative; display: inline-block; }
                .send-badge { position: absolute; top: -6px; right: -6px; background: var(--error-color, #dc2626); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
                .pending-schedules { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--divider-color); }
                .pending-schedules h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--card-background-color); border-radius: 6px; margin-bottom: 6px; font-size: 0.85em; }
                .pending-item-info { color: var(--primary-text-color); }
                .pending-item-time { color: var(--secondary-text-color); font-size: 0.9em; }
                .pending-cancel-btn { padding: 4px 10px; background: var(--error-color, #dc2626); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
                .format-toggle { display: flex; gap: 0; margin-bottom: 10px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); width: fit-content; }
                .format-toggle button { padding: 6px 14px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
                .format-toggle button.active { background: var(--primary-color); color: white; }
                .format-toggle button:hover:not(.active) { background: var(--divider-color); }
              </style>

              <div id="jottick-loading"
              style="display:none;position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:9999;background:var(--primary-color);color:var(--text-primary-color,
              white);padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px
              rgba(0,0,0,0.3);font-weight:600;">Loading...</div>

              <div class="notes-container">
                {% set ns = namespace(count=0, notes=[]) %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% set all_schedules = state_attr('sensor.jottick_scheduled_notes', 'schedules') or {} %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Note:') and state.state != 'unavailable' %}
                    {% set ns.notes = ns.notes + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.notes | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set note_id = state_attr(state.entity_id, 'note_id') %}
                    {% set raw_content = state_attr(state.entity_id, 'content') | default('') %}
                    {% set is_markdown = raw_content.startswith('<!--MD-->') %}
                    {% set is_encrypted = raw_content.startswith('<!--ENC:') %}
                    {% set edit_content = raw_content.replace('<!--MD-->', '') if is_markdown else raw_content %}
                    {% set display_content = edit_content %}
                    {% if is_markdown and not is_encrypted %}
                      {% set display_content = display_content | regex_replace('\\*\\*(.+?)\\*\\*', '<strong>\\1</strong>') %}
                      {% set display_content = display_content | regex_replace('(?<![*])\\*([^*]+)\\*(?![*])', '<em>\\1</em>') %}
                      {% set display_content = display_content | regex_replace('`([^`]+)`', '<code style="background:var(--secondary-background-color);padding:2px 6px;border-radius:4px;font-family:monospace;">\\1</code>') %}
                      {% set display_content = display_content | regex_replace('(?m)^### (.+)$', '<h3 style="font-size:1.2em;margin:0.5em 0;">\\1</h3>') %}
                      {% set display_content = display_content | regex_replace('(?m)^## (.+)$', '<h2 style="font-size:1.4em;margin:0.5em 0;">\\1</h2>') %}
                      {% set display_content = display_content | regex_replace('(?m)^# (.+)$', '<h1 style="font-size:1.6em;margin:0.5em 0;border-bottom:1px solid var(--divider-color);padding-bottom:0.3em;">\\1</h1>') %}
                      {% set display_content = display_content | regex_replace('(?m)^- (.+)$', '<li style="margin-left:1.5em;">\\1</li>') %}
                      {% set display_content = display_content | regex_replace('(?m)^> (.+)$', '<blockquote style="border-left:3px solid var(--primary-color);margin:0.5em 0;padding-left:1em;color:var(--secondary-text-color);">\\1</blockquote>') %}
                      {% set display_content = display_content | regex_replace('\\[([^\\]]+)\\]\\(([^)]+)\\)', '<a href="\\2" style="color:var(--primary-color);">\\1</a>') %}
                      {% set display_content = display_content | regex_replace('(?m)^---$', '<hr style="border:none;border-top:1px solid var(--divider-color);margin:1em 0;">') %}
                    {% endif %}
                    {% set images = state_attr(state.entity_id, 'images') or [] %}
                    {% set img_count = images | length %}
                    {% set note_schedules = namespace(items=[], count=0) %}
                    {% for sched_id, sched in all_schedules.items() %}
                      {% if sched.note_id == note_id %}
                        {% set note_schedules.items = note_schedules.items + [{'id': sched_id, 'time': sched.scheduled_time, 'targets': sched.targets}] %}
                        {% set note_schedules.count = note_schedules.count + 1 %}
                      {% endif %}
                    {% endfor %}
                    <div class="note-card" data-noteid="{{ note_id }}" data-format="{{ 'md' if is_markdown else 'html' }}" data-encrypted="{{ 'true' if is_encrypted else 'false' }}" data-raw="{{ raw_content | e }}">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div class="note-title" style="flex-grow:1; margin-bottom:0; padding-bottom:8px; border-bottom:none;">{{ state.state }}{% if img_count > 0 %}<span class="image-count">ðŸ“·{{ img_count }}</span>{% endif %}{% if is_markdown %}<span class="format-badge">MD</span>{% endif %}{% if is_encrypted %}<span class="format-badge" style="background:var(--warning-color,#f59e0b);">ðŸ”’</span>{% endif %}</div>
                        <div style="display:flex;gap:4px;">
                          {% if not is_encrypted %}
                          <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-edit-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-send-section');if(sec)sec.classList.remove('show');}})(this);" title="Edit note">Edit</button>
                          <div class="send-btn-wrapper">
                            <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-send-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-edit-section');if(sec)sec.classList.remove('show');}})(this);" title="Send to device">Send</button>
                            {% if note_schedules.count > 0 %}<span class="send-badge">{{ note_schedules.count }}</span>{% endif %}
                          </div>
                          {% endif %}
                          <button style="padding:4px 12px; background:var(--error-color, #ff5555); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="if(confirm('Delete {{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}?')){this.disabled=true; const el=document.querySelector('home-assistant'); if(el&&el.hass){el.hass.callService('script','jottick_delete_note_with_schedules',{note_id:'{{ note_id }}'});}}">Delete
                        </div>
                      </div>
                      {% if is_encrypted %}
                      <div class="note-locked" style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">ðŸ”’</div>
                        <div style="color:var(--secondary-text-color);margin-bottom:15px;">This note is encrypted</div>
                        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                          <input type="password" class="unlock-password" placeholder="Enter password" style="padding:8px 12px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);width:180px;">
                          <button class="unlock-btn" style="padding:8px 16px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;" onclick="(function(btn){var card=btn.closest('.note-card'),raw=card.dataset.raw,pwInput=card.querySelector('.unlock-password'),pw=pwInput.value,contentDiv=card.querySelector('.note-content'),lockedDiv=card.querySelector('.note-locked');if(!pw){alert('Enter password');return;}btn.disabled=true;btn.textContent='Decrypting...';try{var LT=String.fromCharCode(60),GT=String.fromCharCode(62),AMP=String.fromCharCode(38);var decoded=raw.split(AMP+'lt;').join(LT).split(AMP+'gt;').join(GT).split(AMP+'amp;').join(AMP).split(AMP+'quot;').join(String.fromCharCode(34));var encStart=LT+'!--ENC:';var idx=decoded.indexOf(encStart);if(idx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format');return;}var rest=decoded.substring(idx+encStart.length);var colonIdx=rest.indexOf(':');var dashIdx=rest.indexOf('--'+GT);if(colonIdx==-1||dashIdx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format 2');return;}var saltB64=rest.substring(0,colonIdx);var ivB64=rest.substring(colonIdx+1,dashIdx);var cipherB64=rest.substring(dashIdx+3);var b64d=function(s){return Uint8Array.from(atob(s),function(c){return c.charCodeAt(0);});};var salt=b64d(saltB64),iv=b64d(ivB64),ciphertext=b64d(cipherB64);var enc=new TextEncoder();crypto.subtle.importKey('raw',enc.encode(pw),'PBKDF2',false,['deriveBits','deriveKey']).then(function(km){return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['decrypt']);}).then(function(key){return crypto.subtle.decrypt({name:'AES-GCM',iv:iv},key,ciphertext);}).then(function(dec){var text=new TextDecoder().decode(dec);lockedDiv.style.display='none';contentDiv.style.display='block';contentDiv.textContent=text;btn.textContent='Unlock';btn.disabled=false;}).catch(function(e){btn.textContent='Unlock';btn.disabled=false;alert('Wrong password');});}catch(e){btn.textContent='Unlock';btn.disabled=false;alert('Error: '+e);}})(this);">Unlock</button>
                        </div>
                      </div>
                      <div class="note-content" style="display:none;"></div>
                      {% else %}
                      <div class="note-content">{{ display_content }}</div>
                      {% endif %}
                      {% if img_count > 0 %}
                      <div class="note-image-gallery">
                        {% for img in images %}
                        <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                          <img src="{{ img.url }}" loading="lazy" alt="">
                          <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='ðŸ“·'+(n-1);}}}else{alert(d.error||'Error');}});}">Ã—</button>
                        </div>
                        {% endfor %}
                      </div>
                      {% endif %}
                      <div class="note-timestamp">
                        Updated {{ relative_time(strptime(state_attr(state.entity_id, 'updated'), '%Y-%m-%dT%H:%M:%S.%fZ')) }} ago
                      </div>
                      <div class="note-send-section">
                        <h4>Send Note</h4>
                        <div class="send-targets">
                          {% for n in notifiers %}{% if n != 'Nobody' %}
                          <label><input type="checkbox" class="send-target-cb" value="{{ n }}"><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                          {% endif %}{% endfor %}
                        </div>
                        <div class="send-mode-tabs">
                          <button class="send-mode-tab active" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.remove('show');sec.querySelector('.send-now-btn').style.display='inline-block';sec.querySelector('.schedule-btn').style.display='none';})(this);">Send Now</button>
                          <button class="send-mode-tab" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.add('show');sec.querySelector('.send-now-btn').style.display='none';sec.querySelector('.schedule-btn').style.display='inline-block';var picker=sec.querySelector('.schedule-datetime');var now=new Date();now.setMinutes(now.getMinutes()+30);var y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0'),d=String(now.getDate()).padStart(2,'0'),h=String(now.getHours()).padStart(2,'0'),mi=String(now.getMinutes()).padStart(2,'0');picker.value=y+'-'+m+'-'+d+'T'+h+':'+mi;})(this);">Schedule</button>
                        </div>
                        <div class="schedule-picker">
                          <label>Send at:</label>
                          <input type="datetime-local" class="schedule-datetime">
                        </div>
                        <div class="send-actions">
                          <button class="send-btn send-now-btn" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}btn.disabled=true;btn.textContent='Sending...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_send_note_to_devices',{targets:targets.join(','),title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}'});}setTimeout(function(){btn.disabled=false;btn.textContent='Send Now';sec.classList.remove('show');},2000);})(this);">Send Now</button>
                          <button class="send-btn schedule-btn" style="display:none;background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}var dt=sec.querySelector('.schedule-datetime').value;if(!dt){alert('Please select a date and time');return;}var scheduled=new Date(dt);if(scheduled<=new Date()){alert('Please select a future time');return;}btn.disabled=true;btn.textContent='Scheduling...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_schedule_note',{note_id:'{{ note_id }}',title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}',targets:targets.join(','),scheduled_time:scheduled.toISOString()});}setTimeout(function(){btn.disabled=false;btn.textContent='Schedule';sec.classList.remove('show');},2000);})(this);">Schedule</button>
                        </div>
                        {% if note_schedules.count > 0 %}
                        <div class="pending-schedules">
                          <h5>ðŸ“… Pending Scheduled Sends</h5>
                          {% for sched in note_schedules.items %}
                          <div class="pending-item">
                            <div class="pending-item-info">
                              <div class="pending-item-time">â° {{ as_timestamp(sched.time) | timestamp_custom('%b %d at %I:%M %p') }}</div>
                              <div style="font-size:0.8em;color:var(--secondary-text-color);">ðŸ“± {{ sched.targets | replace('notify.mobile_app_', '') }}</div>
                            </div>
                            <button class="pending-cancel-btn" onclick="if(confirm('Cancel this scheduled send?')){this.disabled=true;this.textContent='...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_cancel_scheduled_note',{schedule_id:'{{ sched.id }}'});}}">Cancel</button>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}
                      </div>
                      <div class="note-edit-section">
                        <h4>Edit Note</h4>
                        <input type="text" class="edit-title" value="{{ state.state | e }}" placeholder="Title">
                        <div class="format-toggle">
                          <button class="format-btn {{ '' if is_markdown else 'active' }}" data-format="html" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">HTML</button>
                          <button class="format-btn {{ 'active' if is_markdown else '' }}" data-format="md" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Markdown</button>
                        </div>
                        <textarea class="edit-content" placeholder="Note content...">{{ edit_content | e }}</textarea>
                        <div class="edit-images">
                          <h5>Images</h5>
                          {% if img_count > 0 %}
                          <div class="note-image-gallery">
                            {% for img in images %}
                            <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                              <img src="{{ img.url }}" loading="lazy" alt="">
                              <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='ðŸ“·'+(n-1);}}}else{alert(d.error||'Error');}});}">Ã—</button>
                            </div>
                            {% endfor %}
                          </div>
                          {% endif %}
                          <label class="edit-upload-label">Add Image<input type="file" accept="image/*" onchange="var input=this,card=input.closest('.note-card'),editImages=input.closest('.edit-images'),status=editImages.querySelector('.upload-status'),maxBytes=15*1024*1024;if(input.files[0]){status.textContent='Processing...';var file=input.files[0];var doUpload=function(blob,fname){status.textContent='Uploading...';var fd=new FormData();fd.append('note_id','{{ note_id }}');fd.append('file',blob,fname);var token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd}).then(function(r){return r.json();}).then(function(d){if(d.success){status.textContent='Done!';var gallery=editImages.querySelector('.note-image-gallery');if(!gallery){gallery=document.createElement('div');gallery.className='note-image-gallery';editImages.insertBefore(gallery,editImages.querySelector('.edit-upload-label'));}var thumb=document.createElement('div');thumb.className='note-image-thumb';var timg=document.createElement('img');timg.src=d.image.url;timg.loading='lazy';thumb.appendChild(timg);thumb.onclick=function(){var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display='none';};document.body.appendChild(lb);}lb.querySelector('img').src=d.image.url;lb.style.display='flex';};gallery.appendChild(thumb);var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;badge.textContent='ðŸ“·'+(n+1);}else{badge=document.createElement('span');badge.className='image-count';badge.textContent='ðŸ“·1';card.querySelector('.note-title').appendChild(badge);}setTimeout(function(){status.textContent='';},1500);}else{status.textContent='Error:'+(d.error||'Unknown');}}).catch(function(e){status.textContent='Error';});};if(file.size<=maxBytes){doUpload(file,file.name);}else{var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.width,h=img.height,q=0.9,sc=1;var tryIt=function(){canvas.width=w*sc;canvas.height=h*sc;ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(blob){if(blob.size<=maxBytes||q<0.1){doUpload(blob,file.name.replace(/\.[^.]+$/,'.jpg'));}else{q-=0.1;if(q<0.5)sc*=0.8;tryIt();}},'image/jpeg',q);};tryIt();};img.src=e.target.result;};reader.readAsDataURL(file);}input.value='';}"></label>
                          <div class="upload-status"></div>
                        </div>
                        <div class="edit-actions">
                          <button class="edit-save-btn" onclick="(function(btn){var sec=btn.closest('.note-edit-section');var t=sec.querySelector('.edit-title').value;var c=sec.querySelector('.edit-content').value;var formatBtn=sec.querySelector('.format-btn.active');var isMd=formatBtn&&formatBtn.dataset.format==='md';if(!t.trim()){alert('Title is required');return;}if(isMd){c='<!--MD-->'+c;}else{c=c.replace(/^<!--MD-->/,'');}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('jottick','update_note',{note_id:'{{ note_id }}',title:t,content:c});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="edit-cancel-btn" onclick="this.closest('.note-edit-section').classList.remove('show');">Cancel</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .notes-container { padding: 4px; }
                .note-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 16px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  transition: box-shadow 0.2s;
                }
                .note-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
                .note-title {
                  font-size: 1.4em;
                  font-weight: 600;
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  padding-bottom: 8px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .note-content {
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  white-space: inherit;
                  line-height: 1.6;
                  font-size: 1em;
                }
                .note-content.markdown { white-space: normal; }
                .note-content.markdown h1 { font-size: 1.6em; margin: 0.5em 0; border-bottom: 1px solid var(--divider-color); padding-bottom: 0.3em; }
                .note-content.markdown h2 { font-size: 1.4em; margin: 0.5em 0; }
                .note-content.markdown h3 { font-size: 1.2em; margin: 0.5em 0; }
                .note-content.markdown p { margin: 0.5em 0; }
                .note-content.markdown ul, .note-content.markdown ol { margin: 0.5em 0; padding-left: 1.5em; }
                .note-content.markdown li { margin: 0.25em 0; }
                .note-content.markdown code { background: var(--secondary-background-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
                .note-content.markdown pre { background: var(--secondary-background-color); padding: 12px; border-radius: 6px; overflow-x: auto; }
                .note-content.markdown pre code { background: none; padding: 0; }
                .note-content.markdown blockquote { border-left: 3px solid var(--primary-color); margin: 0.5em 0; padding-left: 1em; color: var(--secondary-text-color); }
                .note-content.markdown a { color: var(--primary-color); }
                .note-content.markdown strong { font-weight: 600; }
                .note-content.markdown em { font-style: italic; }
                .note-content.markdown hr { border: none; border-top: 1px solid var(--divider-color); margin: 1em 0; }
                .note-timestamp {
                  font-size: 0.85em;
                  color: var(--secondary-text-color);
                  font-style: italic;
                  text-align: right;
                }
                .note-image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; margin: 10px 0; }
                .note-image-thumb { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; cursor: pointer; background: var(--secondary-background-color); }
                .note-image-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .note-image-thumb:hover { opacity: 0.9; }
                .note-image-thumb .img-del { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; opacity: 0; transition: opacity 0.2s; line-height: 1; padding: 0; }
                .note-image-thumb:hover .img-del { opacity: 1; }
                .image-count { display: inline-block; padding: 1px 6px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 0.7em; margin-left: 6px; vertical-align: middle; }
                .format-badge { display: inline-block; padding: 1px 6px; background: var(--secondary-background-color); color: var(--secondary-text-color); border-radius: 8px; font-size: 0.65em; margin-left: 6px; vertical-align: middle; text-transform: uppercase; }
                .edit-images { margin: 10px 0; padding: 10px; background: var(--card-background-color); border-radius: 6px; }
                .edit-images h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .edit-upload-label { display: inline-block; padding: 6px 12px; background: var(--primary-color); color: white; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
                .edit-upload-label input { display: none; }
                .upload-status { font-size: 0.8em; color: var(--primary-color); margin-top: 6px; min-height: 16px; }
                .create-img-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
                .create-img-preview .preview-thumb { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; }
                .create-img-preview .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .create-img-preview .preview-thumb button { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; }
                .note-send-section, .note-edit-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: var(--secondary-background-color);
                  border: 1px solid var(--divider-color);
                  border-radius: 8px;
                  display: none;
                }
                .note-send-section.show, .note-edit-section.show { display: block; }
                .note-send-section h4, .note-edit-section h4 { margin: 0 0 12px 0; color: var(--primary-text-color); }
                .send-targets { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
                .send-targets label { display: flex; align-items: center; gap: 4px; font-size: 0.9em; cursor: pointer; }
                .send-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .send-mode-tabs { display: flex; gap: 0; margin-bottom: 12px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); }
                .send-mode-tab { flex: 1; padding: 8px 12px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
                .send-mode-tab.active { background: var(--primary-color); color: white; }
                .send-mode-tab:hover:not(.active) { background: var(--divider-color); }
                .schedule-picker { display: none; margin: 12px 0; padding: 12px; background: var(--card-background-color); border-radius: 6px; }
                .schedule-picker.show { display: block; }
                .schedule-picker label { display: block; font-size: 0.85em; color: var(--secondary-text-color); margin-bottom: 4px; }
                .schedule-picker input[type="datetime-local"] { width: 100%; padding: 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .send-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                .note-edit-section input[type="text"] { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section textarea { width: 100%; min-height: 120px; padding: 8px; border: 1px solid var(--divider-color); border-radius: 4px; resize: vertical; font-family: inherit; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section .edit-actions { display: flex; gap: 8px; margin-top: 8px; }
                .note-edit-section .edit-save-btn { padding: 8px 16px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .note-edit-section .edit-cancel-btn { padding: 8px 16px; background: var(--card-background-color); color: var(--primary-text-color); border: 1px solid var(--divider-color); border-radius: 4px; cursor: pointer; }
                .send-btn-wrapper { position: relative; display: inline-block; }
                .send-badge { position: absolute; top: -6px; right: -6px; background: var(--error-color, #dc2626); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
                .pending-schedules { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--divider-color); }
                .pending-schedules h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--card-background-color); border-radius: 6px; margin-bottom: 6px; font-size: 0.85em; }
                .pending-item-info { color: var(--primary-text-color); }
                .pending-item-time { color: var(--secondary-text-color); font-size: 0.9em; }
                .pending-cancel-btn { padding: 4px 10px; background: var(--error-color, #dc2626); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
                .format-toggle { display: flex; gap: 0; margin-bottom: 10px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); width: fit-content; }
                .format-toggle button { padding: 6px 14px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
                .format-toggle button.active { background: var(--primary-color); color: white; }
                .format-toggle button:hover:not(.active) { background: var(--divider-color); }
              </style>
              <div class="notes-container">
                {% set ns = namespace(count=0, notes=[]) %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% set all_schedules = state_attr('sensor.jottick_scheduled_notes', 'schedules') or {} %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Note:') and state.state != 'unavailable' %}
                    {% set ns.notes = ns.notes + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.notes | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set note_id = state_attr(state.entity_id, 'note_id') %}
                    {% set raw_content = state_attr(state.entity_id, 'content') | default('') %}
                    {% set is_markdown = raw_content.startswith('<!--MD-->') %}
                    {% set is_encrypted = raw_content.startswith('<!--ENC:') %}
                    {% set edit_content = raw_content.replace('<!--MD-->', '') if is_markdown else raw_content %}
                    {% set display_content = edit_content %}
                    {% if is_markdown and not is_encrypted %}
                      {% set display_content = display_content | regex_replace('\\*\\*(.+?)\\*\\*', '<strong>\\1</strong>') %}
                      {% set display_content = display_content | regex_replace('(?<![*])\\*([^*]+)\\*(?![*])', '<em>\\1</em>') %}
                      {% set display_content = display_content | regex_replace('`([^`]+)`', '<code style="background:var(--secondary-background-color);padding:2px 6px;border-radius:4px;font-family:monospace;">\\1</code>') %}
                      {% set display_content = display_content | regex_replace('(?m)^### (.+)$', '<h3 style="font-size:1.2em;margin:0.5em 0;">\\1</h3>') %}
                      {% set display_content = display_content | regex_replace('(?m)^## (.+)$', '<h2 style="font-size:1.4em;margin:0.5em 0;">\\1</h2>') %}
                      {% set display_content = display_content | regex_replace('(?m)^# (.+)$', '<h1 style="font-size:1.6em;margin:0.5em 0;border-bottom:1px solid var(--divider-color);padding-bottom:0.3em;">\\1</h1>') %}
                      {% set display_content = display_content | regex_replace('(?m)^- (.+)$', '<li style="margin-left:1.5em;">\\1</li>') %}
                      {% set display_content = display_content | regex_replace('(?m)^> (.+)$', '<blockquote style="border-left:3px solid var(--primary-color);margin:0.5em 0;padding-left:1em;color:var(--secondary-text-color);">\\1</blockquote>') %}
                      {% set display_content = display_content | regex_replace('\\[([^\\]]+)\\]\\(([^)]+)\\)', '<a href="\\2" style="color:var(--primary-color);">\\1</a>') %}
                      {% set display_content = display_content | regex_replace('(?m)^---$', '<hr style="border:none;border-top:1px solid var(--divider-color);margin:1em 0;">') %}
                    {% endif %}
                    {% set images = state_attr(state.entity_id, 'images') or [] %}
                    {% set img_count = images | length %}
                    {% set note_schedules = namespace(items=[], count=0) %}
                    {% for sched_id, sched in all_schedules.items() %}
                      {% if sched.note_id == note_id %}
                        {% set note_schedules.items = note_schedules.items + [{'id': sched_id, 'time': sched.scheduled_time, 'targets': sched.targets}] %}
                        {% set note_schedules.count = note_schedules.count + 1 %}
                      {% endif %}
                    {% endfor %}
                    <div class="note-card" data-noteid="{{ note_id }}" data-format="{{ 'md' if is_markdown else 'html' }}" data-encrypted="{{ 'true' if is_encrypted else 'false' }}" data-raw="{{ raw_content | e }}">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div class="note-title" style="flex-grow:1; margin-bottom:0; padding-bottom:8px; border-bottom:none;">{{ state.state }}{% if img_count > 0 %}<span class="image-count">ðŸ“·{{ img_count }}</span>{% endif %}{% if is_markdown %}<span class="format-badge">MD</span>{% endif %}{% if is_encrypted %}<span class="format-badge" style="background:var(--warning-color,#f59e0b);">ðŸ”’</span>{% endif %}</div>
                        <div style="display:flex;gap:4px;">
                          {% if not is_encrypted %}
                          <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-edit-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-send-section');if(sec)sec.classList.remove('show');}})(this);" title="Edit note">Edit</button>
                          <div class="send-btn-wrapper">
                            <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-send-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-edit-section');if(sec)sec.classList.remove('show');}})(this);" title="Send to device">Send</button>
                            {% if note_schedules.count > 0 %}<span class="send-badge">{{ note_schedules.count }}</span>{% endif %}
                          </div>
                          {% endif %}
                          <button style="padding:4px 12px; background:var(--error-color, #ff5555); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="if(confirm('Delete {{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}?')){this.disabled=true; const el=document.querySelector('home-assistant'); if(el&&el.hass){el.hass.callService('script','jottick_delete_note_with_schedules',{note_id:'{{ note_id }}'});}}">Delete
                        </div>
                      </div>
                      {% if is_encrypted %}
                      <div class="note-locked" style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">ðŸ”’</div>
                        <div style="color:var(--secondary-text-color);margin-bottom:15px;">This note is encrypted</div>
                        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                          <input type="password" class="unlock-password" placeholder="Enter password" style="padding:8px 12px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);width:180px;">
                          <button class="unlock-btn" style="padding:8px 16px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;" onclick="(function(btn){var card=btn.closest('.note-card'),raw=card.dataset.raw,pwInput=card.querySelector('.unlock-password'),pw=pwInput.value,contentDiv=card.querySelector('.note-content'),lockedDiv=card.querySelector('.note-locked');if(!pw){alert('Enter password');return;}btn.disabled=true;btn.textContent='Decrypting...';try{var LT=String.fromCharCode(60),GT=String.fromCharCode(62),AMP=String.fromCharCode(38);var decoded=raw.split(AMP+'lt;').join(LT).split(AMP+'gt;').join(GT).split(AMP+'amp;').join(AMP).split(AMP+'quot;').join(String.fromCharCode(34));var encStart=LT+'!--ENC:';var idx=decoded.indexOf(encStart);if(idx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format');return;}var rest=decoded.substring(idx+encStart.length);var colonIdx=rest.indexOf(':');var dashIdx=rest.indexOf('--'+GT);if(colonIdx==-1||dashIdx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format 2');return;}var saltB64=rest.substring(0,colonIdx);var ivB64=rest.substring(colonIdx+1,dashIdx);var cipherB64=rest.substring(dashIdx+3);var b64d=function(s){return Uint8Array.from(atob(s),function(c){return c.charCodeAt(0);});};var salt=b64d(saltB64),iv=b64d(ivB64),ciphertext=b64d(cipherB64);var enc=new TextEncoder();crypto.subtle.importKey('raw',enc.encode(pw),'PBKDF2',false,['deriveBits','deriveKey']).then(function(km){return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['decrypt']);}).then(function(key){return crypto.subtle.decrypt({name:'AES-GCM',iv:iv},key,ciphertext);}).then(function(dec){var text=new TextDecoder().decode(dec);lockedDiv.style.display='none';contentDiv.style.display='block';contentDiv.textContent=text;btn.textContent='Unlock';btn.disabled=false;}).catch(function(e){btn.textContent='Unlock';btn.disabled=false;alert('Wrong password');});}catch(e){btn.textContent='Unlock';btn.disabled=false;alert('Error: '+e);}})(this);">Unlock</button>
                        </div>
                      </div>
                      <div class="note-content" style="display:none;"></div>
                      {% else %}
                      <div class="note-content">{{ display_content }}</div>
                      {% endif %}
                      {% if img_count > 0 %}
                      <div class="note-image-gallery">
                        {% for img in images %}
                        <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                          <img src="{{ img.url }}" loading="lazy" alt="">
                          <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='ðŸ“·'+(n-1);}}}else{alert(d.error||'Error');}});}">Ã—</button>
                        </div>
                        {% endfor %}
                      </div>
                      {% endif %}
                      <div class="note-timestamp">
                        Updated {{ relative_time(strptime(state_attr(state.entity_id, 'updated'), '%Y-%m-%dT%H:%M:%S.%fZ')) }} ago
                      </div>
                      <div class="note-send-section">
                        <h4>Send Note</h4>
                        <div class="send-targets">
                          {% for n in notifiers %}{% if n != 'Nobody' %}
                          <label><input type="checkbox" class="send-target-cb" value="{{ n }}"><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                          {% endif %}{% endfor %}
                        </div>
                        <div class="send-mode-tabs">
                          <button class="send-mode-tab active" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.remove('show');sec.querySelector('.send-now-btn').style.display='inline-block';sec.querySelector('.schedule-btn').style.display='none';})(this);">Send Now</button>
                          <button class="send-mode-tab" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.add('show');sec.querySelector('.send-now-btn').style.display='none';sec.querySelector('.schedule-btn').style.display='inline-block';var picker=sec.querySelector('.schedule-datetime');var now=new Date();now.setMinutes(now.getMinutes()+30);var y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0'),d=String(now.getDate()).padStart(2,'0'),h=String(now.getHours()).padStart(2,'0'),mi=String(now.getMinutes()).padStart(2,'0');picker.value=y+'-'+m+'-'+d+'T'+h+':'+mi;})(this);">Schedule</button>
                        </div>
                        <div class="schedule-picker">
                          <label>Send at:</label>
                          <input type="datetime-local" class="schedule-datetime">
                        </div>
                        <div class="send-actions">
                          <button class="send-btn send-now-btn" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}btn.disabled=true;btn.textContent='Sending...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_send_note_to_devices',{targets:targets.join(','),title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}'});}setTimeout(function(){btn.disabled=false;btn.textContent='Send Now';sec.classList.remove('show');},2000);})(this);">Send Now</button>
                          <button class="send-btn schedule-btn" style="display:none;background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}var dt=sec.querySelector('.schedule-datetime').value;if(!dt){alert('Please select a date and time');return;}var scheduled=new Date(dt);if(scheduled<=new Date()){alert('Please select a future time');return;}btn.disabled=true;btn.textContent='Scheduling...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_schedule_note',{note_id:'{{ note_id }}',title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}',targets:targets.join(','),scheduled_time:scheduled.toISOString()});}setTimeout(function(){btn.disabled=false;btn.textContent='Schedule';sec.classList.remove('show');},2000);})(this);">Schedule</button>
                        </div>
                        {% if note_schedules.count > 0 %}
                        <div class="pending-schedules">
                          <h5>ðŸ“… Pending Scheduled Sends</h5>
                          {% for sched in note_schedules.items %}
                          <div class="pending-item">
                            <div class="pending-item-info">
                              <div class="pending-item-time">â° {{ as_timestamp(sched.time) | timestamp_custom('%b %d at %I:%M %p') }}</div>
                              <div style="font-size:0.8em;color:var(--secondary-text-color);">ðŸ“± {{ sched.targets | replace('notify.mobile_app_', '') }}</div>
                            </div>
                            <button class="pending-cancel-btn" onclick="if(confirm('Cancel this scheduled send?')){this.disabled=true;this.textContent='...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_cancel_scheduled_note',{schedule_id:'{{ sched.id }}'});}}">Cancel</button>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}
                      </div>
                      <div class="note-edit-section">
                        <h4>Edit Note</h4>
                        <input type="text" class="edit-title" value="{{ state.state | e }}" placeholder="Title">
                        <div class="format-toggle">
                          <button class="format-btn {{ '' if is_markdown else 'active' }}" data-format="html" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">HTML</button>
                          <button class="format-btn {{ 'active' if is_markdown else '' }}" data-format="md" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Markdown</button>
                        </div>
                        <textarea class="edit-content" placeholder="Note content...">{{ edit_content | e }}</textarea>
                        <div class="edit-images">
                          <h5>Images</h5>
                          {% if img_count > 0 %}
                          <div class="note-image-gallery">
                            {% for img in images %}
                            <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                              <img src="{{ img.url }}" loading="lazy" alt="">
                              <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='ðŸ“·'+(n-1);}}}else{alert(d.error||'Error');}});}">Ã—</button>
                            </div>
                            {% endfor %}
                          </div>
                          {% endif %}
                          <label class="edit-upload-label">Add Image<input type="file" accept="image/*" onchange="var input=this,card=input.closest('.note-card'),editImages=input.closest('.edit-images'),status=editImages.querySelector('.upload-status'),maxBytes=15*1024*1024;if(input.files[0]){status.textContent='Processing...';var file=input.files[0];var doUpload=function(blob,fname){status.textContent='Uploading...';var fd=new FormData();fd.append('note_id','{{ note_id }}');fd.append('file',blob,fname);var token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd}).then(function(r){return r.json();}).then(function(d){if(d.success){status.textContent='Done!';var gallery=editImages.querySelector('.note-image-gallery');if(!gallery){gallery=document.createElement('div');gallery.className='note-image-gallery';editImages.insertBefore(gallery,editImages.querySelector('.edit-upload-label'));}var thumb=document.createElement('div');thumb.className='note-image-thumb';var timg=document.createElement('img');timg.src=d.image.url;timg.loading='lazy';thumb.appendChild(timg);thumb.onclick=function(){var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display='none';};document.body.appendChild(lb);}lb.querySelector('img').src=d.image.url;lb.style.display='flex';};gallery.appendChild(thumb);var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;badge.textContent='ðŸ“·'+(n+1);}else{badge=document.createElement('span');badge.className='image-count';badge.textContent='ðŸ“·1';card.querySelector('.note-title').appendChild(badge);}setTimeout(function(){status.textContent='';},1500);}else{status.textContent='Error: '+(d.error||'Unknown');}}).catch(function(e){status.textContent='Error';});};if(file.size<=maxBytes){doUpload(file,file.name);}else{var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.width,h=img.height,q=0.9,sc=1;var tryIt=function(){canvas.width=w*sc;canvas.height=h*sc;ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(blob){if(blob.size<=maxBytes||q<0.1){doUpload(blob,file.name.replace(/\.[^.]+$/,'.jpg'));}else{q-=0.1;if(q<0.5)sc*=0.8;tryIt();}},'image/jpeg',q);};tryIt();};img.src=e.target.result;};reader.readAsDataURL(file);}input.value='';}"></label>
                          <div class="upload-status"></div>
                        </div>
                        <div class="edit-actions">
                          <button class="edit-save-btn" onclick="(function(btn){var sec=btn.closest('.note-edit-section');var t=sec.querySelector('.edit-title').value;var c=sec.querySelector('.edit-content').value;var formatBtn=sec.querySelector('.format-btn.active');var isMd=formatBtn&&formatBtn.dataset.format==='md';if(!t.trim()){alert('Title is required');return;}if(isMd){c='<!--MD-->'+c;}else{c=c.replace(/^<!--MD-->/,'');}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('jottick','update_note',{note_id:'{{ note_id }}',title:t,content:c});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="edit-cancel-btn" onclick="this.closest('.note-edit-section').classList.remove('show');">Cancel</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
  - title: Lists
    path: lists
    icon: mdi:format-list-checks
    sections:
      - type: grid
        cards:
          - type: entities
            title: New List
            entities:
              - entity: input_text.jottick_checklist_title
                name: Title
            footer:
              type: buttons
              entities:
                - entity: script.jottick_create_checklist
                  name: Create
                  icon: mdi:plus-circle
            grid_options:
              columns: full
              rows: auto
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .jt-mini-cal{padding:12px;font-family:var(--paper-font-body1_-_font-family);}
                .jt-mini-cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
                .jt-mini-cal-title{font-size:0.95em;font-weight:600;color:var(--primary-text-color);}
                .jt-mini-cal-nav{display:flex;gap:4px;}
                .jt-mini-cal-nav button{background:var(--secondary-background-color);border:1px solid var(--divider-color);color:var(--primary-text-color);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.85em;}
                .jt-mini-cal-nav button:hover{background:var(--divider-color);}
                .jt-mini-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;font-size:0.75em;}
                .jt-mini-cal-dow{text-align:center;padding:4px 2px;color:var(--secondary-text-color);font-weight:600;}
                .jt-mini-cal-day{text-align:center;padding:4px 2px;cursor:pointer;border-radius:4px;position:relative;}
                .jt-mini-cal-day:hover{background:var(--secondary-background-color);}
                .jt-mini-cal-day.other{color:var(--disabled-text-color);}
                .jt-mini-cal-day.today{background:color-mix(in srgb, var(--primary-color) 20%, transparent);font-weight:700;}
                .jt-mini-cal-day.has-events::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--primary-color);}
                .jt-mini-cal-day.has-due::after{background:{{ states('input_text.jottick_calendar_color_list_due') }};}
                .jt-mini-cal-events{margin-top:10px;border-top:1px solid var(--divider-color);padding-top:10px;max-height:150px;overflow-y:auto;}
                .jt-mini-cal-event{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:0.85em;cursor:pointer;}
                .jt-mini-cal-event:hover{color:var(--primary-color);}
                .jt-mini-cal-event-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
                .jt-mini-cal-event-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--primary-text-color);}
                .jt-mini-cal-empty{font-size:0.8em;color:var(--secondary-text-color);text-align:center;padding:8px;}
                .jt-mini-cal-link{display:block;text-align:center;margin-top:8px;font-size:0.8em;color:var(--primary-color);cursor:pointer;}
              </style>
              <div class="jt-mini-cal">
                <div class="jt-mini-cal-header">
                  {% set today = now().strftime('%Y-%m-%d') %}
                  {% set sel_date = states('input_datetime.jottick_calendar_selected_date') %}
                  {% set sel_date = sel_date if sel_date and sel_date != 'unknown' else today %}
                  {% set sel_dt = strptime(sel_date, '%Y-%m-%d') %}
                  <span class="jt-mini-cal-title">ðŸ“… {{ sel_dt.strftime('%b %Y') }}</span>
                  <div class="jt-mini-cal-nav">
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_previous_month');">â—€</button>
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_go_to_today');">â€¢</button>
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_next_month');">â–¶</button>
                  </div>
                </div>
                <div class="jt-mini-cal-grid">
                  {% set week_start = states('input_select.jottick_calendar_week_start') %}
                  {% if week_start == 'monday' %}{% set dow_names = ['M','T','W','T','F','S','S'] %}{% else %}{% set dow_names = ['S','M','T','W','T','F','S'] %}{% endif %}
                  {% for d in dow_names %}<div class="jt-mini-cal-dow">{{ d }}</div>{% endfor %}
                  
                  {% set year = sel_dt.year %}
                  {% set month = sel_dt.month %}
                  {% set first_of_month = sel_dt.replace(day=1) %}
                  {% set first_dow = first_of_month.weekday() %}
                  {% if week_start == 'sunday' %}{% set first_dow = (first_dow + 1) % 7 %}{% endif %}
                  {% set days_in_month = ((first_of_month.replace(month=month%12+1, day=1) if month < 12 else first_of_month.replace(year=year+1, month=1, day=1)) - timedelta(days=1)).day %}
                  {% set prev_month_end = first_of_month - timedelta(days=1) %}
                  
                  {% set ns = namespace(events={}, due_dates={}) %}
                  {% for state in states.sensor | selectattr('entity_id', 'match', 'sensor.jottick_list_') %}
                    {% set created = state_attr(state.entity_id, 'created') %}
                    {% set updated = state_attr(state.entity_id, 'updated') %}
                    {% set due_items = state_attr(state.entity_id, 'due_items') or [] %}
                    {% set list_id = state_attr(state.entity_id, 'checklist_id') %}
                    {% set list_title = state_attr(state.entity_id, 'title') %}
                    {% if created %}
                      {% set cdate = created[:10] %}
                      {% set ns.events = dict(ns.events, **{cdate: (ns.events.get(cdate, []) + [{'type':'created','color':states('input_text.jottick_calendar_color_list_created'),'title':list_title,'id':list_id}])}) %}
                    {% endif %}
                    {% if updated and updated != created %}
                      {% set udate = updated[:10] %}
                      {% set ns.events = dict(ns.events, **{udate: (ns.events.get(udate, []) + [{'type':'edited','color':states('input_text.jottick_calendar_color_list_edited'),'title':list_title,'id':list_id}])}) %}
                    {% endif %}
                    {% for item in due_items %}
                      {% set ddate = item.get('dueDate', '') %}
                      {% set ns.events = dict(ns.events, **{ddate: (ns.events.get(ddate, []) + [{'type':'due','color':states('input_text.jottick_calendar_color_list_due'),'title':item.text,'id':list_id,'time':item.get('dueTime', '')}])}) %}
                      {% set ns.due_dates = dict(ns.due_dates, **{ddate: true}) %}
                    {% endfor %}
                  {% endfor %}
                  
                  {% for i in range(first_dow) %}
                    {% set day_num = prev_month_end.day - first_dow + i + 1 %}
                    <div class="jt-mini-cal-day other">{{ day_num }}</div>
                  {% endfor %}
                  
                  {% for day in range(1, days_in_month + 1) %}
                    {% set day_date = '%04d-%02d-%02d' | format(year, month, day) %}
                    {% set is_today = day_date == today %}
                    {% set has_events = day_date in ns.events %}
                    {% set has_due = day_date in ns.due_dates %}
                    <div class="jt-mini-cal-day{% if is_today %} today{% endif %}{% if has_events %} has-events{% endif %}{% if has_due %} has-due{% endif %}" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:'{{ day_date }}'});">{{ day }}</div>
                  {% endfor %}
                  
                  {% set total = first_dow + days_in_month %}
                  {% for i in range((7 - total % 7) % 7) %}
                    <div class="jt-mini-cal-day other">{{ i + 1 }}</div>
                  {% endfor %}
                </div>
                
                <div class="jt-mini-cal-events">
                  {% set day_events = ns.events.get(sel_date, []) %}
                  {% if day_events | length > 0 %}
                    {% for evt in day_events[:4] %}
                    <div class="jt-mini-cal-event" onclick="history.pushState(null,'',window.location.pathname.split('/').slice(0,2).join('/')+'/calendar');window.dispatchEvent(new CustomEvent('location-changed'));">
                      <div class="jt-mini-cal-event-dot" style="background:{{ evt.color }};"></div>
                      <span class="jt-mini-cal-event-text">{% if evt.type == 'due' %}{% endif %}{{ evt.title }}</span>
                    </div>
                    {% endfor %}
                    {% if day_events | length > 4 %}<div class="jt-mini-cal-empty">+{{ day_events | length - 4 }} more</div>{% endif %}
                  {% else %}
                    <div class="jt-mini-cal-empty">No list events</div>
                  {% endif %}
                </div>
                <div class="jt-mini-cal-link" onclick="history.pushState(null,'',window.location.pathname.split('/').slice(0,-1).join('/')+'/calendar');window.dispatchEvent(new CustomEvent('location-changed'));">View Full Calendar</div>
              </div>
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                @keyframes slideDown { from {top:40px;opacity:0;} to {top:60px;opacity:1;} }
                #jottick-loading-lists {
                  display:none;
                  position:fixed;
                  top:60px;
                  left:50%;
                  transform:translateX(-50%);
                  z-index:9999;
                  background:var(--success-color);
                  color:var(--text-primary-color, white);
                  padding:12px 24px;
                  border-radius:8px;
                  box-shadow:0 4px 12px rgba(0,0,0,0.3);
                  font-weight:600;
                  animation:slideDown 0.3s ease;
                }
                .lists-container { padding: 4px; }
                .list-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .list-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .list-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .list-progress {
                  font-size: 0.9em;
                  background:var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .list-items { margin-top: 12px; }
                .list-item {
                  display: flex;
                  align-items: center;
                  padding: 8px;
                  margin-bottom: 8px;
                  background: var(--secondary-background-color, var(--secondary-background-color));
                  border-radius: 8px;
                  gap: 12px;
                  transition: opacity 0.2s;
                }
                .list-item:hover { background: var(--divider-color, var(--divider-color)); }
                .item-checkbox { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; }
                .item-checkbox:disabled { cursor: wait; }
                .item-text { flex-grow: 1; color: var(--primary-text-color); font-size: 1em; }
                .item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .add-item-section {
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 1px solid var(--divider-color);
                  display: flex;
                  gap: 8px;
                }
                .add-item-input {
                  flex-grow: 1;
                  padding: 8px 12px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                  font-size: 1em;
                }
                              .due-date-wrapper {
                position: relative;
              }
              .due-popup {
                animation: fadeIn 0.2s ease;
              }
              @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-4px); }
                to { opacity: 1; transform: translateY(0); }
              }
              .due-badge:hover {
                opacity: 0.9;
              }
              .add-due-btn:hover {
                background: var(--primary-color) !important;
                color: white !important;
                border-color: var(--primary-color) !important;
              }
                .add-item-btn {
                  padding: 8px 16px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.9em;
                }
                .add-item-btn:hover { opacity: 0.9; }
                .add-item-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .delete-list-btn {
                  padding: 4px 12px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85em;
                }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                .reminder-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1)));
                  border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color, #ff5555); color: white; border: none; border-radius: 4px; cursor: pointer; }
              </style>
              <div id="jottick-loading-lists">Loading...</div>
              <script>
                (function checkLoading(){
                  var banner=document.getElementById('jottick-loading-lists');
                  if(banner){
                    var el=document.querySelector('home-assistant');
                    if(el&&el.hass&&el.hass.states['input_boolean.jottick_is_loading']){
                      var state=el.hass.states['input_boolean.jottick_is_loading'].state;
                      banner.style.display=state==='on'?'block':'none';
                    }
                  }
                  setTimeout(checkLoading,300);
                })();
              </script>
              <div class="lists-container">
                {% set ns = namespace(count=0, lists=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick List:') and state.state != 'unavailable' %}
                    {% set list_type = state_attr(state.entity_id, 'type') %}
                    {% if list_type != 'task' %}
                      {% set ns.lists = ns.lists + [state] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.lists | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set list_id = state_attr(state.entity_id, 'checklist_id') %}
                    {% set list_title = state_attr(state.entity_id, 'title') %}
                    {% set items = state_attr(state.entity_id, 'items') or [] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and list_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and list_id in recurring_configs %}
                    {% set config = reminder_configs.get(list_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(list_id, {}) if recurring_configs is mapping else {} %}
                    <div class="list-card">
                      <div class="list-header">
                        <div class="list-title">{{ list_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Recurring</button>
                          <div class="list-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                    <div class="list-items">
                    {% for item in items %}
                      <div class="list-item" style="flex-wrap:wrap;">
                        <input type="checkbox" class="item-checkbox" {{ 'checked' if item.completed else '' }} onchange="(function(cb){cb.disabled=true;cb.parentElement.style.opacity='0.5';const act=cb.checked?'check':'uncheck';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||{{ loop.index0 }}|||'+act});}setTimeout(function(){cb.disabled=false;cb.parentElement.style.opacity='1';},1000);})(this);">
                        <span class="item-text {{ 'completed' if item.completed else '' }}" style="flex:1;">{{ item.text }}</span>
                        <div class="due-date-wrapper" style="position:relative;display:inline-flex;align-items:center;gap:4px;">
                          {% if item.get('dueDate', '') %}
                            <span class="due-badge" style="font-size:0.75em;padding:2px 8px;background:{% if item.get('dueDate', '') < now().strftime('%Y-%m-%d') and not item.completed %}#EF4444{% else %}#10B981{% endif %};color:white;border-radius:4px;cursor:pointer;" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">
                              {{ item.get('dueDate', '') }}{% if item.get('dueTime', '') %} {{ item.get('dueTime', '') }}{% endif %}
                            </span>
                            <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                              <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Edit Due Date</div>
                              <input type="date" class="edit-due-date" value="{{ item.get('dueDate', '') }}" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                              <input type="time" class="edit-due-time" value="{{ item.get('dueTime', '') | default('') }}" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                              <div style="display:flex;gap:6px;">
                                <button style="flex:1;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'list|||{{ list_id }}|||{{ loop.index0 }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Save</button>
                                <button style="flex:1;padding:6px;background:var(--error-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){if(confirm('Remove due date?')){var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'list|||{{ list_id }}|||{{ loop.index0 }}|||clear'});}btn.closest('.due-popup').style.display='none';}})(this);">Clear</button>
                              </div>
                            </div>
                          {% else %}
                            <button class="add-due-btn" style="padding:2px 6px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.7em;color:var(--secondary-text-color);" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">+</button>
                            <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                              <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Set Due Date</div>
                              <input type="date" class="edit-due-date" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                              <input type="time" class="edit-due-time" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                              <button style="width:100%;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');if(!dateInp.value){alert('Please select a date');return;}var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'list|||{{ list_id }}|||{{ loop.index0 }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Set Due Date</button>
                            </div>
                          {% endif %}
                        </div>
                        
                        <button style="padding:2px 8px;background:var(--error-color, #ff5555);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="if(confirm('Delete this item?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_delete_item_data',value:'{{ list_id }}|||{{ loop.index0 }}'});}})(this);}">Delete</button>
                      </div>
                    {% endfor %}
                  </div>
                      <div class="add-item-section" style="flex-direction:column;">
                        <div style="display:flex;gap:8px;width:100%;flex-wrap:wrap;">
                          <input type="text" class="add-item-input" placeholder="Add new item..." style="flex:1;min-width:150px;">
                          <button class="add-item-btn" onclick="(function(btn){const sec=btn.closest('.add-item-section');const inp=sec.querySelector('.add-item-input');if(!inp.value.trim()){inp.placeholder='Type something first!';setTimeout(function(){inp.placeholder='Add new item...';},2000);return;}const txt=inp.value.trim();const dateInp=sec.querySelector('.add-item-date');const timeInp=sec.querySelector('.add-item-time');const dueDate=dateInp?dateInp.value:'';const dueTime=timeInp?timeInp.value:'';inp.value='';if(dateInp)dateInp.value='';if(timeInp)timeInp.value='';inp.placeholder='Adding...';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){var data='{{ list_id }}|||add|||'+txt;if(dueDate){data+='|||'+dueDate+'|||'+(dueTime||'');}el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:data});}setTimeout(function(){inp.placeholder='Add new item...';btn.disabled=false;},2000);})(this);">Add</button>
                          <button class="delete-list-btn" onclick="if(confirm('Delete {{ list_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||delete'});}})(this);}">Delete</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                          <span style="font-size:0.85em;color:var(--secondary-text-color);">Due:</span>
                          <input type="date" class="add-item-date" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <input type="time" class="add-item-time" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <button style="padding:4px 8px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.75em;color:var(--secondary-text-color);" onclick="(function(btn){var sec=btn.closest('.add-item-section');sec.querySelector('.add-item-date').value='';sec.querySelector('.add-item-time').value='';})(this);">âœ•</button>
                        </div>
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notifications</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ list_id }}',item_type:'checklist',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save Notification';sec.classList.remove('show');},1500);})(this);">Save Notification</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ list_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ list_id }}',item_type:'checklist',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ list_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .lists-container { padding: 4px; }
                .list-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .list-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .list-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .list-progress {
                  font-size: 0.9em;
                  background: var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .list-items { margin-top: 12px; }
                .list-item {
                  display: flex;
                  align-items: center;
                  padding: 8px;
                  margin-bottom: 8px;
                  background: var(--secondary-background-color, var(--secondary-background-color));
                  border-radius: 8px;
                  gap: 12px;
                  transition: opacity 0.2s;
                }
                .list-item:hover { background: var(--divider-color, var(--divider-color)); }
                .item-checkbox { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; }
                .item-checkbox:disabled { cursor: wait; }
                .item-text { flex-grow: 1; color: var(--primary-text-color); font-size: 1em; }
                .item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .add-item-section {
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 1px solid var(--divider-color);
                  display: flex;
                  gap: 8px;
                }
                .add-item-input {
                  flex-grow: 1;
                  padding: 8px 12px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                  font-size: 1em;
                }
                .add-item-btn {
                  padding: 8px 16px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.9em;
                }
                .add-item-btn:hover { opacity: 0.9; }
                .add-item-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .delete-list-btn {
                  padding: 4px 12px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85em;
                }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                .reminder-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1)));
                  border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color, #ff5555); color: white; border: none; border-radius: 4px; cursor: pointer; }
              </style>
              <div class="lists-container">
                {% set ns = namespace(count=0, lists=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick List:') and state.state != 'unavailable' %}
                    {% set list_type = state_attr(state.entity_id, 'type') %}
                    {% if list_type != 'task' %}
                      {% set ns.lists = ns.lists + [state] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.lists | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set list_id = state_attr(state.entity_id, 'checklist_id') %}
                    {% set list_title = state_attr(state.entity_id, 'title') %}
                    {% set items = state_attr(state.entity_id, 'items') or [] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and list_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and list_id in recurring_configs %}
                    {% set config = reminder_configs.get(list_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(list_id, {}) if recurring_configs is mapping else {} %}
                    <div class="list-card">
                      <div class="list-header">
                        <div class="list-title">{{ list_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Reset</button>
                          <div class="list-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                    <div class="list-items">
                      {% for item in items %}
                        <div class="list-item" style="flex-wrap:wrap;">
                          <input type="checkbox" class="item-checkbox" {{ 'checked' if item.completed else '' }} onchange="(function(cb){cb.disabled=true;cb.parentElement.style.opacity='0.5';const act=cb.checked?'check':'uncheck';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||{{ loop.index0 }}|||'+act});}setTimeout(function(){cb.disabled=false;cb.parentElement.style.opacity='1';},1000);})(this);">
                          <span class="item-text {{ 'completed' if item.completed else '' }}" style="flex:1;">{{ item.text }}</span>
                          <div class="due-date-wrapper" style="position:relative;display:inline-flex;align-items:center;gap:4px;">
                            {% if item.get('dueDate', '') %}
                              <span class="due-badge" style="font-size:0.75em;padding:2px 8px;background:{% if item.get('dueDate', '') < now().strftime('%Y-%m-%d') and not item.completed %}#EF4444{% else %}#10B981{% endif %};color:white;border-radius:4px;cursor:pointer;" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">
                                {{ item.get('dueDate', '') }}{% if item.get('dueTime', '') %} {{ item.get('dueTime', '') }}{% endif %}
                              </span>
                              <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                                <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Edit Due Date</div>
                                <input type="date" class="edit-due-date" value="{{ item.get('dueDate', '') }}" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                <input type="time" class="edit-due-time" value="{{ item.get('dueTime', '') | default('') }}" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                <div style="display:flex;gap:6px;">
                                  <button style="flex:1;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'list|||{{ list_id }}|||{{ loop.index0 }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Save</button>
                                  <button style="flex:1;padding:6px;background:var(--error-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){if(confirm('Remove due date?')){var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'list|||{{ list_id }}|||{{ loop.index0 }}|||clear'});}btn.closest('.due-popup').style.display='none';}})(this);">Clear</button>
                                </div>
                              </div>
                            {% else %}
                              <button class="add-due-btn" style="padding:2px 6px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.7em;color:var(--secondary-text-color);" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">+</button>
                              <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                                <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Set Due Date</div>
                                <input type="date" class="edit-due-date" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                <input type="time" class="edit-due-time" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                <button style="width:100%;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');if(!dateInp.value){alert('Please select a date');return;}var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'list|||{{ list_id }}|||{{ loop.index0 }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Set Due Date</button>
                              </div>
                            {% endif %}
                          </div>
                          
                          <button style="padding:2px 8px;background:var(--error-color, #ff5555);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="if(confirm('Delete this item?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_delete_item_data',value:'{{ list_id }}|||{{ loop.index0 }}'});}})(this);}">Delete</button>
                        </div>
                      {% endfor %}
                    </div>
                      <div class="add-item-section" style="flex-direction:column;">
                        <div style="display:flex;gap:8px;width:100%;flex-wrap:wrap;">
                          <input type="text" class="add-item-input" placeholder="Add new item..." style="flex:1;min-width:150px;">
                          <button class="add-item-btn" onclick="(function(btn){const sec=btn.closest('.add-item-section');const inp=sec.querySelector('.add-item-input');if(!inp.value.trim()){inp.placeholder='Type something first!';setTimeout(function(){inp.placeholder='Add new item...';},2000);return;}const txt=inp.value.trim();const dateInp=sec.querySelector('.add-item-date');const timeInp=sec.querySelector('.add-item-time');const dueDate=dateInp?dateInp.value:'';const dueTime=timeInp?timeInp.value:'';inp.value='';if(dateInp)dateInp.value='';if(timeInp)timeInp.value='';inp.placeholder='Adding...';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){var data='{{ list_id }}|||add|||'+txt;if(dueDate){data+='|||'+dueDate+'|||'+(dueTime||'');}el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:data});}setTimeout(function(){inp.placeholder='Add new item...';btn.disabled=false;},2000);})(this);">Add</button>
                          <button class="delete-list-btn" onclick="if(confirm('Delete {{ list_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||delete'});}})(this);}">Delete</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                          <span style="font-size:0.85em;color:var(--secondary-text-color);">ðŸ“… Due:</span>
                          <input type="date" class="add-item-date" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <input type="time" class="add-item-time" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <button style="padding:4px 8px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.75em;color:var(--secondary-text-color);" onclick="(function(btn){var sec=btn.closest('.add-item-section');sec.querySelector('.add-item-date').value='';sec.querySelector('.add-item-time').value='';})(this);">âœ•</button>
                        </div>
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notifications</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ list_id }}',item_type:'checklist',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ list_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ list_id }}',item_type:'checklist',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ list_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
  - title: Tasks
    path: tasks
    icon: mdi:clipboard-list
    sections:
      - type: grid
        cards:
          - type: entities
            title: New Task List
            entities:
              - entity: input_text.jottick_task_title
                name: Title
            footer:
              type: buttons
              entities:
                - entity: script.jottick_create_task
                  name: Create
                  icon: mdi:plus-circle
            grid_options:
              columns: full
              rows: auto
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .jt-mini-cal{padding:12px;font-family:var(--paper-font-body1_-_font-family);}
                .jt-mini-cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
                .jt-mini-cal-title{font-size:0.95em;font-weight:600;color:var(--primary-text-color);}
                .jt-mini-cal-nav{display:flex;gap:4px;}
                .jt-mini-cal-nav button{background:var(--secondary-background-color);border:1px solid var(--divider-color);color:var(--primary-text-color);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.85em;}
                .jt-mini-cal-nav button:hover{background:var(--divider-color);}
                .jt-mini-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;font-size:0.75em;}
                .jt-mini-cal-dow{text-align:center;padding:4px 2px;color:var(--secondary-text-color);font-weight:600;}
                .jt-mini-cal-day{text-align:center;padding:4px 2px;cursor:pointer;border-radius:4px;position:relative;}
                .jt-mini-cal-day:hover{background:var(--secondary-background-color);}
                .jt-mini-cal-day.other{color:var(--disabled-text-color);}
                .jt-mini-cal-day.today{background:color-mix(in srgb, var(--primary-color) 20%, transparent);font-weight:700;}
                .jt-mini-cal-day.has-events::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--primary-color);}
                .jt-mini-cal-day.has-due::after{background:{{ states('input_text.jottick_calendar_color_task_due') }};}
                .jt-mini-cal-day.has-overdue::after{background:{{ states('input_text.jottick_calendar_color_task_overdue') }};}
                .jt-mini-cal-events{margin-top:10px;border-top:1px solid var(--divider-color);padding-top:10px;max-height:150px;overflow-y:auto;}
                .jt-mini-cal-event{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:0.85em;cursor:pointer;}
                .jt-mini-cal-event:hover{color:var(--primary-color);}
                .jt-mini-cal-event-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
                .jt-mini-cal-event-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--primary-text-color);}
                .jt-mini-cal-empty{font-size:0.8em;color:var(--secondary-text-color);text-align:center;padding:8px;}
                .jt-mini-cal-link{display:block;text-align:center;margin-top:8px;font-size:0.8em;color:var(--primary-color);cursor:pointer;}
                .jt-mini-cal-overdue{background:color-mix(in srgb, {{ states('input_text.jottick_calendar_color_task_overdue') }} 15%, transparent);border:1px solid {{ states('input_text.jottick_calendar_color_task_overdue') }};border-radius:6px;padding:8px;margin-bottom:10px;font-size:0.85em;display:flex;align-items:center;gap:6px;}
              </style>
              <div class="jt-mini-cal">
                {% set overdue_count = states('sensor.jottick_overdue_items') | int(0) %}
                {% if overdue_count > 0 %}
                <div class="jt-mini-cal-overdue">âš ï¸ <span>{{ overdue_count }} overdue</span></div>
                {% endif %}
                <div class="jt-mini-cal-header">
                  {% set today = now().strftime('%Y-%m-%d') %}
                  {% set sel_date = states('input_datetime.jottick_calendar_selected_date') %}
                  {% set sel_date = sel_date if sel_date and sel_date != 'unknown' else today %}
                  {% set sel_dt = strptime(sel_date, '%Y-%m-%d') %}
                  <span class="jt-mini-cal-title">ðŸ“… {{ sel_dt.strftime('%b %Y') }}</span>
                  <div class="jt-mini-cal-nav">
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_previous_month');">â—€</button>
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_go_to_today');">â€¢</button>
                    <button onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_calendar_next_month');">â–¶</button>
                  </div>
                </div>
                <div class="jt-mini-cal-grid">
                  {% set week_start = states('input_select.jottick_calendar_week_start') %}
                  {% if week_start == 'monday' %}{% set dow_names = ['M','T','W','T','F','S','S'] %}{% else %}{% set dow_names = ['S','M','T','W','T','F','S'] %}{% endif %}
                  {% for d in dow_names %}<div class="jt-mini-cal-dow">{{ d }}</div>{% endfor %}
                  
                  {% set year = sel_dt.year %}
                  {% set month = sel_dt.month %}
                  {% set first_of_month = sel_dt.replace(day=1) %}
                  {% set first_dow = first_of_month.weekday() %}
                  {% if week_start == 'sunday' %}{% set first_dow = (first_dow + 1) % 7 %}{% endif %}
                  {% set days_in_month = ((first_of_month.replace(month=month%12+1, day=1) if month < 12 else first_of_month.replace(year=year+1, month=1, day=1)) - timedelta(days=1)).day %}
                  {% set prev_month_end = first_of_month - timedelta(days=1) %}
                  
                  {% set ns = namespace(events={}, due_dates={}, overdue_dates={}) %}
                  {% for state in states.sensor | selectattr('entity_id', 'match', 'sensor.jottick_task_') %}
                    {% set created = state_attr(state.entity_id, 'created') %}
                    {% set updated = state_attr(state.entity_id, 'updated') %}
                    {% set due_items = state_attr(state.entity_id, 'due_items') or [] %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% if created %}
                      {% set cdate = created[:10] %}
                      {% set ns.events = dict(ns.events, **{cdate: (ns.events.get(cdate, []) + [{'type':'created','color':states('input_text.jottick_calendar_color_task_due'),'title':task_title,'id':task_id}])}) %}
                    {% endif %}
                    {% if updated and updated != created %}
                      {% set udate = updated[:10] %}
                      {% set ns.events = dict(ns.events, **{udate: (ns.events.get(udate, []) + [{'type':'edited','color':states('input_text.jottick_calendar_color_task_due'),'title':task_title,'id':task_id}])}) %}
                    {% endif %}
                    {% for item in due_items %}
                      {% set ddate = item.get('dueDate', '') %}
                      {% set is_overdue = item.isOverdue | default(false) %}
                      {% set evt_color = states('input_text.jottick_calendar_color_task_overdue') if is_overdue else states('input_text.jottick_calendar_color_task_due') %}
                      {% set ns.events = dict(ns.events, **{ddate: (ns.events.get(ddate, []) + [{'type':'due','color':evt_color,'title':item.text,'id':task_id,'time':item.get('dueTime', ''),'overdue':is_overdue}])}) %}
                      {% if is_overdue %}
                        {% set ns.overdue_dates = dict(ns.overdue_dates, **{ddate: true}) %}
                      {% else %}
                        {% set ns.due_dates = dict(ns.due_dates, **{ddate: true}) %}
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                  
                  {% for i in range(first_dow) %}
                    {% set day_num = prev_month_end.day - first_dow + i + 1 %}
                    <div class="jt-mini-cal-day other">{{ day_num }}</div>
                  {% endfor %}
                  
                  {% for day in range(1, days_in_month + 1) %}
                    {% set day_date = '%04d-%02d-%02d' | format(year, month, day) %}
                    {% set is_today = day_date == today %}
                    {% set has_events = day_date in ns.events %}
                    {% set has_due = day_date in ns.due_dates %}
                    {% set has_overdue = day_date in ns.overdue_dates %}
                    <div class="jt-mini-cal-day{% if is_today %} today{% endif %}{% if has_events %} has-events{% endif %}{% if has_due %} has-due{% endif %}{% if has_overdue %} has-overdue{% endif %}" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:'{{ day_date }}'});">{{ day }}</div>
                  {% endfor %}
                  
                  {% set total = first_dow + days_in_month %}
                  {% for i in range((7 - total % 7) % 7) %}
                    <div class="jt-mini-cal-day other">{{ i + 1 }}</div>
                  {% endfor %}
                </div>
                
                <div class="jt-mini-cal-events">
                  {% set day_events = ns.events.get(sel_date, []) %}
                  {% if day_events | length > 0 %}
                    {% for evt in day_events[:4] %}
                    <div class="jt-mini-cal-event" onclick="history.pushState(null,'',window.location.pathname.split('/').slice(0,2).join('/')+'/calendar');window.dispatchEvent(new CustomEvent('location-changed'));">
                      <div class="jt-mini-cal-event-dot" style="background:{{ evt.color }};"></div>
                      <span class="jt-mini-cal-event-text">{% if evt.overdue %}{% elif evt.type == 'due' %}{% endif %}{{ evt.title }}</span>
                    </div>
                    {% endfor %}
                    {% if day_events | length > 4 %}<div class="jt-mini-cal-empty">+{{ day_events | length - 4 }} more</div>{% endif %}
                  {% else %}
                    <div class="jt-mini-cal-empty">No task events</div>
                  {% endif %}
                </div>
                <div class="jt-mini-cal-link" onclick="history.pushState(null,'',window.location.pathname.split('/').slice(0,-1).join('/')+'/calendar');window.dispatchEvent(new CustomEvent('location-changed'));">View Full Calendar</div>
              </div>
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                @keyframes slideDown { from {top:40px;opacity:0;} to {top:60px;opacity:1;} }
                #jottick-loading-tasks {
                  display:none;
                  position:fixed;
                  top:60px;
                  left:50%;
                  transform:translateX(-50%);
                  z-index:9999;
                  background:var(--primary-color);
                  color:var(--text-primary-color, white);
                  padding:12px 24px;
                  border-radius:8px;
                  box-shadow:0 4px 12px rgba(0,0,0,0.3);
                  font-weight:600;
                  animation:slideDown 0.3s ease;
                }
                .tasks-container { padding: 4px; }
                .task-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .task-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .task-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .task-progress {
                  font-size: 0.9em;
                  background: var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .task-items { margin-top: 12px; }
                .task-item {
                  display: flex;
                  align-items: center;
                  padding: 8px;
                  margin-bottom: 4px;
                  background: var(--secondary-background-color, var(--secondary-background-color));
                  border-radius: 8px;
                  gap: 8px;
                }
                .task-item:hover { background: var(--divider-color, var(--divider-color)); }
                .task-item.depth-0 { margin-left: 0; border-left: 3px solid var(--success-color); }
                .task-item.depth-1 { margin-left: 30px; border-left: 3px solid var(--primary-color); }
                .task-item.depth-2 { margin-left: 60px; border-left: 3px solid var(--warning-color); }
                .task-item.depth-3 { margin-left: 90px; border-left: 3px solid var(--info-color); }
                .task-item.depth-4 { margin-left: 120px; border-left: 3px solid var(--accent-color); }
                .task-item.depth-5 { margin-left: 150px; border-left: 3px solid var(--primary-color); }
                .task-item-text { flex-grow: 1; color: var(--primary-text-color); font-size: 1em; }
                .task-item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .task-status-select {
                  padding: 4px 8px;
                  border-radius: 4px;
                  border: 1px solid var(--divider-color);
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                  font-size: 0.85em;
                  cursor: pointer;
                }
                .delete-item-btn {
                  padding: 2px 8px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.8em;
                }
                .add-sub-btn {
                  padding: 2px 6px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.75em;
                }
                .add-task-section {
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 1px solid var(--divider-color);
                  display: flex;
                  gap: 8px;
                  flex-wrap: wrap;
                }
                .add-task-input {
                  flex-grow: 1;
                  min-width: 150px;
                  padding: 8px 12px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                }
                .add-task-btn {
                  padding: 8px 16px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                }
                .delete-task-btn {
                  padding: 4px 12px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                }
                .kanban-btn {
                  padding: 4px 12px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                }
                .status-todo { border-left: 3px solid var(--warning-color, #ff9800); }
                .status-in_progress { border-left: 3px solid var(--primary-color); }
                .status-completed { border-left: 3px solid var(--success-color); }
                .status-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: var(--secondary-background-color);
                  border-radius: 8px;
                  display: none;
                }
                .status-section.show { display: block; }
                .status-list { margin: 8px 0; }
                .status-item {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  padding: 6px;
                  background: var(--card-background-color);
                  border-radius: 4px;
                  margin-bottom: 4px;
                }
                .status-color {
                  width: 20px;
                  height: 20px;
                  border-radius: 4px;
                  flex-shrink: 0;
                }
                .status-name { flex-grow: 1; font-weight: 500; }
                .status-id { font-size: 0.8em; color: var(--secondary-text-color); }
                .new-status-form {
                  display: flex;
                  gap: 8px;
                  flex-wrap: wrap;
                  margin-top: 8px;
                  padding-top: 8px;
                  border-top: 1px solid var(--divider-color);
                }
                .new-status-form input {
                  padding: 6px 10px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                }
                .new-status-form input[type="color"] {
                  width: 40px;
                  padding: 2px;
                }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                .reminder-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1)));
                  border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"], .reminder-row input[type="text"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color, #ff5555); color: white; border: none; border-radius: 4px; cursor: pointer; }
              </style>
              <div id="jottick-loading-tasks">Loading...</div>
              <script>
                (function checkLoading(){
                  var banner=document.getElementById('jottick-loading-tasks');
                  if(banner){
                    var el=document.querySelector('home-assistant');
                    if(el&&el.hass&&el.hass.states['input_boolean.jottick_is_loading']){
                      banner.style.display=el.hass.states['input_boolean.jottick_is_loading'].state==='on'?'block':'none';
                    }
                  }
                  setTimeout(checkLoading,300);
                })();
              </script>
              <div class="tasks-container">
                {% set ns = namespace(count=0, tasks=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Task:') and state.state != 'unavailable' %}
                    {% set ns.tasks = ns.tasks + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.tasks | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% set flat_items = state_attr(state.entity_id, 'flat_items') or [] %}
                    {% set statuses = state_attr(state.entity_id, 'statuses') or [{'id':'todo','name':'To Do','order':0},{'id':'in_progress','name':'In Progress','order':1},{'id':'completed','name':'Completed','order':2}] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and task_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and task_id in recurring_configs %}
                    {% set config = reminder_configs.get(task_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(task_id, {}) if recurring_configs is mapping else {} %}
                    <div class="task-card">
                      <div class="task-header">
                        <div class="task-title">{{ task_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Recurring</button>
                          <div class="task-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      <div class="task-items">
                        {% for item in flat_items %}
                          {% set index_path = item.get('index_path') | default('0') %}
                          {% set depth = index_path.split('.') | length - 1 %}
                          <div class="task-item depth-{{ depth }} status-{{ item.status }}" style="flex-wrap:wrap;">
                            <span class="task-item-text {{ 'completed' if item.status == 'completed' else '' }}">{{ item.text }}</span>
                            <div class="due-date-wrapper" style="position:relative;display:inline-flex;align-items:center;gap:4px;">
                              {% if item.get('dueDate', '') %}
                                <span class="due-badge" style="font-size:0.7em;padding:2px 6px;background:{% if item.get('dueDate', '') < now().strftime('%Y-%m-%d') and item.status != 'completed' %}#EF4444{% else %}#F9E900{% endif %};color:{% if item.get('dueDate', '') < now().strftime('%Y-%m-%d') and item.status != 'completed' %}white{% else %}#000{% endif %};border-radius:4px;cursor:pointer;" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">
                                  {{ item.get('dueDate', '') }}{% if item.get('dueTime', '') %} {{ item.get('dueTime', '') }}{% endif %}
                                </span>
                                <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                                  <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Edit Due Date</div>
                                  <input type="date" class="edit-due-date" value="{{ item.get('dueDate', '') }}" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <input type="time" class="edit-due-time" value="{{ item.get('dueTime', '') | default('') }}" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <div style="display:flex;gap:6px;">
                                    <button style="flex:1;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'task|||{{ task_id }}|||{{ index_path }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Save</button>
                                    <button style="flex:1;padding:6px;background:var(--error-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){if(confirm('Remove due date?')){var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'task|||{{ task_id }}|||{{ index_path }}|||clear'});}btn.closest('.due-popup').style.display='none';}})(this);">Clear</button>
                                  </div>
                                </div>
                              {% else %}
                                <button class="add-due-btn" style="padding:2px 6px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.65em;color:var(--secondary-text-color);" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">+</button>
                                <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                                  <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Set Due Date</div>
                                  <input type="date" class="edit-due-date" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <input type="time" class="edit-due-time" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <button style="width:100%;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');if(!dateInp.value){alert('Please select a date');return;}var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'task|||{{ task_id }}|||{{ index_path }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Set Due Date</button>
                                </div>
                              {% endif %}
                            </div>     
                            <select class="task-status-select" onchange="(function(sel){sel.disabled=true;sel.parentElement.style.opacity='0.5';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||status|||'+sel.value});}setTimeout(function(){sel.disabled=false;sel.parentElement.style.opacity='1';},1000);})(this);">
                              {% for status in statuses | sort(attribute='order') %}
                                <option value="{{ status.id }}" {{ 'selected' if item.status == status.id else '' }}>{{ status.name }}</option>
                              {% endfor %}
                            </select>
                            <button class="add-sub-btn" title="Add sub-task" onclick="(function(btn){const txt=prompt('Enter sub-task:');if(txt&&txt.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt.trim()+'|||todo|||{{ index_path }}'});}}})(this);">+</button>
                            <button class="delete-item-btn" onclick="if(confirm('Delete?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||delete_item'});}}">Delete</button>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="add-task-section" style="flex-direction:column;">
                        <div style="display:flex;gap:8px;flex-wrap:wrap;width:100%;">
                          <input type="text" class="add-task-input" placeholder="Add new task..." style="flex:1;min-width:120px;">
                          <select class="task-status-select" style="min-width:100px;">
                            {% for status in statuses | sort(attribute='order') %}
                              <option value="{{ status.id }}">{{ status.name }}</option>
                            {% endfor %}
                          </select>
                          <button class="add-task-btn" onclick="(function(btn){const sec=btn.closest('.add-task-section');const inp=sec.querySelector('.add-task-input');const sel=sec.querySelector('.task-status-select');if(!inp.value.trim())return;const txt=inp.value.trim();const st=sel.value;const dateInp=sec.querySelector('.add-task-date');const timeInp=sec.querySelector('.add-task-time');const dueDate=dateInp?dateInp.value:'';const dueTime=timeInp?timeInp.value:'';inp.value='';if(dateInp)dateInp.value='';if(timeInp)timeInp.value='';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){var data='{{ task_id }}|||add|||'+txt+'|||'+st;if(dueDate){data+='||||||'+dueDate+'|||'+(dueTime||'');}el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:data});}setTimeout(function(){btn.disabled=false;},2000);})(this);">Add</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                          <span style="font-size:0.85em;color:var(--secondary-text-color);">Due:</span>
                          <input type="date" class="add-task-date" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <input type="time" class="add-task-time" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <button style="padding:4px 8px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.75em;color:var(--secondary-text-color);" onclick="(function(btn){var sec=btn.closest('.add-task-section');sec.querySelector('.add-task-date').value='';sec.querySelector('.add-task-time').value='';})(this);">âœ•</button>
                          <button class="kanban-btn" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.status-section');if(panel){panel.classList.toggle('show');}})(this);">Columns</button>
                          <button class="delete-task-btn" onclick="if(confirm('Delete {{ task_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||delete'});}}">Delete</button>
                        </div>
                      </div>
                      <div class="status-section">
                        <strong>Kanban Task Columns</strong>
                        <div class="status-list">
                          {% for status in statuses | sort(attribute='order') %}
                            <div class="status-item">
                              <div class="status-color" style="background:{{ status.color if status.color else 'var(--secondary-text-color)' }};"></div>
                              <span class="status-name">{{ status.name }}</span>
                              <span class="status-id">({{ status.id }})</span>
                              <button style="padding:2px 6px;background:var(--warning-color, #ff9800);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="(function(btn){const newLabel=prompt('New label:','{{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}');if(newLabel&&newLabel.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'update_status|||{{ task_id }}|||{{ status.id }}|||'+newLabel.trim()});}}})(this);">Edit</button>
                              {% if statuses | length > 1 %}
                              <button style="padding:2px 6px;background:var(--error-color);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="if(confirm('Delete {{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'delete_status|||{{ task_id }}|||{{ status.id }}'});}}">Delete
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        <div class="new-status-form">
                          <input type="text" placeholder="ID (e.g. review)" style="width:100px;" class="new-status-id">
                          <input type="text" placeholder="Label" style="width:120px;" class="new-status-label">
                          <input type="color" value="var(--info-color, #3b82f6)" class="new-status-color">
                          <button class="add-task-btn" style="padding:6px 12px;" onclick="(function(btn){const form=btn.closest('.new-status-form');const idInp=form.querySelector('.new-status-id');const labelInp=form.querySelector('.new-status-label');const colorInp=form.querySelector('.new-status-color');if(!idInp.value.trim()||!labelInp.value.trim()){alert('ID and Label required');return;}btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'create_status|||{{ task_id }}|||'+idInp.value.trim()+'|||'+labelInp.value.trim()+'|||'+colorInp.value});}idInp.value='';labelInp.value='';setTimeout(function(){btn.disabled=false;},2000);})(this);">Add Column</button>
                        </div>
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notifications</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ task_id }}',item_type:'task',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ task_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ task_id }}',item_type:'task',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ task_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .tasks-container { padding: 4px; }
                .task-card { background: var(--ha-card-background); border: 1px solid var(--divider-color); border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--primary-color); }
                .task-title { font-size: 1.4em; font-weight: 600; }
                .task-progress { font-size: 0.9em; background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 12px; }
                .task-items { margin-top: 12px; }
                .task-item { display: flex; align-items: center; padding: 8px; margin-bottom: 4px; background: var(--secondary-background-color); border-radius: 8px; gap: 8px; }
                .task-item:hover { background: var(--divider-color); }
                .task-item.depth-0 { margin-left: 0; border-left: 3px solid var(--success-color); }
                .task-item.depth-1 { margin-left: 30px; border-left: 3px solid var(--primary-color); }
                .task-item.depth-2 { margin-left: 60px; border-left: 3px solid var(--warning-color); }
                .task-item.depth-3 { margin-left: 90px; border-left: 3px solid var(--info-color); }
                .task-item.depth-4 { margin-left: 120px; border-left: 3px solid var(--accent-color); }
                .task-item.depth-5 { margin-left: 150px; border-left: 3px solid var(--primary-color); }
                .task-item-text { flex-grow: 1; }
                .task-item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .task-status-select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--divider-color); background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.85em; cursor: pointer; }
                .delete-item-btn { padding: 2px 8px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
                .add-sub-btn { padding: 2px 6px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
                .add-task-section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--divider-color); display: flex; gap: 8px; flex-wrap: wrap; }
                .add-task-input { flex-grow: 1; min-width: 150px; padding: 8px 12px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); }
                .add-task-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .delete-task-btn { padding: 4px 12px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .kanban-btn { padding: 4px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .status-todo { border-left: 3px solid var(--warning-color, #ff9800); }
                .status-in_progress { border-left: 3px solid var(--primary-color); }
                .status-completed { border-left: 3px solid var(--success-color); }
                .status-section { margin-top: 12px; padding: 12px; background: var(--secondary-background-color); border-radius: 8px; display: none; }
                .status-section.show { display: block; }
                .status-list { margin: 8px 0; }
                .status-item { display: flex; align-items: center; gap: 8px; padding: 6px; background: var(--card-background-color); border-radius: 4px; margin-bottom: 4px; }
                .status-color { width: 20px; height: 20px; border-radius: 4px; }
                .status-name { flex-grow: 1; font-weight: 500; }
                .status-id { font-size: 0.8em; color: var(--secondary-text-color); }
                .new-status-form { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--divider-color); }
                .new-status-form input { padding: 6px 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); }
                .new-status-form input[type="color"] { width: 40px; padding: 2px; }
                .reminder-section { margin-top: 12px; padding: 12px; background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1))); border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3)); border-radius: 8px; display: none; }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
              </style>
              <div class="tasks-container">
                {% set ns = namespace(count=0, tasks=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Task:') and state.state != 'unavailable' %}
                    {% set ns.tasks = ns.tasks + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.tasks | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% set flat_items = state_attr(state.entity_id, 'flat_items') or [] %}
                    {% set statuses = state_attr(state.entity_id, 'statuses') or [{'id':'todo','name':'To Do','order':0},{'id':'in_progress','name':'In Progress','order':1},{'id':'completed','name':'Completed','order':2}] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and task_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and task_id in recurring_configs %}
                    {% set config = reminder_configs.get(task_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(task_id, {}) if recurring_configs is mapping else {} %}
                    <div class="task-card">
                      <div class="task-header">
                        <div class="task-title">{{ task_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Reset</button>
                          <div class="task-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      <div class="task-items">
                        {% for item in flat_items %}
                          {% set index_path = item.get('index_path') | default('0') %}
                          {% set depth = index_path.split('.') | length - 1 %}
                          <div class="task-item depth-{{ depth }} status-{{ item.status }}" style="flex-wrap:wrap;">
                            <span class="task-item-text {{ 'completed' if item.status == 'completed' else '' }}">{{ item.text }}</span>
                            <div class="due-date-wrapper" style="position:relative;display:inline-flex;align-items:center;gap:4px;">
                              {% if item.get('dueDate', '') %}
                                <span class="due-badge" style="font-size:0.7em;padding:2px 6px;background:{% if item.get('dueDate', '') < now().strftime('%Y-%m-%d') and item.status != 'completed' %}#EF4444{% else %}#F9E900{% endif %};color:{% if item.get('dueDate', '') < now().strftime('%Y-%m-%d') and item.status != 'completed' %}white{% else %}#000{% endif %};border-radius:4px;cursor:pointer;" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">
                                  {{ item.get('dueDate', '') }}{% if item.get('dueTime', '') %} {{ item.get('dueTime', '') }}{% endif %}
                                </span>
                                <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                                  <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Edit Due Date</div>
                                  <input type="date" class="edit-due-date" value="{{ item.get('dueDate', '') }}" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <input type="time" class="edit-due-time" value="{{ item.get('dueTime', '') | default('') }}" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <div style="display:flex;gap:6px;">
                                    <button style="flex:1;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'task|||{{ task_id }}|||{{ index_path }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Save</button>
                                    <button style="flex:1;padding:6px;background:var(--error-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="(function(btn){if(confirm('Remove due date?')){var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'task|||{{ task_id }}|||{{ index_path }}|||clear'});}btn.closest('.due-popup').style.display='none';}})(this);">Clear</button>
                                  </div>
                                </div>
                              {% else %}
                                <button class="add-due-btn" style="padding:2px 6px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.65em;color:var(--secondary-text-color);" onclick="(function(el){var popup=el.nextElementSibling;popup.style.display=popup.style.display==='none'?'block':'none';})(this);">+</button>
                                <div class="due-popup" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);min-width:200px;">
                                  <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Set Due Date</div>
                                  <input type="date" class="edit-due-date" style="width:100%;padding:6px;margin-bottom:6px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <input type="time" class="edit-due-time" style="width:100%;padding:6px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--secondary-background-color);color:var(--primary-text-color);">
                                  <button style="width:100%;padding:6px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;" onclick="(function(btn){var popup=btn.closest('.due-popup');var dateInp=popup.querySelector('.edit-due-date');var timeInp=popup.querySelector('.edit-due-time');if(!dateInp.value){alert('Please select a date');return;}var ha=document.querySelector('home-assistant');if(ha&&ha.hass){ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_due_date_action_data',value:'task|||{{ task_id }}|||{{ index_path }}|||set|||'+dateInp.value+'|||'+timeInp.value});}popup.style.display='none';})(this);">Set Due Date</button>
                                </div>
                              {% endif %}
                            </div>
                            <select class="task-status-select" onchange="(function(sel){sel.disabled=true;sel.parentElement.style.opacity='0.5';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||status|||'+sel.value});}})(this);">
                              {% for status in statuses | sort(attribute='order') %}
                                <option value="{{ status.id }}" {{ 'selected' if item.status == status.id else '' }}>{{ status.name }}</option>
                              {% endfor %}
                            </select>
                            <button class="add-sub-btn" title="Add sub-task" onclick="(function(btn){const txt=prompt('Enter sub-task:');if(txt&&txt.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt.trim()+'|||todo|||{{ index_path }}'});}}})(this);">+</button>
                            <button class="delete-item-btn" onclick="if(confirm('Delete?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||delete_item'});}}">Delete</button>
                          </div>
                        {% endfor %}
                      </div>
                      <div class="add-task-section" style="flex-direction:column;">
                        <div style="display:flex;gap:8px;flex-wrap:wrap;width:100%;">
                          <input type="text" class="add-task-input" placeholder="Add new task..." style="flex:1;min-width:120px;">
                          <select class="task-status-select" style="min-width:100px;">
                            {% for status in statuses | sort(attribute='order') %}
                              <option value="{{ status.id }}">{{ status.name }}</option>
                            {% endfor %}
                          </select>
                          <button class="add-task-btn" onclick="(function(btn){const sec=btn.closest('.add-task-section');const inp=sec.querySelector('.add-task-input');const sel=sec.querySelector('.task-status-select');if(!inp.value.trim())return;const txt=inp.value.trim();const st=sel.value;const dateInp=sec.querySelector('.add-task-date');const timeInp=sec.querySelector('.add-task-time');const dueDate=dateInp?dateInp.value:'';const dueTime=timeInp?timeInp.value:'';inp.value='';if(dateInp)dateInp.value='';if(timeInp)timeInp.value='';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){var data='{{ task_id }}|||add|||'+txt+'|||'+st;if(dueDate){data+='||||||'+dueDate+'|||'+(dueTime||'');}el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:data});}setTimeout(function(){btn.disabled=false;},2000);})(this);">Add</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                          <span style="font-size:0.85em;color:var(--secondary-text-color);">Due:</span>
                          <input type="date" class="add-task-date" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <input type="time" class="add-task-time" style="padding:6px 8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.85em;">
                          <button style="padding:4px 8px;background:var(--secondary-background-color);border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;font-size:0.75em;color:var(--secondary-text-color);" onclick="(function(btn){var sec=btn.closest('.add-task-section');sec.querySelector('.add-task-date').value='';sec.querySelector('.add-task-time').value='';})(this);">âœ•</button>
                          <button class="kanban-btn" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.status-section');if(panel){panel.classList.toggle('show');}})(this);">Columns</button>
                          <button class="delete-task-btn" onclick="if(confirm('Delete {{ task_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||delete'});}}">Delete</button>
                        </div>
                      </div>
                      <div class="status-section">
                        <strong>Kanban Task Columns</strong>
                        <div class="status-list">
                          {% for status in statuses | sort(attribute='order') %}
                            <div class="status-item">
                              <div class="status-color" style="background:{{ status.color if status.color else 'var(--secondary-text-color)' }};"></div>
                              <span class="status-name">{{ status.name }}</span>
                              <span class="status-id">({{ status.id }})</span>
                              <button style="padding:2px 6px;background:var(--warning-color, #ff9800);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="(function(btn){const newLabel=prompt('New label:','{{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}');if(newLabel&&newLabel.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'update_status|||{{ task_id }}|||{{ status.id }}|||'+newLabel.trim()});}}})(this);">Edit</button>
                              {% if statuses | length > 1 %}
                              <button style="padding:2px 6px;background:var(--error-color);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="if(confirm('Delete {{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'delete_status|||{{ task_id }}|||{{ status.id }}'});}}">Delete
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        <div class="new-status-form">
                          <input type="text" placeholder="ID (e.g. review)" style="width:100px;" class="new-status-id">
                          <input type="text" placeholder="Label" style="width:120px;" class="new-status-label">
                          <input type="color" value="var(--info-color, #3b82f6)" class="new-status-color">
                          <button class="add-task-btn" style="padding:6px 12px;" onclick="(function(btn){const form=btn.closest('.new-status-form');const idInp=form.querySelector('.new-status-id');const labelInp=form.querySelector('.new-status-label');const colorInp=form.querySelector('.new-status-color');if(!idInp.value.trim()||!labelInp.value.trim()){alert('ID and Label required');return;}btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'create_status|||{{ task_id }}|||'+idInp.value.trim()+'|||'+labelInp.value.trim()+'|||'+colorInp.value});}idInp.value='';labelInp.value='';setTimeout(function(){btn.disabled=false;},2000);})(this);">Add Task Column</button>
                        </div>
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notification Settings</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ task_id }}',item_type:'task',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ task_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ task_id }}',item_type:'task',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ task_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
  - title: Kanban
    path: kanban
    icon: mdi:view-column
    sections:
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .kb-container { padding: 8px; }
                .kb-task-card {
                  background: var(--ha-card-background);
                  border: 1px solid var(--divider-color);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .kb-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 16px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .kb-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .kb-progress {
                  font-size: 0.9em;
                  background: var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .kb-layout-btn {
                  padding: 6px 12px;
                  background: var(--secondary-background-color);
                  border: 1px solid var(--divider-color);
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 0.85em;
                  color: var(--primary-text-color);
                  margin-right: 8px;
                }
                .kb-layout-btn:hover { background: var(--divider-color); }
                .kb-board {
                  display: flex;
                  gap: 12px;
                  overflow-x: auto;
                  padding-bottom: 8px;
                }
                .kb-board.vertical { flex-direction: column; }
                .kb-column {
                  min-width: 220px;
                  flex: 1;
                  background: var(--secondary-background-color);
                  border-radius: 10px;
                  padding: 10px;
                  display: flex;
                  flex-direction: column;
                }
                .kb-board.vertical .kb-column { min-width: auto; }
                .kb-col-header {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  padding: 8px;
                  margin-bottom: 8px;
                  border-radius: 6px;
                  font-weight: 600;
                  font-size: 0.95em;
                }
                .kb-col-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
                .kb-col-count { margin-left: auto; background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
                .kb-dropzone {
                  flex: 1;
                  min-height: 60px;
                  border: 2px dashed transparent;
                  border-radius: 6px;
                  padding: 6px;
                  transition: all 0.2s;
                  display: flex;
                  flex-direction: column;
                  gap: 6px;
                }
                .kb-dropzone.drag-over { background: rgba(var(--rgb-primary-color), 0.15); }
                .kb-card {
                  background: var(--card-background-color);
                  border-radius: 6px;
                  padding: 10px;
                  cursor: grab;
                  border-left: 4px solid;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
                }
                .kb-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
                .kb-card.dragging { opacity: 0.4; }
                .kb-card-text { font-size: 0.9em; color: var(--primary-text-color); word-break: break-word; }
                .kb-card-children { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--divider-color); font-size: 0.8em; color: var(--secondary-text-color); }
                .kb-child { display: flex; align-items: center; gap: 6px; padding: 4px 0; }
                .kb-child-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
                .kb-empty { text-align: center; padding: 16px 8px; color: var(--secondary-text-color); font-style: italic; font-size: 0.85em; }
                .kb-add-row { display: flex; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--divider-color); }
                .kb-add-row input { flex: 1; padding: 6px 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.85em; min-width: 0; }
                .kb-add-row button { padding: 6px 10px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; white-space: nowrap; }
                .kb-add-row button:disabled { opacity: 0.5; }
              </style>

              <div class="kb-container">
                {% set ns = namespace(tasks=[], count=0) %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Task:') and state.state != 'unavailable' %}
                    {% set ns.tasks = ns.tasks + [state] %}
                  {% endif %}
                {% endfor %}
                
                {% if ns.tasks | length == 0 %}
                  <div style="text-align:center;padding:40px;color:var(--secondary-text-color);">
                    No task lists found. Create one in the Tasks tab.
                  </div>
                {% endif %}
                
                {% for state in ns.tasks | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% set flat_items = state_attr(state.entity_id, 'flat_items') or [] %}
                    {% set statuses = state_attr(state.entity_id, 'statuses') or [{'id':'todo','label':'To Do','color':'#6b7280','order':0},{'id':'in_progress','label':'In Progress','color':'#3b82f6','order':1},{'id':'completed','label':'Completed','color':'#10b981','order':2}] %}
                    {% set completed = state_attr(state.entity_id, 'completed') | default(0) %}
                    {% set total = state_attr(state.entity_id, 'total') | default(0) %}
                    
                    <div class="kb-task-card" data-taskid="{{ task_id }}">
                      <div class="kb-header">
                        <div class="kb-title">{{ task_title }}</div>
                        <div style="display:flex;align-items:center;">
                          <button class="kb-layout-btn" onclick="(function(btn){var board=btn.closest('.kb-task-card').querySelector('.kb-board');board.classList.toggle('vertical');btn.textContent=board.classList.contains('vertical')?'â¬Œ Horizontal':'â¬ Vertical';})(this);">â¬Œ Horizontal</button>
                          <div class="kb-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      
                      <div class="kb-board vertical">
                        {% for status in statuses | sort(attribute='order') %}
                          {% set status_id = status.id %}
                          {% set status_label = status.label | default(status.name) | default(status.id) %}
                          {% set status_color = status.color | default('#6b7280') %}
                          {% set col_ns = namespace(items=[], count=0) %}
                          {% for item in flat_items %}
                            {% set idx = item.index_path | default('0') | string %}
                            {% if '.' not in idx and item.status == status_id %}
                              {% set col_ns.items = col_ns.items + [item] %}
                              {% set col_ns.count = col_ns.count + 1 %}
                            {% endif %}
                          {% endfor %}
                          
                          <div class="kb-column">
                            <div class="kb-col-header" style="background:{{ status_color }}33;color:{{ status_color }};">
                              <div class="kb-col-dot" style="background:{{ status_color }};"></div>
                              <span>{{ status_label }}</span>
                              <span class="kb-col-count">{{ col_ns.count }}</span>
                            </div>
                            
                            <div class="kb-dropzone" 
                                 data-taskid="{{ task_id }}" 
                                 data-status="{{ status_id }}"
                                 style="border-color:{{ status_color }}55;"
                                 ondragover="event.preventDefault();this.classList.add('drag-over');"
                                 ondragleave="this.classList.remove('drag-over');"
                                 ondrop="(function(zone,e){e.preventDefault();zone.classList.remove('drag-over');var data=e.dataTransfer.getData('text/plain');if(!data)return;var parts=data.split('|||');var taskId=parts[0];var itemIndex=parts[1];var newStatus=zone.dataset.status;if(taskId!==zone.dataset.taskid)return;var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:taskId+'|||'+itemIndex+'|||status|||'+newStatus});}})(this,event);">
                              
                              {% if col_ns.count == 0 %}
                                <div class="kb-empty">Drop here</div>
                              {% else %}
                                {% for item in col_ns.items %}
                                  {% set item_index = item.index_path | default('0') %}
                                  {% set child_ns = namespace(children=[]) %}
                                  {% for child in flat_items %}
                                    {% set child_idx = child.index_path | default('') | string %}
                                    {% if child_idx.startswith(item_index ~ '.') and child_idx.replace(item_index ~ '.', '').find('.') == -1 %}
                                      {% set child_ns.children = child_ns.children + [child] %}
                                    {% endif %}
                                  {% endfor %}
                                  
                                  <div class="kb-card" 
                                       draggable="true"
                                       style="border-left-color:{{ status_color }};"
                                       ondragstart="(function(card,e){card.classList.add('dragging');e.dataTransfer.setData('text/plain','{{ task_id }}|||{{ item_index }}');e.dataTransfer.effectAllowed='move';})(this,event);"
                                       ondragend="this.classList.remove('dragging');">
                                    <div class="kb-card-text">{{ item.text }}</div>
                                    {% if child_ns.children | length > 0 %}
                                      <div class="kb-card-children">
                                        {% for child in child_ns.children %}
                                          {% set child_color = '#6b7280' %}
                                          {% for s in statuses %}
                                            {% if s.id == child.status %}
                                              {% set child_color = s.color | default('#6b7280') %}
                                            {% endif %}
                                          {% endfor %}
                                          <div class="kb-child">
                                            <div class="kb-child-dot" style="background:{{ child_color }};"></div>
                                            <span>{{ child.text }}</span>
                                          </div>
                                        {% endfor %}
                                      </div>
                                    {% endif %}
                                  </div>
                                {% endfor %}
                              {% endif %}
                            </div>
                            
                            <div class="kb-add-row">
                              <input type="text" placeholder="New item...">
                              <button onclick="(function(btn){var inp=btn.previousElementSibling;if(!inp.value.trim())return;var txt=inp.value.trim();inp.value='';btn.disabled=true;btn.textContent='...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt+'|||{{ status_id }}'});}})(this);">Add</button>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .kb-container { padding: 8px; }
                .kb-task-card {
                  background: var(--ha-card-background);
                  border: 1px solid var(--divider-color);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .kb-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 16px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .kb-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .kb-progress {
                  font-size: 0.9em;
                  background: var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .kb-layout-btn {
                  padding: 6px 12px;
                  background: var(--secondary-background-color);
                  border: 1px solid var(--divider-color);
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 0.85em;
                  color: var(--primary-text-color);
                  margin-right: 8px;
                }
                .kb-layout-btn:hover { background: var(--divider-color); }
                .kb-board {
                  display: flex;
                  gap: 12px;
                  overflow-x: auto;
                  padding-bottom: 8px;
                }
                .kb-board.vertical { flex-direction: column; }
                .kb-column {
                  min-width: 220px;
                  flex: 1;
                  background: var(--secondary-background-color);
                  border-radius: 10px;
                  padding: 10px;
                  display: flex;
                  flex-direction: column;
                }
                .kb-board.vertical .kb-column { min-width: auto; }
                .kb-col-header {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  padding: 8px;
                  margin-bottom: 8px;
                  border-radius: 6px;
                  font-weight: 600;
                  font-size: 0.95em;
                }
                .kb-col-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
                .kb-col-count { margin-left: auto; background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
                .kb-dropzone {
                  flex: 1;
                  min-height: 60px;
                  border: 2px dashed transparent;
                  border-radius: 6px;
                  padding: 6px;
                  transition: all 0.2s;
                  display: flex;
                  flex-direction: column;
                  gap: 6px;
                }
                .kb-dropzone.drag-over { background: rgba(var(--rgb-primary-color), 0.15); }
                .kb-card {
                  background: var(--card-background-color);
                  border-radius: 6px;
                  padding: 10px;
                  cursor: grab;
                  border-left: 4px solid;
                  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
                }
                .kb-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
                .kb-card.dragging { opacity: 0.4; }
                .kb-card-text { font-size: 0.9em; color: var(--primary-text-color); word-break: break-word; }
                .kb-card-children { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--divider-color); font-size: 0.8em; color: var(--secondary-text-color); }
                .kb-child { display: flex; align-items: center; gap: 6px; padding: 4px 0; }
                .kb-child-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
                .kb-empty { text-align: center; padding: 16px 8px; color: var(--secondary-text-color); font-style: italic; font-size: 0.85em; }
                .kb-add-row { display: flex; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--divider-color); }
                .kb-add-row input { flex: 1; padding: 6px 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.85em; min-width: 0; }
                .kb-add-row button { padding: 6px 10px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; white-space: nowrap; }
                .kb-add-row button:disabled { opacity: 0.5; }
              </style>

              <div class="kb-container">
                {% set ns = namespace(tasks=[], count=0) %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Task:') and state.state != 'unavailable' %}
                    {% set ns.tasks = ns.tasks + [state] %}
                  {% endif %}
                {% endfor %}
                
                {% for state in ns.tasks | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% set flat_items = state_attr(state.entity_id, 'flat_items') or [] %}
                    {% set statuses = state_attr(state.entity_id, 'statuses') or [{'id':'todo','label':'To Do','color':'#6b7280','order':0},{'id':'in_progress','label':'In Progress','color':'#3b82f6','order':1},{'id':'completed','label':'Completed','color':'#10b981','order':2}] %}
                    {% set completed = state_attr(state.entity_id, 'completed') | default(0) %}
                    {% set total = state_attr(state.entity_id, 'total') | default(0) %}
                    
                    <div class="kb-task-card" data-taskid="{{ task_id }}">
                      <div class="kb-header">
                        <div class="kb-title">{{ task_title }}</div>
                        <div style="display:flex;align-items:center;">
                          <button class="kb-layout-btn" onclick="(function(btn){var board=btn.closest('.kb-task-card').querySelector('.kb-board');board.classList.toggle('vertical');btn.textContent=board.classList.contains('vertical')?'â¬Œ Horizontal':'â¬ Vertical';})(this);">â¬Œ Horizontal</button>
                          <div class="kb-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      
                      <div class="kb-board vertical">
                        {% for status in statuses | sort(attribute='order') %}
                          {% set status_id = status.id %}
                          {% set status_label = status.label | default(status.name) | default(status.id) %}
                          {% set status_color = status.color | default('#6b7280') %}
                          {% set col_ns = namespace(items=[], count=0) %}
                          {% for item in flat_items %}
                            {% set idx = item.index_path | default('0') | string %}
                            {% if '.' not in idx and item.status == status_id %}
                              {% set col_ns.items = col_ns.items + [item] %}
                              {% set col_ns.count = col_ns.count + 1 %}
                            {% endif %}
                          {% endfor %}
                          
                          <div class="kb-column">
                            <div class="kb-col-header" style="background:{{ status_color }}33;color:{{ status_color }};">
                              <div class="kb-col-dot" style="background:{{ status_color }};"></div>
                              <span>{{ status_label }}</span>
                              <span class="kb-col-count">{{ col_ns.count }}</span>
                            </div>
                            
                            <div class="kb-dropzone" 
                                 data-taskid="{{ task_id }}" 
                                 data-status="{{ status_id }}"
                                 style="border-color:{{ status_color }}55;"
                                 ondragover="event.preventDefault();this.classList.add('drag-over');"
                                 ondragleave="this.classList.remove('drag-over');"
                                 ondrop="(function(zone,e){e.preventDefault();zone.classList.remove('drag-over');var data=e.dataTransfer.getData('text/plain');if(!data)return;var parts=data.split('|||');var taskId=parts[0];var itemIndex=parts[1];var newStatus=zone.dataset.status;if(taskId!==zone.dataset.taskid)return;var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:taskId+'|||'+itemIndex+'|||status|||'+newStatus});}})(this,event);">
                              
                              {% if col_ns.count == 0 %}
                                <div class="kb-empty">Drop here</div>
                              {% else %}
                                {% for item in col_ns.items %}
                                  {% set item_index = item.index_path | default('0') %}
                                  {% set child_ns = namespace(children=[]) %}
                                  {% for child in flat_items %}
                                    {% set child_idx = child.index_path | default('') | string %}
                                    {% if child_idx.startswith(item_index ~ '.') and child_idx.replace(item_index ~ '.', '').find('.') == -1 %}
                                      {% set child_ns.children = child_ns.children + [child] %}
                                    {% endif %}
                                  {% endfor %}
                                  
                                  <div class="kb-card" 
                                       draggable="true"
                                       style="border-left-color:{{ status_color }};"
                                       ondragstart="(function(card,e){card.classList.add('dragging');e.dataTransfer.setData('text/plain','{{ task_id }}|||{{ item_index }}');e.dataTransfer.effectAllowed='move';})(this,event);"
                                       ondragend="this.classList.remove('dragging');">
                                    <div class="kb-card-text">{{ item.text }}</div>
                                    {% if child_ns.children | length > 0 %}
                                      <div class="kb-card-children">
                                        {% for child in child_ns.children %}
                                          {% set child_color = '#6b7280' %}
                                          {% for s in statuses %}
                                            {% if s.id == child.status %}
                                              {% set child_color = s.color | default('#6b7280') %}
                                            {% endif %}
                                          {% endfor %}
                                          <div class="kb-child">
                                            <div class="kb-child-dot" style="background:{{ child_color }};"></div>
                                            <span>{{ child.text }}</span>
                                          </div>
                                        {% endfor %}
                                      </div>
                                    {% endif %}
                                  </div>
                                {% endfor %}
                              {% endif %}
                            </div>
                            
                            <div class="kb-add-row">
                              <input type="text" placeholder="New item...">
                              <button onclick="(function(btn){var inp=btn.previousElementSibling;if(!inp.value.trim())return;var txt=inp.value.trim();inp.value='';btn.disabled=true;btn.textContent='...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt+'|||{{ status_id }}'});}})(this);">Add</button>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            grid_options:
              columns: full
              rows: auto
  - title: Quick
    path: quick
    icon: mdi:lightning-bolt
    cards:
      - type: markdown
        content: |
          # Quick Actions
          One-tap notes and lists!
      - type: button
        name: Refresh All Data
        icon: mdi:refresh
        tap_action:
          action: call-service
          service: script.jottick_refresh_dashboard_data
        show_state: false
      - type: grid
        columns: 2
        cards:
          - type: button
            name: Shopping List
            icon: mdi:cart
            tap_action:
              action: call-service
              service: jottick.create_checklist
              service_data:
                title: Shopping List
                type: simple
          - type: button
            name: To-Do Today
            icon: mdi:calendar-today
            tap_action:
              action: call-service
              service: jottick.create_task
              service_data:
                title: '{{ now().strftime(''%A'') }} Tasks'
          - type: button
            name: Quick Note
            icon: mdi:note-plus
            tap_action:
              action: call-service
              service: jottick.create_note
              service_data:
                title: 'Note: {{ now().strftime(''%H:%M'') }}'
                content: ''
          - type: button
            name: Reminder
            icon: mdi:bell
            tap_action:
              action: call-service
              service: jottick.create_note
              service_data:
                title: Reminder
                content: Don't forget to...
          - type: button
            name: Meal Plan
            icon: mdi:food
            tap_action:
              action: call-service
              service: jottick.create_note
              service_data:
                title: Meal Plan
                content: |-
                  Monday:
                  Tuesday:
                  Wednesday:
          - type: button
            name: Packing List
            icon: mdi:bag-checked
            tap_action:
              action: call-service
              service: jottick.create_checklist
              service_data:
                title: Packing List
                type: simple
          - type: button
            name: New Task List
            icon: mdi:clipboard-plus
            tap_action:
              action: call-service
              service: jottick.create_task
              service_data:
                title: Tasks {{ now().strftime('%m/%d') }}
          - type: button
            name: Update Dropdowns
            icon: mdi:sync
            tap_action:
              action: call-service
              service: script.jottick_update_both_dropdowns
          - type: button
            name: Force Refresh
            icon: mdi:database-refresh
            tap_action:
              action: call-service
              service: homeassistant.update_entity
              service_data:
                entity_id:
                  - sensor.jottick_total_notes
                  - sensor.jottick_total_checklists
                  - sensor.jottick_total_tasks
          - type: button
            name: Refresh Notifiers
            icon: mdi:bell-ring
            tap_action:
              action: call-service
              service: script.jottick_refresh_notifiers
  - title: Stats
    path: stats
    icon: mdi:chart-box
    cards:
      - type: markdown
        content: |
          # Family Stats
      - type: horizontal-stack
        cards:
          - type: statistic
            entity: sensor.jottick_total_notes
            name: Notes
            stat_type: mean
            period: 999
          - type: statistic
            entity: sensor.jottick_total_checklists
            name: Lists
            stat_type: mean
            period: 999
          - type: statistic
            entity: sensor.jottick_total_tasks
            name: Tasks
            stat_type: mean
            period: 999
          - type: statistic
            entity: sensor.jottick_completion_rate
            name: Done
            unit: '%'
            stat_type: mean
            period: 999
      - type: horizontal-stack
        cards:
          - type: statistic
            entity: sensor.jottick_total_items
            name: Items
            stat_type: mean
            period: 99
          - type: statistic
            entity: sensor.jottick_completed_items
            name: Done
            stat_type: mean
            period: 99
          - type: statistic
            entity: sensor.jottick_pending_items
            name: Pending
            stat_type: mean
            period: 99
      - type: entities
        title: Detailed Statistics
        entities:
          - entity: sensor.jottick_total_notes
            name: Total Notes
            icon: mdi:note-text
          - entity: sensor.jottick_total_checklists
            name: Total Lists
            icon: mdi:format-list-checks
          - entity: sensor.jottick_total_tasks
            name: Total Tasks
            icon: mdi:clipboard-list
          - entity: sensor.jottick_total_items
            name: Total Items
            icon: mdi:checkbox-multiple-marked
          - entity: sensor.jottick_completed_items
            name: Completed Items
            icon: mdi:check-all
          - entity: sensor.jottick_pending_items
            name: Pending Items
            icon: mdi:clock-outline
          - entity: sensor.jottick_completion_rate
            name: Completion Rate
            icon: mdi:percent
  - title: Calendar
    path: calendar
    icon: mdi:calendar-month
    sections:
      - type: grid
        cards:
          - type: conditional
            conditions:
              - entity: input_boolean.jottick_show_calendar_event_popup
                state: 'on'
            card:
              type: custom:html-template-card
              ignore_line_breaks: true
              content: >
                <style>
                  .jt-cal-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;display:flex;align-items:center;justify-content:center;padding:16px;box-sizing:border-box;}
                  .jt-cal-popup{background:var(--card-background-color);border-radius:12px;max-width:400px;width:100%;max-height:80vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3);}
                  .jt-cal-popup-header{padding:16px;border-bottom:1px solid var(--divider-color);display:flex;justify-content:space-between;align-items:center;}
                  .jt-cal-popup-header h3{margin:0;color:var(--primary-text-color);font-size:1.1em;}
                  .jt-cal-popup-close{background:none;border:none;font-size:1.5em;cursor:pointer;color:var(--secondary-text-color);padding:0;line-height:1;}
                  .jt-cal-popup-close:hover{color:var(--primary-text-color);}
                  .jt-cal-popup-body{padding:16px;}
                  .jt-cal-popup-type{display:inline-block;padding:4px 8px;border-radius:4px;font-size:0.75em;font-weight:600;margin-bottom:12px;text-transform:uppercase;}
                  .jt-cal-popup-title{font-size:1.2em;font-weight:600;color:var(--primary-text-color);margin-bottom:8px;}
                  .jt-cal-popup-meta{font-size:0.9em;color:var(--secondary-text-color);margin-bottom:16px;}
                  .jt-cal-popup-meta div{margin-bottom:4px;}
                  .jt-cal-popup-desc{font-size:0.9em;color:var(--primary-text-color);padding:12px;background:var(--secondary-background-color);border-radius:6px;margin-bottom:16px;}
                  .jt-cal-popup-actions{display:flex;gap:8px;}
                  .jt-cal-popup-actions button{flex:1;padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.95em;transition:opacity 0.2s;}
                  .jt-cal-popup-btn-goto{background:var(--primary-color);color:var(--text-primary-color,white);}
                  .jt-cal-popup-btn-close{background:var(--secondary-background-color);color:var(--primary-text-color);border:1px solid var(--divider-color)!important;}
                  .jt-cal-popup-actions button:hover{opacity:0.9;}
                </style>

                <div class="jt-cal-popup-overlay"
                onclick="if(event.target===this){var
                ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean','turn_off',{entity_id:'input_boolean.jottick_show_calendar_event_popup'});}">
                  <div class="jt-cal-popup">
                    <div class="jt-cal-popup-header">
                      <h3>ðŸ“… Event Details</h3>
                      <button class="jt-cal-popup-close" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean','turn_off',{entity_id:'input_boolean.jottick_show_calendar_event_popup'});">Ã—</button>
                    </div>
                    <div class="jt-cal-popup-body" id="jt-cal-popup-content">
                      <script>
                        (function(){
                          var dataStr = '{{ states("input_text.jottick_calendar_popup_event_data") }}';
                          var container = document.getElementById('jt-cal-popup-content');
                          if(!dataStr || dataStr === '' || dataStr === 'unknown'){
                            container.innerHTML = '<p style="color:var(--secondary-text-color);">No event data</p>';
                            return;
                          }
                          try {
                            var evt = JSON.parse(dataStr.replace(/&quot;/g,'"').replace(/&#39;/g,"'"));
                            var typeColors = {
                              'note_created': 'background:#9CCAEB;color:#fff;',
                              'note_edited': 'background:#6BA5D4;color:#fff;',
                              'note_reminder': 'background:#F7A700;color:#000;',
                              'list_created': 'background:#99C66D;color:#fff;',
                              'list_edited': 'background:#7AAD52;color:#fff;',
                              'list_due': 'background:#10B981;color:#fff;',
                              'task_due': 'background:#F9E900;color:#000;',
                              'task_overdue': 'background:#EF4444;color:#fff;',
                              'imported': 'background:#A855F7;color:#fff;'
                            };
                            var typeLabels = {
                              'note_created': 'Note Created', 'note_edited': 'Note Edited', 'note_reminder': 'Reminder',
                              'list_created': 'List Created', 'list_edited': 'List Edited', 'list_due': 'List Due',
                              'task_due': 'Task Due', 'task_overdue': 'Overdue', 'imported': 'Imported'
                            };
                            var typeStyle = typeColors[evt.type] || 'background:var(--primary-color);color:#fff;';
                            var typeLabel = typeLabels[evt.type] || evt.type;
                            var html = '<div class="jt-cal-popup-type" style="'+typeStyle+'">'+typeLabel+'</div>';
                            html += '<div class="jt-cal-popup-title">'+(evt.title||'Untitled')+'</div>';
                            html += '<div class="jt-cal-popup-meta"><div>ðŸ“† '+(evt.date||'No date')+(evt.time?' at '+evt.time:'')+'</div>';
                            if(evt.parent_title) html += '<div>ðŸ“ '+evt.parent_title+'</div>';
                            html += '</div>';
                            if(evt.description) html += '<div class="jt-cal-popup-desc">'+evt.description+'</div>';
                            html += '<div class="jt-cal-popup-actions">';
                            html += '<button class="jt-cal-popup-btn-close" onclick="var ha=document.querySelector(\'home-assistant\');ha.hass.callService(\'input_boolean\',\'turn_off\',{entity_id:\'input_boolean.jottick_show_calendar_event_popup\'});">Close</button>';
                            html += '</div>';
                            container.innerHTML = html;
                          } catch(e) {
                            container.innerHTML = '<p style="color:var(--error-color);">Error: '+e.message+'</p>';
                          }
                        })();
                      </script>
                    </div>
                  </div>
                </div>
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .jt-cal-container{padding:16px;font-family:var(--paper-font-body1_-_font-family);}
                .jt-cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;}
                .jt-cal-nav{display:flex;align-items:center;gap:8px;}
                .jt-cal-nav-btn{background:var(--secondary-background-color);border:1px solid var(--divider-color);color:var(--primary-text-color);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:1em;}
                .jt-cal-nav-btn:hover{background:var(--divider-color);}
                .jt-cal-title{font-size:1.3em;font-weight:600;color:var(--primary-text-color);min-width:180px;text-align:center;}
                .jt-cal-actions{display:flex;gap:8px;flex-wrap:wrap;}
                .jt-cal-today-btn{background:var(--primary-color);color:var(--text-primary-color,white);border:none;padding:8px 16px;border-radius:6px;cursor:pointer;}
                .jt-cal-settings-btn{background:var(--secondary-background-color);border:1px solid var(--divider-color);color:var(--primary-text-color);padding:8px;border-radius:6px;cursor:pointer;font-size:1.1em;}
                .jt-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:var(--divider-color);border:1px solid var(--divider-color);border-radius:8px;overflow:hidden;}
                .jt-cal-dow{background:var(--secondary-background-color);padding:8px 4px;text-align:center;font-size:0.75em;font-weight:600;color:var(--secondary-text-color);text-transform:uppercase;}
                .jt-cal-day{background:var(--card-background-color);min-height:80px;padding:4px;cursor:pointer;position:relative;transition:background 0.2s;}
                .jt-cal-day:hover{background:var(--secondary-background-color);}
                .jt-cal-day.other{opacity:0.4;}
                .jt-cal-day.today{background:color-mix(in srgb, var(--primary-color) 15%, var(--card-background-color));}
                .jt-cal-day.selected{box-shadow:inset 0 0 0 2px var(--primary-color);}
                .jt-cal-day-num{font-size:0.9em;font-weight:500;color:var(--primary-text-color);margin-bottom:4px;}
                .jt-cal-day.today .jt-cal-day-num{color:var(--primary-color);font-weight:700;}
                .jt-cal-dots{display:flex;flex-wrap:wrap;gap:2px;}
                .jt-cal-dot{width:6px;height:6px;border-radius:50%;}
                .jt-cal-events-panel{margin-top:16px;background:var(--card-background-color);border:1px solid var(--divider-color);border-radius:8px;overflow:hidden;}
                .jt-cal-events-header{padding:12px 16px;background:var(--secondary-background-color);border-bottom:1px solid var(--divider-color);font-weight:600;color:var(--primary-text-color);}
                .jt-cal-events-list{max-height:300px;overflow-y:auto;}
                .jt-cal-event{padding:10px 16px;border-bottom:1px solid var(--divider-color);cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.2s;}
                .jt-cal-event:hover{background:var(--secondary-background-color);}
                .jt-cal-event:last-child{border-bottom:none;}
                .jt-cal-event-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
                .jt-cal-event-info{flex:1;min-width:0;}
                .jt-cal-event-title{font-size:0.9em;color:var(--primary-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
                .jt-cal-event-meta{font-size:0.75em;color:var(--secondary-text-color);}
                .jt-cal-empty{padding:20px;text-align:center;color:var(--secondary-text-color);font-size:0.9em;}
                .jt-cal-overdue-banner{background:color-mix(in srgb, #EF4444 15%, var(--card-background-color));border:1px solid #EF4444;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
                .jt-cal-overdue-icon{font-size:1.5em;}
                .jt-cal-overdue-text{flex:1;}
                .jt-cal-overdue-count{font-weight:700;color:#EF4444;}
                .jt-cal-settings-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;box-sizing:border-box;}
                .jt-cal-settings{background:var(--card-background-color);border-radius:12px;max-width:500px;width:100%;max-height:85vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3);}
                .jt-cal-settings-header{padding:16px;border-bottom:1px solid var(--divider-color);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card-background-color);z-index:1;}
                .jt-cal-settings-header h3{margin:0;color:var(--primary-text-color);}
                .jt-cal-settings-close{background:none;border:none;font-size:1.5em;cursor:pointer;color:var(--secondary-text-color);}
                .jt-cal-settings-body{padding:16px;}
                .jt-settings-section{margin-bottom:20px;}
                .jt-settings-section h4{margin:0 0 12px 0;color:var(--primary-text-color);font-size:0.95em;}
                .jt-settings-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--divider-color);}
                .jt-settings-row:last-child{border-bottom:none;}
                .jt-settings-label{color:var(--primary-text-color);font-size:0.9em;}
                .jt-settings-toggle{position:relative;width:44px;height:24px;}
                .jt-settings-toggle input{opacity:0;width:0;height:0;}
                .jt-settings-toggle .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--divider-color);transition:.3s;border-radius:24px;}
                .jt-settings-toggle .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.3s;border-radius:50%;}
                .jt-settings-toggle input:checked + .slider{background:var(--primary-color);}
                .jt-settings-toggle input:checked + .slider:before{transform:translateX(20px);}
                .jt-settings-color{width:40px;height:30px;border:1px solid var(--divider-color);border-radius:4px;cursor:pointer;padding:0;}
                .jt-settings-select{padding:6px 10px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);}
                @media(max-width:600px){
                  .jt-cal-day{min-height:50px;}
                  .jt-cal-day-num{font-size:0.8em;}
                  .jt-cal-dot{width:4px;height:4px;}
                  .jt-cal-title{font-size:1em;min-width:auto;}
                }
              </style>
              <div class="jt-cal-container">
                {% set overdue_count = states('sensor.jottick_overdue_items') | int(0) %}
                {% if overdue_count > 0 %}
                <div class="jt-cal-overdue-banner">
                  <span class="jt-cal-overdue-text">You have <span class="jt-cal-overdue-count">{{ overdue_count }}</span> overdue item{% if overdue_count > 1 %}s{% endif %}</span>
                </div>
                {% endif %}
                <div class="jt-cal-header">
                  <div class="jt-cal-nav">
                    <button class="jt-cal-nav-btn" onclick="(function(){var ha=document.querySelector('home-assistant');var cur=ha.hass.states['input_datetime.jottick_calendar_selected_date'];var d=cur&&cur.state&&cur.state!='unknown'?new Date(cur.state):new Date();d.setMonth(d.getMonth()-1);ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:d.toISOString().split('T')[0]});})();">â—€</button>
                    {% set sel_date = states('input_datetime.jottick_calendar_selected_date') %}
                    {% set sel_dt = strptime(sel_date, '%Y-%m-%d') if sel_date and sel_date != 'unknown' else now() %}
                    <span class="jt-cal-title">{{ sel_dt.strftime('%B %Y') }}</span>
                    <button class="jt-cal-nav-btn" onclick="(function(){var ha=document.querySelector('home-assistant');var cur=ha.hass.states['input_datetime.jottick_calendar_selected_date'];var d=cur&&cur.state&&cur.state!='unknown'?new Date(cur.state):new Date();d.setMonth(d.getMonth()+1);ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:d.toISOString().split('T')[0]});})();">â–¶</button>
                  </div>
                  <div class="jt-cal-actions">
                    <button class="jt-cal-today-btn" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:new Date().toISOString().split('T')[0]});">Today</button>
                    <button class="jt-cal-settings-btn" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean','turn_on',{entity_id:'input_boolean.jottick_show_calendar_settings'});">âš™ï¸</button>
                  </div>
                </div>
                <div class="jt-cal-grid">
                  {% set week_start = states('input_select.jottick_calendar_week_start') %}
                  {% if week_start == 'monday' %}
                    {% set dow_names = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
                  {% else %}
                    {% set dow_names = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
                  {% endif %}
                  {% for d in dow_names %}
                  <div class="jt-cal-dow">{{ d }}</div>
                  {% endfor %}
                  {% set today = now().strftime('%Y-%m-%d') %}
                  {% set sel_date = states('input_datetime.jottick_calendar_selected_date') %}
                  {% set sel_date = sel_date if sel_date and sel_date != 'unknown' else today %}
                  {% set sel_dt = strptime(sel_date, '%Y-%m-%d') %}
                  {% set year = sel_dt.year %}
                  {% set month = sel_dt.month %}
                  {% set first_of_month = sel_dt.replace(day=1) %}
                  {% set first_dow = first_of_month.weekday() %}
                  {% if week_start == 'sunday' %}
                    {% set first_dow = (first_dow + 1) % 7 %}
                  {% endif %}
                  {% set days_in_month = ((first_of_month.replace(month=month%12+1, day=1) if month < 12 else first_of_month.replace(year=year+1, month=1, day=1)) - timedelta(days=1)).day %}      
                  {% set prev_month_end = first_of_month - timedelta(days=1) %}
                  {% set prev_days = first_dow %}  
                  
                  {% set cal_events = state_attr('sensor.jottick_calendar_events', 'events') or {} %}
                  
                  {% for i in range(prev_days) %}
                    {% set day_num = prev_month_end.day - prev_days + i + 1 %}
                    <div class="jt-cal-day other"><span class="jt-cal-day-num">{{ day_num }}</span></div>
                  {% endfor %}
                  {% for day in range(1, days_in_month + 1) %}
                    {% set date_str = '%04d-%02d-%02d' | format(year, month, day) %}
                    {% set is_today = date_str == today %}
                    {% set day_events = (cal_events.get(date_str, []) if cal_events is mapping else []) %}
                    <div class="jt-cal-day {{ 'today' if is_today else '' }}" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_datetime','set_datetime',{entity_id:'input_datetime.jottick_calendar_selected_date',date:'{{ date_str }}'});">
                      <span class="jt-cal-day-num">{{ day }}</span>
                      {% if day_events | length > 0 %}
                      <div class="jt-cal-dots">
                        {% for evt in day_events[:5] %}
                        <div class="jt-cal-dot" style="background:{{ evt.color }};"></div>
                        {% endfor %}
                        {% if day_events | length > 5 %}<span style="font-size:0.6em;color:var(--secondary-text-color);">+{{ day_events | length - 5 }}</span>{% endif %}
                      </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                  {% set total_cells = prev_days + days_in_month %}
                  {% set remaining = (7 - (total_cells % 7)) % 7 %}
                  {% for i in range(remaining) %}
                    <div class="jt-cal-day other"><span class="jt-cal-day-num">{{ i + 1 }}</span></div>
                  {% endfor %}
                </div>
                {% set selected_events = (cal_events.get(sel_date, []) if cal_events is mapping else []) %}
                <div class="jt-cal-events-panel">
                  <div class="jt-cal-events-header">{{ sel_dt.strftime('%A, %B %d, %Y') }}</div>
                  <div class="jt-cal-events-list">
                    {% if selected_events | length > 0 %}
                      {% for evt in selected_events %}
                      <div class="jt-cal-event" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_popup_event_data',value:JSON.stringify({{ evt | tojson }})});ha.hass.callService('input_boolean','turn_on',{entity_id:'input_boolean.jottick_show_calendar_event_popup'});">
                        <div class="jt-cal-event-dot" style="background:{{ evt.color }};"></div>
                        <div class="jt-cal-event-info">
                          <div class="jt-cal-event-title">{{ evt.title }}</div>
                          <div class="jt-cal-event-meta">{{ evt.type | replace('_', ' ') | title }}{% if evt.get('parent_title') %} â€¢ {{ evt.get('parent_title') }}{% endif %}</div>
                        </div>
                        {% if evt.get('time') %}<div class="jt-cal-event-time">{{ evt.get('time') }}</div>{% endif %}
                      </div>
                      {% endfor %}
                    {% else %}
                      <div class="jt-cal-empty">No events on this day</div>
                    {% endif %}
                  </div>
                </div>
              </div>
          - type: conditional
            conditions:
              - entity: input_boolean.jottick_show_calendar_settings
                state: 'on'
            card:
              type: custom:html-template-card
              ignore_line_breaks: true
              content: >
                <style>
                  .jt-cal-settings-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;box-sizing:border-box;}
                  .jt-cal-settings{background:var(--card-background-color);border-radius:12px;max-width:550px;width:100%;max-height:90vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3);}
                  .jt-cal-settings-header{padding:16px;border-bottom:1px solid var(--divider-color);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card-background-color);z-index:1;}
                  .jt-cal-settings-header h3{margin:0;color:var(--primary-text-color);}
                  .jt-cal-settings-close{background:none;border:none;font-size:1.5em;cursor:pointer;color:var(--secondary-text-color);padding:4px 8px;}
                  .jt-cal-settings-close:hover{color:var(--primary-text-color);}
                  .jt-cal-settings-body{padding:16px;}
                  .jt-settings-section{margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--divider-color);}
                  .jt-settings-section:last-child{border-bottom:none;margin-bottom:0;}
                  .jt-settings-section h4{margin:0 0 12px 0;color:var(--primary-text-color);font-size:1em;display:flex;align-items:center;gap:8px;}
                  .jt-settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--divider-color);gap:12px;}
                  .jt-settings-row:last-child{border-bottom:none;}
                  .jt-settings-label{color:var(--primary-text-color);font-size:0.9em;display:flex;align-items:center;gap:8px;flex:1;}
                  .jt-settings-toggle{position:relative;width:44px;height:24px;flex-shrink:0;}
                  .jt-settings-toggle input{opacity:0;width:0;height:0;}
                  .jt-settings-toggle .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--divider-color);transition:.3s;border-radius:24px;}
                  .jt-settings-toggle .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.3s;border-radius:50%;}
                  .jt-settings-toggle input:checked + .slider{background:var(--primary-color);}
                  .jt-settings-toggle input:checked + .slider:before{transform:translateX(20px);}
                  .jt-settings-select{padding:8px 12px;border:1px solid var(--divider-color);border-radius:6px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.9em;}
                  .jt-settings-color{width:40px;height:32px;border:2px solid var(--divider-color);border-radius:6px;cursor:pointer;padding:0;flex-shrink:0;}
                  .jt-settings-color::-webkit-color-swatch-wrapper{padding:0;}
                  .jt-settings-color::-webkit-color-swatch{border:none;border-radius:4px;}
                  .jt-settings-input{flex:1;padding:8px 12px;border:1px solid var(--divider-color);border-radius:6px;background:var(--card-background-color);color:var(--primary-text-color);font-size:0.9em;min-width:0;}
                  .jt-settings-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:500;transition:opacity 0.2s;}
                  .jt-settings-btn:hover{opacity:0.9;}
                  .jt-settings-btn.primary{background:var(--primary-color);color:white;}
                  .jt-settings-btn.secondary{background:var(--secondary-background-color);color:var(--primary-text-color);border:1px solid var(--divider-color);}
                  .jt-settings-btn.danger{background:#EF4444;color:white;}
                  .jt-settings-btn:disabled{opacity:0.5;cursor:not-allowed;}
                  .jt-ical-sources{margin-top:12px;}
                  .jt-ical-source{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--secondary-background-color);border-radius:6px;margin-bottom:8px;}
                  .jt-ical-source-info{flex:1;min-width:0;}
                  .jt-ical-source-name{font-size:0.9em;color:var(--primary-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
                  .jt-ical-source-url{font-size:0.75em;color:var(--secondary-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
                  .jt-ical-remove{background:#EF4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:0.8em;}
                  .jt-settings-status{font-size:0.85em;padding:8px 12px;border-radius:6px;margin-top:8px;}
                  .jt-settings-status.success{background:rgba(16,185,129,0.1);color:#10B981;}
                  .jt-settings-status.error{background:rgba(239,68,68,0.1);color:#EF4444;}
                  .jt-color-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
                </style>

                <div class="jt-cal-settings-overlay"
                onclick="if(event.target===this){var
                ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean','turn_off',{entity_id:'input_boolean.jottick_show_calendar_settings'});}">
                  <div class="jt-cal-settings">
                    <div class="jt-cal-settings-header">
                      <h3>Calendar Settings</h3>
                      <button class="jt-cal-settings-close" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean','turn_off',{entity_id:'input_boolean.jottick_show_calendar_settings'});">Ã—</button>
                    </div>
                    <div class="jt-cal-settings-body">   
                      <div class="jt-settings-section">
                        <h4>General</h4>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">Start week on</span>
                          <select class="jt-settings-select" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_select','select_option',{entity_id:'input_select.jottick_calendar_week_start',option:this.value});">
                            <option value="sunday" {% if states('input_select.jottick_calendar_week_start') == 'sunday' %}selected{% endif %}>Sunday</option>
                            <option value="monday" {% if states('input_select.jottick_calendar_week_start') == 'monday' %}selected{% endif %}>Monday</option>
                          </select>
                        </div>
                      </div>
                      
                      <div class="jt-settings-section">
                        <h4>Event Types & Colors</h4>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_note_created') }};"></span>
                            Note Created
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#9CCAEB' if states('input_text.jottick_calendar_color_note_created') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_note_created') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_note_created',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_note_created') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_note_created'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_note_edited') }};"></span>
                            Note Edited
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#6BA5D4' if states('input_text.jottick_calendar_color_note_edited') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_note_edited') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_note_edited',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_note_edited') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_note_edited'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_note_reminder') }};"></span>
                            Scheduled Notes
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#F7A700' if states('input_text.jottick_calendar_color_note_reminder') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_note_reminder') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_note_reminder',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_note_reminders') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_note_reminders'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_list_created') }};"></span>
                            List Created
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#99C66D' if states('input_text.jottick_calendar_color_list_created') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_list_created') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_list_created',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_list_created') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_list_created'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_list_edited') }};"></span>
                            List Edited
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#7AAD52' if states('input_text.jottick_calendar_color_list_edited') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_list_edited') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_list_edited',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_list_edited') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_list_edited'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_list_due') }};"></span>
                            List Due Dates
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#10B981' if states('input_text.jottick_calendar_color_list_due') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_list_due') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_list_due',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_list_due') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_list_due'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_task_due') }};"></span>
                            Task Due Dates
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#F9E900' if states('input_text.jottick_calendar_color_task_due') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_task_due') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_task_due',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_task_due') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_task_due'});"><span class="slider"></span></label>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_task_overdue') }};"></span>
                            Overdue Items
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#EF4444' if states('input_text.jottick_calendar_color_task_overdue') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_task_overdue') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_task_overdue',value:this.value});">
                          <span style="width:44px;"></span>
                        </div>
                        <div class="jt-settings-row">
                          <span class="jt-settings-label">
                            <span class="jt-color-dot" style="background:{{ states('input_text.jottick_calendar_color_imported') }};"></span>
                            Imported Events
                          </span>
                          <input type="color" class="jt-settings-color" value="{{ '#A855F7' if states('input_text.jottick_calendar_color_imported') in ['unknown','unavailable'] else states('input_text.jottick_calendar_color_imported') }}" onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_color_imported',value:this.value});">
                          <label class="jt-settings-toggle"><input type="checkbox" {% if states('input_boolean.jottick_calendar_show_imported') == 'on' %}checked{% endif %} onchange="var ha=document.querySelector('home-assistant');ha.hass.callService('input_boolean',this.checked?'turn_on':'turn_off',{entity_id:'input_boolean.jottick_calendar_show_imported'});"><span class="slider"></span></label>
                        </div>
                      </div>
                      <div class="jt-settings-section">
                        <h4>Import Calendar (iCal)</h4>
                        <p style="font-size:0.8em;color:var(--secondary-text-color);margin:0 0 12px 0;">Import events from Google Calendar, Outlook, Apple Calendar, or any .ics URL</p>
                        <div class="jt-settings-row" style="flex-direction:column;align-items:stretch;gap:8px;">
                          <input type="text" class="jt-settings-input ical-url-input" placeholder="Calendar URL (ends in .ics)" value="{{ '' if states('input_text.jottick_ical_import_url') in ['unknown','unavailable'] else states('input_text.jottick_ical_import_url') }}" oninput="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_ical_import_url',value:this.value});">
                          <input type="text" class="jt-settings-input ical-name-input" placeholder="Calendar name (optional)" value="{{ '' if states('input_text.jottick_ical_import_name') in ['unknown','unavailable'] else states('input_text.jottick_ical_import_name') }}" oninput="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_ical_import_name',value:this.value});">
                          <div style="display:flex;gap:8px;">
                            <button class="jt-settings-btn primary" style="flex:1;" onclick="(function(btn){var urlInput=btn.closest('.jt-settings-section').querySelector('.ical-url-input');var nameInput=btn.closest('.jt-settings-section').querySelector('.ical-name-input');var url=urlInput.value.trim();if(!url){alert('Please enter a calendar URL');return;}btn.disabled=true;btn.textContent='Importing...';var ha=document.querySelector('home-assistant');ha.hass.callService('jottick','import_ical',{url:url,name:nameInput.value.trim()||'Imported Calendar',auto_refresh:true});setTimeout(function(){btn.disabled=false;btn.textContent='Import Calendar';urlInput.value='';nameInput.value='';ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_ical_import_url',value:''});ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_ical_import_name',value:''});},2000);})(this);">Import Calendar</button>
                            <button class="jt-settings-btn secondary" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('jottick','refresh_ical_imports');this.textContent='Refreshing...';var btn=this;setTimeout(function(){btn.textContent='Refresh All';},1500);">Refresh All</button>
                          </div>
                        </div>
                        {% set ical_sources = state_attr('sensor.jottick_imported_events', 'sources') or [] %}
                        {% if ical_sources | length > 0 %}
                        <div class="jt-ical-sources">
                          <div style="font-size:0.85em;color:var(--secondary-text-color);margin-bottom:8px;">Imported Calendars:</div>
                          {% for source in ical_sources %}
                          <div class="jt-ical-source">
                            <div class="jt-ical-source-info">
                              <div class="jt-ical-source-name">{{ source.name | default('Imported Calendar') }} <span style="font-size:0.75em;color:var(--secondary-text-color);">({{ source.event_count | default(0) }} events)</span></div>
                              <div class="jt-ical-source-url">{{ source.url | truncate(40) }}</div>
                            </div>
                            <button class="jt-ical-remove" onclick="if(confirm('Remove this calendar?')){var ha=document.querySelector('home-assistant');ha.hass.callService('jottick','remove_ical_import',{url:'{{ source.url }}'});}">Remove</button>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}
                      </div>
                      <div class="jt-settings-section">
                        <h4>Export Calendar</h4>
                        <p style="font-size:0.8em;color:var(--secondary-text-color);margin:0 0 12px 0;">Export your JotTick data as an iCal file</p>
                        
                        <div class="jt-settings-row" style="flex-direction:column;align-items:stretch;gap:8px;">
                          <input type="text" class="jt-settings-input export-filename" placeholder="Filename (without .ics)" value="{{ states('input_text.jottick_calendar_export_filename') | default('jottick_calendar') }}" oninput="var ha=document.querySelector('home-assistant');ha.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_calendar_export_filename',value:this.value});">
                          
                          <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:0.85em;">
                            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                              <input type="checkbox" class="export-notes" checked> Notes
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                              <input type="checkbox" class="export-lists" checked> Lists
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                              <input type="checkbox" class="export-tasks" checked> Tasks
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
                              <input type="checkbox" class="export-reminders" checked> Reminders
                            </label>
                          </div>     
                          <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="jt-settings-btn primary" style="flex:1;" onclick="(function(btn){var sec=btn.closest('.jt-settings-section');var filename=sec.querySelector('.export-filename').value.trim()||'jottick_calendar';var includeNotes=sec.querySelector('.export-notes').checked;var includeLists=sec.querySelector('.export-lists').checked;var includeTasks=sec.querySelector('.export-tasks').checked;var includeReminders=sec.querySelector('.export-reminders').checked;btn.disabled=true;btn.textContent='Exporting...';var ha=document.querySelector('home-assistant');ha.hass.callService('jottick','export_ical',{filename:filename,include_notes:includeNotes,include_lists:includeLists,include_tasks:includeTasks,include_reminders:includeReminders});var downloadDiv=sec.querySelector('.export-download-link');setTimeout(function(){btn.disabled=false;btn.textContent='Export to .ics File';var link=document.createElement('a');link.href='/api/jottick/calendar/'+filename+'.ics';link.download=filename+'.ics';link.style.cssText='display:inline-block;padding:8px 16px;background:var(--success-color,#10b981);color:white;border-radius:6px;text-decoration:none;font-size:0.9em;';link.textContent='â¬‡ï¸ Download '+filename+'.ics';downloadDiv.innerHTML='';downloadDiv.appendChild(link);downloadDiv.style.display='block';},1500);})(this);">Export to .ics File</button>
                          </div>                 
                          <div class="export-download-link" style="display:none;text-align:center;margin-top:8px;"></div>                      
                          <p style="font-size:0.75em;color:var(--secondary-text-color);margin:8px 0 0 0;">
                            After exporting, click the download button or access the file at:<br>
                            <code style="font-size:0.9em;">/api/jottick/calendar/{filename}.ics</code>
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
