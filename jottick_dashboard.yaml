title: Notes
icon: mdi:notebook
views:
  - title: Notes
    path: notes
    icon: mdi:note-text
    sections:
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .create-note-form { padding: 16px; }
                .create-note-form h3 { margin: 0 0 12px 0; color: var(--primary-text-color); }
                .create-note-form input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--divider-color); border-radius: 6px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .create-note-form textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid var(--divider-color); border-radius: 6px; resize: vertical; font-family: inherit; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .create-note-form button { padding: 10px 20px; background: var(--primary-color); color: var(--text-primary-color, white); border: none; border-radius: 6px; cursor: pointer; font-size: 1em; margin-top: 10px; }
                .create-note-form button:hover { opacity: 0.9; }
                .create-note-form .btn-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
                .create-img-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
                .create-img-preview .preview-thumb { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; }
                .create-img-preview .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .create-img-preview .preview-thumb button { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; }
                .create-status { font-size: 0.85em; color: var(--primary-color); margin-top: 8px; min-height: 20px; }
                .format-toggle { display: flex; gap: 0; margin-bottom: 10px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); width: fit-content; }
                .format-toggle button { padding: 6px 14px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
                .format-toggle button.active { background: var(--primary-color); color: white; }
                .format-toggle button:hover:not(.active) { background: var(--divider-color); }
              </style>
              <div class="create-note-form">
                <h3>New Note</h3>
                <input type="text" class="new-note-title" placeholder="Title">
                <div class="format-toggle">
                  <button type="button" class="format-btn active" data-format="html" onclick="this.classList.add('active');this.nextElementSibling.classList.remove('active');this.closest('.create-note-form').querySelector('.new-note-content').placeholder='Content (HTML tags accepted)';">HTML</button>
                  <button type="button" class="format-btn" data-format="md" onclick="this.classList.add('active');this.previousElementSibling.classList.remove('active');this.closest('.create-note-form').querySelector('.new-note-content').placeholder='Content (Markdown supported)';">Markdown</button>
                </div>
                <textarea class="new-note-content" placeholder="Content (HTML tags accepted)"></textarea>
                <div class="lock-option" style="margin:10px 0;padding:10px;background:var(--secondary-background-color);border-radius:6px;">
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9em;"><input type="checkbox" class="lock-checkbox" onchange="this.closest('.lock-option').querySelector('.lock-password').style.display=this.checked?'block':'none';"> üîí Password protect this note</label>
                  <input type="password" class="lock-password" placeholder="Enter password to lock note" style="display:none;width:100%;padding:8px;margin-top:8px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);box-sizing:border-box;">
                </div>
                <div class="create-img-preview"></div>
                <div class="btn-row">
                  <label class="add-img-label" style="display:inline-block;padding:10px 16px;background:var(--secondary-background-color);color:var(--primary-text-color);border:1px solid var(--divider-color);border-radius:6px;cursor:pointer;font-size:1em;">üì∑ Add Images<input type="file" accept="image/*" multiple style="display:none;" onchange="var input=this,form=input.closest('.create-note-form'),preview=form.querySelector('.create-img-preview'),maxBytes=15*1024*1024;for(var i=0;i<input.files.length;i++){(function(file){var addThumb=function(dataUrl,name){var div=document.createElement('div');div.className='preview-thumb';div.dataset.name=name;div.dataset.data=dataUrl;var img=document.createElement('img');img.src=dataUrl;div.appendChild(img);var btn=document.createElement('button');btn.textContent='√ó';btn.onclick=function(){div.remove();};div.appendChild(btn);preview.appendChild(div);};if(file.size<=maxBytes){var reader=new FileReader();reader.onload=function(e){addThumb(e.target.result,file.name);};reader.readAsDataURL(file);}else{var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.width,h=img.height,q=0.9,s=1;var tryIt=function(){canvas.width=w*s;canvas.height=h*s;ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(blob){if(blob.size<=maxBytes||q<0.1){var r2=new FileReader();r2.onload=function(e2){addThumb(e2.target.result,file.name.replace(/\.[^.]+$/,'.jpg'));};r2.readAsDataURL(blob);}else{q-=0.1;if(q<0.5)s*=0.8;tryIt();}},'image/jpeg',q);};tryIt();};img.src=e.target.result;};reader.readAsDataURL(file);}})(input.files[i]);}input.value='';"></label>
                  <button type="button" class="create-btn" onclick="(function(btn){var form=btn.closest('.create-note-form'),titleEl=form.querySelector('.new-note-title'),contentEl=form.querySelector('.new-note-content'),title=titleEl.value,content=contentEl.value,status=form.querySelector('.create-status'),preview=form.querySelector('.create-img-preview'),thumbs=preview.querySelectorAll('.preview-thumb'),mdBtn=form.querySelector('.format-btn[data-format=md]'),isMd=mdBtn.classList.contains('active'),lockCb=form.querySelector('.lock-checkbox'),lockPw=form.querySelector('.lock-password'),shouldLock=lockCb.checked,password=lockPw.value;if(!title.trim()){alert('Title is required');return;}if(shouldLock&amp;&amp;!password){alert('Please enter a password');return;}if(isMd){content=String.fromCharCode(60)+'!--MD--'+String.fromCharCode(62)+content;}var doCreate=function(finalContent){btn.disabled=true;btn.textContent='Creating...';var noteId='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0;return(c==='x'?r:(r%4+8)).toString(16);});var ha=document.querySelector('home-assistant'),token=ha.hass.auth.data.access_token;ha.hass.callService('jottick','create_note',{title:title,content:finalContent,note_id:noteId});if(thumbs.length>0){status.textContent='Uploading images...';var done=0,total=thumbs.length;thumbs.forEach(function(thumb){fetch(thumb.dataset.data).then(function(r){return r.blob();}).then(function(blob){var fd=new FormData();fd.append('note_id',noteId);fd.append('file',blob,thumb.dataset.name);return fetch('/api/jottick/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd});}).then(function(){done++;status.textContent='Uploaded '+done+'/'+total;if(done>=total){status.textContent='Note created!';btn.disabled=false;btn.textContent='Create';}}).catch(function(e){status.textContent='Error: '+e;});});}else{status.textContent='Note created!';btn.disabled=false;btn.textContent='Create';}titleEl.value='';contentEl.value='';preview.innerHTML='';lockCb.checked=false;lockPw.value='';lockPw.style.display='none';form.querySelector('.format-btn[data-format=html]').classList.add('active');mdBtn.classList.remove('active');contentEl.placeholder='Content (HTML tags accepted)';};if(shouldLock){status.textContent='Encrypting...';var enc=new TextEncoder();var salt=crypto.getRandomValues(new Uint8Array(16));var iv=crypto.getRandomValues(new Uint8Array(12));crypto.subtle.importKey('raw',enc.encode(password),'PBKDF2',false,['deriveBits','deriveKey']).then(function(keyMaterial){return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},false,['encrypt']);}).then(function(key){return crypto.subtle.encrypt({name:'AES-GCM',iv:iv},key,enc.encode(content));}).then(function(encrypted){var b64=function(arr){return btoa(String.fromCharCode.apply(null,new Uint8Array(arr)));};var final=String.fromCharCode(60)+'!--ENC:'+b64(salt)+':'+b64(iv)+'--'+String.fromCharCode(62)+b64(encrypted);doCreate(final);}).catch(function(e){status.textContent='Encryption error: '+e;btn.disabled=false;});}else{doCreate(content);}})(this);">Create</button>
                </div>
                <div class="create-status"></div>
              </div>
            grid_options:
              columns: full
              rows: auto
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: >
              <style>
                .reminder-config{padding:16px;font-family:var(--paper-font-body1_-_font-family);}
                .reminder-config h3{margin:0 0 8px 0;color:var(--primary-text-color);font-size:1.1em;}
                .reminder-config .help{font-size:0.85em;color:var(--secondary-text-color);margin-bottom:12px;}
                .reminder-config .section{background:var(--secondary-background-color);border-radius:8px;padding:12px;margin-bottom:12px;}
                .reminder-config .section-title{font-weight:600;font-size:0.95em;margin-bottom:8px;color:var(--primary-text-color);}
                .reminder-config select,.reminder-config input[type=text]{width:100%;padding:10px;margin-bottom:8px;border:1px solid var(--divider-color);border-radius:6px;background:var(--card-background-color);color:var(--primary-text-color);font-size:1em;box-sizing:border-box;}
                .reminder-config button.save-btn{padding:8px 16px;background:var(--primary-color);color:var(--text-primary-color,white);border:none;border-radius:6px;cursor:pointer;font-size:0.9em;margin-right:8px;}
                .reminder-config button.save-btn:hover{opacity:0.9;}
                .reminder-config button.save-btn:disabled{opacity:0.5;cursor:not-allowed;}
                .reminder-config .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--card-background-color);border-radius:6px;margin:4px 0;font-size:0.9em;}
                .reminder-config .item .del{padding:4px 10px;background:#ef4444;color:white;font-size:0.8em;margin:0;border:none;border-radius:4px;cursor:pointer;}
                .reminder-config .status{font-size:0.85em;color:var(--primary-color);margin-top:8px;min-height:18px;}
                .reminder-config .empty{font-style:italic;color:var(--secondary-text-color);font-size:0.85em;}
                .reminder-config .pending{padding:6px 10px;background:var(--card-background-color);border-radius:6px;margin:4px 0;font-size:0.85em;}
                .reminder-config .hint{font-size:0.8em;color:var(--secondary-text-color);margin-top:4px;}
              </style>

              {% set notifiers =
              state_attr('sensor.jottick_available_notifiers', 'notifiers') or
              [] %}

              {% set user_devices = state_attr('sensor.jottick_user_devices',
              'user_devices') or {} %}

              {% set aliases = state_attr('sensor.jottick_reminder_aliases',
              'aliases') or {} %}

              {% set schedules = state_attr('sensor.jottick_scheduled_notes',
              'schedules') or {} %}

              <div class="reminder-config">
                <h3>Assist Reminder Settings</h3>
                <p class="help">Say "Remind me to..." or "Remind [name] to..." and notifications go to the right phone!</p>
                <div class="section" id="user-section">
                  <div class="section-title">My Device (for "Remind Me")</div>
                  <select class="user-select">
                    <option value="">-- Select your HA user --</option>
                    {% for state in states.person %}
                      {% if state.attributes.user_id is defined and state.attributes.user_id %}
                    <option value="{{ state.attributes.user_id }}">{{ state.attributes.friendly_name | default(state.entity_id | replace('person.','')) }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <select class="device-select">
                    <option value="">-- Select device --</option>
                    {% for n in notifiers %}
                    <option value="{{ n }}">{{ n | replace('notify.mobile_app_','') | replace('_',' ') | title }}</option>
                    {% endfor %}
                  </select>
                  <button class="save-btn" type="button" onclick="(function(btn){var sec=btn.closest('.section');var u=sec.querySelector('.user-select');var d=sec.querySelector('.device-select');var cfg=btn.closest('.reminder-config');var s=cfg.querySelector('.status');if(!u.value){s.textContent='Select your user';return;}if(!d.value){s.textContent='Select your device';return;}var ha=document.querySelector('home-assistant');var uname=u.options[u.selectedIndex].text;ha.hass.callService('script','jottick_save_user_device',{user_id:u.value,user_name:uname,device:d.value});s.textContent='Saved! Refresh page to see changes.';btn.disabled=true;setTimeout(function(){btn.disabled=false;},2000);})(this);">Save My Device</button>
                  <div class="users-list">
                    {% if user_devices and user_devices | length > 0 %}
                      {% for uid, data in user_devices.items() %}
                    <div class="item">
                      <span>{{ data.name }} ‚Üí {{ data.device | replace('notify.mobile_app_','') | replace('_',' ') }}</span>
                      <button class="del" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_delete_user_device',{user_id:'{{ uid }}'});this.closest('.reminder-config').querySelector('.status').textContent='Deleted. Refresh page.';">√ó</button>
                    </div>
                      {% endfor %}
                    {% else %}
                    <div class="empty">No users mapped yet</div>
                    {% endif %}
                  </div>
                </div>
                <div class="section" id="alias-section">
                  <div class="section-title">Name Aliases (for "Remind Mom/Tim/Dad")</div>
                  <input type="text" class="names-input" placeholder="Names separated by commas (e.g. tim, timmy, dad)">
                  <select class="device-select">
                    <option value="">-- Select device --</option>
                    {% for n in notifiers %}
                    <option value="{{ n }}">{{ n | replace('notify.mobile_app_','') | replace('_',' ') | title }}</option>
                    {% endfor %}
                  </select>
                  <button class="save-btn" type="button" onclick="(function(btn){var sec=btn.closest('.section');var n=sec.querySelector('.names-input');var d=sec.querySelector('.device-select');var cfg=btn.closest('.reminder-config');var s=cfg.querySelector('.status');if(!n.value.trim()){s.textContent='Enter at least one name';return;}if(!d.value){s.textContent='Select a device';return;}var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_save_alias_direct',{names:n.value,device:d.value});s.textContent='Saved! Say: remind '+n.value.split(',')[0].trim()+' to... Refresh to see.';n.value='';btn.disabled=true;setTimeout(function(){btn.disabled=false;},2000);})(this);">Save Alias</button>
                  <div class="aliases-list">
                    {% set alias_by_device = namespace(devices={}) %}
                    {% for name, dev in aliases.items() %}
                      {% if dev not in alias_by_device.devices %}
                        {% set alias_by_device.devices = dict(alias_by_device.devices, **{dev: [name]}) %}
                      {% else %}
                        {% set alias_by_device.devices = dict(alias_by_device.devices, **{dev: alias_by_device.devices[dev] + [name]}) %}
                      {% endif %}
                    {% endfor %}
                    {% if alias_by_device.devices | length > 0 %}
                      {% for dev, names in alias_by_device.devices.items() %}
                    <div class="item">
                      <span>{{ names | join(', ') }} ‚Üí {{ dev | replace('notify.mobile_app_','') | replace('_',' ') }}</span>
                      <button class="del" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_delete_alias_group',{device:'{{ dev }}'});this.closest('.reminder-config').querySelector('.status').textContent='Deleted. Refresh page.';">√ó</button>
                    </div>
                      {% endfor %}
                    {% else %}
                    <div class="empty">No aliases yet</div>
                    {% endif %}
                  </div>
                </div>
                <div class="section">
                  <div class="section-title">Pending Assist Reminders</div>
                  <div class="pending-list">
                    {% set reminder_count = namespace(val=0) %}
                    {% for sched_id, sched in schedules.items() %}
                      {% if sched.auto_delete | default(false) %}
                        {% set reminder_count.val = reminder_count.val + 1 %}
                    <div class="pending">
                      ‚Ä¢ {{ sched.message }} @ {{ as_timestamp(sched.scheduled_time) | timestamp_custom('%b %d %I:%M %p') }}
                      <button style="margin-left:8px;padding:2px 8px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="var ha=document.querySelector('home-assistant');ha.hass.callService('script','jottick_cancel_scheduled_note',{schedule_id:'{{ sched_id }}'});this.parentElement.remove();">√ó</button>
                    </div>
                      {% endif %}
                    {% endfor %}
                    {% if reminder_count.val == 0 %}
                    <div class="empty">No pending reminders</div>
                    {% endif %}
                  </div>
                </div>
                <div class="status"></div>
              </div>
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: >
              <style>
                @keyframes slideDown { from {top:40px;opacity:0;} to {top:60px;opacity:1;} }
                #jottick-loading {
                  display:none;
                  position:fixed;
                  top:60px;
                  left:50%;
                  transform:translateX(-50%);
                  z-index:9999;
                  background:var(--primary-color);
                  color:var(--text-primary-color, white);
                  padding:12px 24px;
                  border-radius:8px;
                  box-shadow:0 4px 12px rgba(0,0,0,0.3);
                  font-weight:600;
                  animation:slideDown 0.3s ease;
                }
                .notes-container { padding: 4px; }
                .note-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 16px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  transition: box-shadow 0.2s;
                }
                .note-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
                .note-title {
                  font-size: 1.4em;
                  font-weight: 600;
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  padding-bottom: 8px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .note-content {
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  white-space: inherit;
                  line-height: 1.6;
                  font-size: 1em;
                }
                .note-content.markdown { white-space: normal; }
                .note-content.markdown h1 { font-size: 1.6em; margin: 0.5em 0; border-bottom: 1px solid var(--divider-color); padding-bottom: 0.3em; }
                .note-content.markdown h2 { font-size: 1.4em; margin: 0.5em 0; }
                .note-content.markdown h3 { font-size: 1.2em; margin: 0.5em 0; }
                .note-content.markdown p { margin: 0.5em 0; }
                .note-content.markdown ul, .note-content.markdown ol { margin: 0.5em 0; padding-left: 1.5em; }
                .note-content.markdown li { margin: 0.25em 0; }
                .note-content.markdown code { background: var(--secondary-background-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
                .note-content.markdown pre { background: var(--secondary-background-color); padding: 12px; border-radius: 6px; overflow-x: auto; }
                .note-content.markdown pre code { background: none; padding: 0; }
                .note-content.markdown blockquote { border-left: 3px solid var(--primary-color); margin: 0.5em 0; padding-left: 1em; color: var(--secondary-text-color); }
                .note-content.markdown a { color: var(--primary-color); }
                .note-content.markdown strong { font-weight: 600; }
                .note-content.markdown em { font-style: italic; }
                .note-content.markdown hr { border: none; border-top: 1px solid var(--divider-color); margin: 1em 0; }
                .note-timestamp {
                  font-size: 0.85em;
                  color: var(--secondary-text-color);
                  font-style: italic;
                  text-align: right;
                }
                .note-image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; margin: 10px 0; }
                .note-image-thumb { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; cursor: pointer; background: var(--secondary-background-color); }
                .note-image-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .note-image-thumb:hover { opacity: 0.9; }
                .note-image-thumb .img-del { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; opacity: 0; transition: opacity 0.2s; line-height: 1; padding: 0; }
                .note-image-thumb:hover .img-del { opacity: 1; }
                .image-count { display: inline-block; padding: 1px 6px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 0.7em; margin-left: 6px; vertical-align: middle; }
                .format-badge { display: inline-block; padding: 1px 6px; background: var(--secondary-background-color); color: var(--secondary-text-color); border-radius: 8px; font-size: 0.65em; margin-left: 6px; vertical-align: middle; text-transform: uppercase; }
                .edit-images { margin: 10px 0; padding: 10px; background: var(--card-background-color); border-radius: 6px; }
                .edit-images h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .edit-upload-label { display: inline-block; padding: 6px 12px; background: var(--primary-color); color: white; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
                .edit-upload-label input { display: none; }
                .upload-status { font-size: 0.8em; color: var(--primary-color); margin-top: 6px; min-height: 16px; }
                .create-img-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
                .create-img-preview .preview-thumb { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; }
                .create-img-preview .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .create-img-preview .preview-thumb button { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; }
                .note-send-section, .note-edit-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: var(--secondary-background-color);
                  border: 1px solid var(--divider-color);
                  border-radius: 8px;
                  display: none;
                }
                .note-send-section.show, .note-edit-section.show { display: block; }
                .note-send-section h4, .note-edit-section h4 { margin: 0 0 12px 0; color: var(--primary-text-color); }
                .send-targets { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
                .send-targets label { display: flex; align-items: center; gap: 4px; font-size: 0.9em; cursor: pointer; }
                .send-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .send-mode-tabs { display: flex; gap: 0; margin-bottom: 12px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); }
                .send-mode-tab { flex: 1; padding: 8px 12px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
                .send-mode-tab.active { background: var(--primary-color); color: white; }
                .send-mode-tab:hover:not(.active) { background: var(--divider-color); }
                .schedule-picker { display: none; margin: 12px 0; padding: 12px; background: var(--card-background-color); border-radius: 6px; }
                .schedule-picker.show { display: block; }
                .schedule-picker label { display: block; font-size: 0.85em; color: var(--secondary-text-color); margin-bottom: 4px; }
                .schedule-picker input[type="datetime-local"] { width: 100%; padding: 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .send-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                .note-edit-section input[type="text"] { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section textarea { width: 100%; min-height: 120px; padding: 8px; border: 1px solid var(--divider-color); border-radius: 4px; resize: vertical; font-family: inherit; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section .edit-actions { display: flex; gap: 8px; margin-top: 8px; }
                .note-edit-section .edit-save-btn { padding: 8px 16px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .note-edit-section .edit-cancel-btn { padding: 8px 16px; background: var(--card-background-color); color: var(--primary-text-color); border: 1px solid var(--divider-color); border-radius: 4px; cursor: pointer; }
                .send-btn-wrapper { position: relative; display: inline-block; }
                .send-badge { position: absolute; top: -6px; right: -6px; background: var(--error-color, #dc2626); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
                .pending-schedules { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--divider-color); }
                .pending-schedules h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--card-background-color); border-radius: 6px; margin-bottom: 6px; font-size: 0.85em; }
                .pending-item-info { color: var(--primary-text-color); }
                .pending-item-time { color: var(--secondary-text-color); font-size: 0.9em; }
                .pending-cancel-btn { padding: 4px 10px; background: var(--error-color, #dc2626); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
                .format-toggle { display: flex; gap: 0; margin-bottom: 10px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); width: fit-content; }
                .format-toggle button { padding: 6px 14px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
                .format-toggle button.active { background: var(--primary-color); color: white; }
                .format-toggle button:hover:not(.active) { background: var(--divider-color); }
              </style>

              <div id="jottick-loading"
              style="display:none;position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:9999;background:var(--primary-color);color:var(--text-primary-color,
              white);padding:12px 24px;border-radius:8px;box-shadow:0 4px 12px
              rgba(0,0,0,0.3);font-weight:600;">Loading...</div>

              <div class="notes-container">
                {% set ns = namespace(count=0, notes=[]) %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% set all_schedules = state_attr('sensor.jottick_scheduled_notes', 'schedules') or {} %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Note:') and state.state != 'unavailable' %}
                    {% set ns.notes = ns.notes + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.notes | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set note_id = state_attr(state.entity_id, 'note_id') %}
                    {% set raw_content = state_attr(state.entity_id, 'content') | default('') %}
                    {% set is_markdown = raw_content.startswith('<!--MD-->') %}
                    {% set is_encrypted = raw_content.startswith('<!--ENC:') %}
                    {% set edit_content = raw_content.replace('<!--MD-->', '') if is_markdown else raw_content %}
                    {% set display_content = edit_content %}
                    {% if is_markdown and not is_encrypted %}
                      {% set display_content = display_content | regex_replace('\\*\\*(.+?)\\*\\*', '<strong>\\1</strong>') %}
                      {% set display_content = display_content | regex_replace('(?<![*])\\*([^*]+)\\*(?![*])', '<em>\\1</em>') %}
                      {% set display_content = display_content | regex_replace('`([^`]+)`', '<code style="background:var(--secondary-background-color);padding:2px 6px;border-radius:4px;font-family:monospace;">\\1</code>') %}
                      {% set display_content = display_content | regex_replace('(?m)^### (.+)$', '<h3 style="font-size:1.2em;margin:0.5em 0;">\\1</h3>') %}
                      {% set display_content = display_content | regex_replace('(?m)^## (.+)$', '<h2 style="font-size:1.4em;margin:0.5em 0;">\\1</h2>') %}
                      {% set display_content = display_content | regex_replace('(?m)^# (.+)$', '<h1 style="font-size:1.6em;margin:0.5em 0;border-bottom:1px solid var(--divider-color);padding-bottom:0.3em;">\\1</h1>') %}
                      {% set display_content = display_content | regex_replace('(?m)^- (.+)$', '<li style="margin-left:1.5em;">\\1</li>') %}
                      {% set display_content = display_content | regex_replace('(?m)^> (.+)$', '<blockquote style="border-left:3px solid var(--primary-color);margin:0.5em 0;padding-left:1em;color:var(--secondary-text-color);">\\1</blockquote>') %}
                      {% set display_content = display_content | regex_replace('\\[([^\\]]+)\\]\\(([^)]+)\\)', '<a href="\\2" style="color:var(--primary-color);">\\1</a>') %}
                      {% set display_content = display_content | regex_replace('(?m)^---$', '<hr style="border:none;border-top:1px solid var(--divider-color);margin:1em 0;">') %}
                    {% endif %}
                    {% set images = state_attr(state.entity_id, 'images') or [] %}
                    {% set img_count = images | length %}
                    {% set note_schedules = namespace(items=[], count=0) %}
                    {% for sched_id, sched in all_schedules.items() %}
                      {% if sched.note_id == note_id %}
                        {% set note_schedules.items = note_schedules.items + [{'id': sched_id, 'time': sched.scheduled_time, 'targets': sched.targets}] %}
                        {% set note_schedules.count = note_schedules.count + 1 %}
                      {% endif %}
                    {% endfor %}
                    <div class="note-card" data-noteid="{{ note_id }}" data-format="{{ 'md' if is_markdown else 'html' }}" data-encrypted="{{ 'true' if is_encrypted else 'false' }}" data-raw="{{ raw_content | e }}">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div class="note-title" style="flex-grow:1; margin-bottom:0; padding-bottom:8px; border-bottom:none;">{{ state.state }}{% if img_count > 0 %}<span class="image-count">üì∑{{ img_count }}</span>{% endif %}{% if is_markdown %}<span class="format-badge">MD</span>{% endif %}{% if is_encrypted %}<span class="format-badge" style="background:var(--warning-color,#f59e0b);">üîí</span>{% endif %}</div>
                        <div style="display:flex;gap:4px;">
                          {% if not is_encrypted %}
                          <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-edit-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-send-section');if(sec)sec.classList.remove('show');}})(this);" title="Edit note">Edit</button>
                          <div class="send-btn-wrapper">
                            <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-send-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-edit-section');if(sec)sec.classList.remove('show');}})(this);" title="Send to device">Send</button>
                            {% if note_schedules.count > 0 %}<span class="send-badge">{{ note_schedules.count }}</span>{% endif %}
                          </div>
                          {% endif %}
                          <button style="padding:4px 12px; background:var(--error-color, #ff5555); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="if(confirm('Delete {{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}?')){this.disabled=true; const el=document.querySelector('home-assistant'); if(el&&el.hass){el.hass.callService('script','jottick_delete_note_with_schedules',{note_id:'{{ note_id }}'});}}">Delete
                        </div>
                      </div>
                      {% if is_encrypted %}
                      <div class="note-locked" style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">üîí</div>
                        <div style="color:var(--secondary-text-color);margin-bottom:15px;">This note is encrypted</div>
                        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                          <input type="password" class="unlock-password" placeholder="Enter password" style="padding:8px 12px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);width:180px;">
                          <button class="unlock-btn" style="padding:8px 16px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;" onclick="(function(btn){var card=btn.closest('.note-card'),raw=card.dataset.raw,pwInput=card.querySelector('.unlock-password'),pw=pwInput.value,contentDiv=card.querySelector('.note-content'),lockedDiv=card.querySelector('.note-locked');if(!pw){alert('Enter password');return;}btn.disabled=true;btn.textContent='Decrypting...';try{var LT=String.fromCharCode(60),GT=String.fromCharCode(62),AMP=String.fromCharCode(38);var decoded=raw.split(AMP+'lt;').join(LT).split(AMP+'gt;').join(GT).split(AMP+'amp;').join(AMP).split(AMP+'quot;').join(String.fromCharCode(34));var encStart=LT+'!--ENC:';var idx=decoded.indexOf(encStart);if(idx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format');return;}var rest=decoded.substring(idx+encStart.length);var colonIdx=rest.indexOf(':');var dashIdx=rest.indexOf('--'+GT);if(colonIdx==-1||dashIdx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format 2');return;}var saltB64=rest.substring(0,colonIdx);var ivB64=rest.substring(colonIdx+1,dashIdx);var cipherB64=rest.substring(dashIdx+3);var b64d=function(s){return Uint8Array.from(atob(s),function(c){return c.charCodeAt(0);});};var salt=b64d(saltB64),iv=b64d(ivB64),ciphertext=b64d(cipherB64);var enc=new TextEncoder();crypto.subtle.importKey('raw',enc.encode(pw),'PBKDF2',false,['deriveBits','deriveKey']).then(function(km){return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['decrypt']);}).then(function(key){return crypto.subtle.decrypt({name:'AES-GCM',iv:iv},key,ciphertext);}).then(function(dec){var text=new TextDecoder().decode(dec);lockedDiv.style.display='none';contentDiv.style.display='block';contentDiv.textContent=text;btn.textContent='Unlock';btn.disabled=false;}).catch(function(e){btn.textContent='Unlock';btn.disabled=false;alert('Wrong password');});}catch(e){btn.textContent='Unlock';btn.disabled=false;alert('Error: '+e);}})(this);">Unlock</button>
                        </div>
                      </div>
                      <div class="note-content" style="display:none;"></div>
                      {% else %}
                      <div class="note-content">{{ display_content }}</div>
                      {% endif %}
                      {% if img_count > 0 %}
                      <div class="note-image-gallery">
                        {% for img in images %}
                        <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                          <img src="{{ img.url }}" loading="lazy" alt="">
                          <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='üì∑'+(n-1);}}}else{alert(d.error||'Error');}});}">√ó</button>
                        </div>
                        {% endfor %}
                      </div>
                      {% endif %}
                      <div class="note-timestamp">
                        Updated {{ relative_time(strptime(state_attr(state.entity_id, 'updated'), '%Y-%m-%dT%H:%M:%S.%fZ')) }} ago
                      </div>
                      <div class="note-send-section">
                        <h4>Send Note</h4>
                        <div class="send-targets">
                          {% for n in notifiers %}{% if n != 'Nobody' %}
                          <label><input type="checkbox" class="send-target-cb" value="{{ n }}"><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                          {% endif %}{% endfor %}
                        </div>
                        <div class="send-mode-tabs">
                          <button class="send-mode-tab active" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.remove('show');sec.querySelector('.send-now-btn').style.display='inline-block';sec.querySelector('.schedule-btn').style.display='none';})(this);">Send Now</button>
                          <button class="send-mode-tab" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.add('show');sec.querySelector('.send-now-btn').style.display='none';sec.querySelector('.schedule-btn').style.display='inline-block';var picker=sec.querySelector('.schedule-datetime');var now=new Date();now.setMinutes(now.getMinutes()+30);var y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0'),d=String(now.getDate()).padStart(2,'0'),h=String(now.getHours()).padStart(2,'0'),mi=String(now.getMinutes()).padStart(2,'0');picker.value=y+'-'+m+'-'+d+'T'+h+':'+mi;})(this);">Schedule</button>
                        </div>
                        <div class="schedule-picker">
                          <label>Send at:</label>
                          <input type="datetime-local" class="schedule-datetime">
                        </div>
                        <div class="send-actions">
                          <button class="send-btn send-now-btn" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}btn.disabled=true;btn.textContent='Sending...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_send_note_to_devices',{targets:targets.join(','),title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}'});}setTimeout(function(){btn.disabled=false;btn.textContent='Send Now';sec.classList.remove('show');},2000);})(this);">Send Now</button>
                          <button class="send-btn schedule-btn" style="display:none;background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}var dt=sec.querySelector('.schedule-datetime').value;if(!dt){alert('Please select a date and time');return;}var scheduled=new Date(dt);if(scheduled<=new Date()){alert('Please select a future time');return;}btn.disabled=true;btn.textContent='Scheduling...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_schedule_note',{note_id:'{{ note_id }}',title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}',targets:targets.join(','),scheduled_time:scheduled.toISOString()});}setTimeout(function(){btn.disabled=false;btn.textContent='Schedule';sec.classList.remove('show');},2000);})(this);">Schedule</button>
                        </div>
                        {% if note_schedules.count > 0 %}
                        <div class="pending-schedules">
                          <h5>üìÖ Pending Scheduled Sends</h5>
                          {% for sched in note_schedules.items %}
                          <div class="pending-item">
                            <div class="pending-item-info">
                              <div class="pending-item-time">‚è∞ {{ as_timestamp(sched.time) | timestamp_custom('%b %d at %I:%M %p') }}</div>
                              <div style="font-size:0.8em;color:var(--secondary-text-color);">üì± {{ sched.targets | replace('notify.mobile_app_', '') }}</div>
                            </div>
                            <button class="pending-cancel-btn" onclick="if(confirm('Cancel this scheduled send?')){this.disabled=true;this.textContent='...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_cancel_scheduled_note',{schedule_id:'{{ sched.id }}'});}}">Cancel</button>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}
                      </div>
                      <div class="note-edit-section">
                        <h4>Edit Note</h4>
                        <input type="text" class="edit-title" value="{{ state.state | e }}" placeholder="Title">
                        <div class="format-toggle">
                          <button class="format-btn {{ '' if is_markdown else 'active' }}" data-format="html" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">HTML</button>
                          <button class="format-btn {{ 'active' if is_markdown else '' }}" data-format="md" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Markdown</button>
                        </div>
                        <textarea class="edit-content" placeholder="Note content...">{{ edit_content | e }}</textarea>
                        <div class="edit-images">
                          <h5>Images</h5>
                          {% if img_count > 0 %}
                          <div class="note-image-gallery">
                            {% for img in images %}
                            <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                              <img src="{{ img.url }}" loading="lazy" alt="">
                              <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='üì∑'+(n-1);}}}else{alert(d.error||'Error');}});}">√ó</button>
                            </div>
                            {% endfor %}
                          </div>
                          {% endif %}
                          <label class="edit-upload-label">üì§ Add Image<input type="file" accept="image/*" onchange="var input=this,card=input.closest('.note-card'),editImages=input.closest('.edit-images'),status=editImages.querySelector('.upload-status'),maxBytes=15*1024*1024;if(input.files[0]){status.textContent='Processing...';var file=input.files[0];var doUpload=function(blob,fname){status.textContent='Uploading...';var fd=new FormData();fd.append('note_id','{{ note_id }}');fd.append('file',blob,fname);var token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd}).then(function(r){return r.json();}).then(function(d){if(d.success){status.textContent='Done!';var gallery=editImages.querySelector('.note-image-gallery');if(!gallery){gallery=document.createElement('div');gallery.className='note-image-gallery';editImages.insertBefore(gallery,editImages.querySelector('.edit-upload-label'));}var thumb=document.createElement('div');thumb.className='note-image-thumb';var timg=document.createElement('img');timg.src=d.image.url;timg.loading='lazy';thumb.appendChild(timg);thumb.onclick=function(){var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display='none';};document.body.appendChild(lb);}lb.querySelector('img').src=d.image.url;lb.style.display='flex';};gallery.appendChild(thumb);var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;badge.textContent='üì∑'+(n+1);}else{badge=document.createElement('span');badge.className='image-count';badge.textContent='üì∑1';card.querySelector('.note-title').appendChild(badge);}setTimeout(function(){status.textContent='';},1500);}else{status.textContent='Error: '+(d.error||'Unknown');}}).catch(function(e){status.textContent='Error';});};if(file.size<=maxBytes){doUpload(file,file.name);}else{var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.width,h=img.height,q=0.9,sc=1;var tryIt=function(){canvas.width=w*sc;canvas.height=h*sc;ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(blob){if(blob.size<=maxBytes||q<0.1){doUpload(blob,file.name.replace(/\.[^.]+$/,'.jpg'));}else{q-=0.1;if(q<0.5)sc*=0.8;tryIt();}},'image/jpeg',q);};tryIt();};img.src=e.target.result;};reader.readAsDataURL(file);}input.value='';}"></label>
                          <div class="upload-status"></div>
                        </div>
                        <div class="edit-actions">
                          <button class="edit-save-btn" onclick="(function(btn){var sec=btn.closest('.note-edit-section');var t=sec.querySelector('.edit-title').value;var c=sec.querySelector('.edit-content').value;var formatBtn=sec.querySelector('.format-btn.active');var isMd=formatBtn&&formatBtn.dataset.format==='md';if(!t.trim()){alert('Title is required');return;}if(isMd){c='<!--MD-->'+c;}else{c=c.replace(/^<!--MD-->/,'');}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('jottick','update_note',{note_id:'{{ note_id }}',title:t,content:c});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="edit-cancel-btn" onclick="this.closest('.note-edit-section').classList.remove('show');">Cancel</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .notes-container { padding: 4px; }
                .note-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 16px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  transition: box-shadow 0.2s;
                }
                .note-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
                .note-title {
                  font-size: 1.4em;
                  font-weight: 600;
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  padding-bottom: 8px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .note-content {
                  color: var(--primary-text-color);
                  margin-bottom: 12px;
                  white-space: inherit;
                  line-height: 1.6;
                  font-size: 1em;
                }
                .note-content.markdown { white-space: normal; }
                .note-content.markdown h1 { font-size: 1.6em; margin: 0.5em 0; border-bottom: 1px solid var(--divider-color); padding-bottom: 0.3em; }
                .note-content.markdown h2 { font-size: 1.4em; margin: 0.5em 0; }
                .note-content.markdown h3 { font-size: 1.2em; margin: 0.5em 0; }
                .note-content.markdown p { margin: 0.5em 0; }
                .note-content.markdown ul, .note-content.markdown ol { margin: 0.5em 0; padding-left: 1.5em; }
                .note-content.markdown li { margin: 0.25em 0; }
                .note-content.markdown code { background: var(--secondary-background-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
                .note-content.markdown pre { background: var(--secondary-background-color); padding: 12px; border-radius: 6px; overflow-x: auto; }
                .note-content.markdown pre code { background: none; padding: 0; }
                .note-content.markdown blockquote { border-left: 3px solid var(--primary-color); margin: 0.5em 0; padding-left: 1em; color: var(--secondary-text-color); }
                .note-content.markdown a { color: var(--primary-color); }
                .note-content.markdown strong { font-weight: 600; }
                .note-content.markdown em { font-style: italic; }
                .note-content.markdown hr { border: none; border-top: 1px solid var(--divider-color); margin: 1em 0; }
                .note-timestamp {
                  font-size: 0.85em;
                  color: var(--secondary-text-color);
                  font-style: italic;
                  text-align: right;
                }
                .note-image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; margin: 10px 0; }
                .note-image-thumb { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; cursor: pointer; background: var(--secondary-background-color); }
                .note-image-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .note-image-thumb:hover { opacity: 0.9; }
                .note-image-thumb .img-del { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; opacity: 0; transition: opacity 0.2s; line-height: 1; padding: 0; }
                .note-image-thumb:hover .img-del { opacity: 1; }
                .image-count { display: inline-block; padding: 1px 6px; background: var(--primary-color); color: white; border-radius: 8px; font-size: 0.7em; margin-left: 6px; vertical-align: middle; }
                .format-badge { display: inline-block; padding: 1px 6px; background: var(--secondary-background-color); color: var(--secondary-text-color); border-radius: 8px; font-size: 0.65em; margin-left: 6px; vertical-align: middle; text-transform: uppercase; }
                .edit-images { margin: 10px 0; padding: 10px; background: var(--card-background-color); border-radius: 6px; }
                .edit-images h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .edit-upload-label { display: inline-block; padding: 6px 12px; background: var(--primary-color); color: white; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
                .edit-upload-label input { display: none; }
                .upload-status { font-size: 0.8em; color: var(--primary-color); margin-top: 6px; min-height: 16px; }
                .create-img-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
                .create-img-preview .preview-thumb { position: relative; width: 60px; height: 60px; border-radius: 6px; overflow: hidden; }
                .create-img-preview .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
                .create-img-preview .preview-thumb button { position: absolute; top: 2px; right: 2px; width: 18px; height: 18px; background: rgba(220,38,38,0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; padding: 0; }
                .note-send-section, .note-edit-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: var(--secondary-background-color);
                  border: 1px solid var(--divider-color);
                  border-radius: 8px;
                  display: none;
                }
                .note-send-section.show, .note-edit-section.show { display: block; }
                .note-send-section h4, .note-edit-section h4 { margin: 0 0 12px 0; color: var(--primary-text-color); }
                .send-targets { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
                .send-targets label { display: flex; align-items: center; gap: 4px; font-size: 0.9em; cursor: pointer; }
                .send-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .send-mode-tabs { display: flex; gap: 0; margin-bottom: 12px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); }
                .send-mode-tab { flex: 1; padding: 8px 12px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.9em; transition: all 0.2s; }
                .send-mode-tab.active { background: var(--primary-color); color: white; }
                .send-mode-tab:hover:not(.active) { background: var(--divider-color); }
                .schedule-picker { display: none; margin: 12px 0; padding: 12px; background: var(--card-background-color); border-radius: 6px; }
                .schedule-picker.show { display: block; }
                .schedule-picker label { display: block; font-size: 0.85em; color: var(--secondary-text-color); margin-bottom: 4px; }
                .schedule-picker input[type="datetime-local"] { width: 100%; padding: 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 1em; box-sizing: border-box; }
                .send-actions { display: flex; gap: 8px; flex-wrap: wrap; }
                .note-edit-section input[type="text"] { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section textarea { width: 100%; min-height: 120px; padding: 8px; border: 1px solid var(--divider-color); border-radius: 4px; resize: vertical; font-family: inherit; background: var(--card-background-color); color: var(--primary-text-color); box-sizing: border-box; }
                .note-edit-section .edit-actions { display: flex; gap: 8px; margin-top: 8px; }
                .note-edit-section .edit-save-btn { padding: 8px 16px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .note-edit-section .edit-cancel-btn { padding: 8px 16px; background: var(--card-background-color); color: var(--primary-text-color); border: 1px solid var(--divider-color); border-radius: 4px; cursor: pointer; }
                .send-btn-wrapper { position: relative; display: inline-block; }
                .send-badge { position: absolute; top: -6px; right: -6px; background: var(--error-color, #dc2626); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
                .pending-schedules { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--divider-color); }
                .pending-schedules h5 { margin: 0 0 8px 0; font-size: 0.9em; color: var(--secondary-text-color); }
                .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--card-background-color); border-radius: 6px; margin-bottom: 6px; font-size: 0.85em; }
                .pending-item-info { color: var(--primary-text-color); }
                .pending-item-time { color: var(--secondary-text-color); font-size: 0.9em; }
                .pending-cancel-btn { padding: 4px 10px; background: var(--error-color, #dc2626); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
                .format-toggle { display: flex; gap: 0; margin-bottom: 10px; border-radius: 6px; overflow: hidden; border: 1px solid var(--divider-color); width: fit-content; }
                .format-toggle button { padding: 6px 14px; background: var(--card-background-color); color: var(--primary-text-color); border: none; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
                .format-toggle button.active { background: var(--primary-color); color: white; }
                .format-toggle button:hover:not(.active) { background: var(--divider-color); }
              </style>
              <div class="notes-container">
                {% set ns = namespace(count=0, notes=[]) %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% set all_schedules = state_attr('sensor.jottick_scheduled_notes', 'schedules') or {} %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Note:') and state.state != 'unavailable' %}
                    {% set ns.notes = ns.notes + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.notes | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set note_id = state_attr(state.entity_id, 'note_id') %}
                    {% set raw_content = state_attr(state.entity_id, 'content') | default('') %}
                    {% set is_markdown = raw_content.startswith('<!--MD-->') %}
                    {% set is_encrypted = raw_content.startswith('<!--ENC:') %}
                    {% set edit_content = raw_content.replace('<!--MD-->', '') if is_markdown else raw_content %}
                    {% set display_content = edit_content %}
                    {% if is_markdown and not is_encrypted %}
                      {% set display_content = display_content | regex_replace('\\*\\*(.+?)\\*\\*', '<strong>\\1</strong>') %}
                      {% set display_content = display_content | regex_replace('(?<![*])\\*([^*]+)\\*(?![*])', '<em>\\1</em>') %}
                      {% set display_content = display_content | regex_replace('`([^`]+)`', '<code style="background:var(--secondary-background-color);padding:2px 6px;border-radius:4px;font-family:monospace;">\\1</code>') %}
                      {% set display_content = display_content | regex_replace('(?m)^### (.+)$', '<h3 style="font-size:1.2em;margin:0.5em 0;">\\1</h3>') %}
                      {% set display_content = display_content | regex_replace('(?m)^## (.+)$', '<h2 style="font-size:1.4em;margin:0.5em 0;">\\1</h2>') %}
                      {% set display_content = display_content | regex_replace('(?m)^# (.+)$', '<h1 style="font-size:1.6em;margin:0.5em 0;border-bottom:1px solid var(--divider-color);padding-bottom:0.3em;">\\1</h1>') %}
                      {% set display_content = display_content | regex_replace('(?m)^- (.+)$', '<li style="margin-left:1.5em;">\\1</li>') %}
                      {% set display_content = display_content | regex_replace('(?m)^> (.+)$', '<blockquote style="border-left:3px solid var(--primary-color);margin:0.5em 0;padding-left:1em;color:var(--secondary-text-color);">\\1</blockquote>') %}
                      {% set display_content = display_content | regex_replace('\\[([^\\]]+)\\]\\(([^)]+)\\)', '<a href="\\2" style="color:var(--primary-color);">\\1</a>') %}
                      {% set display_content = display_content | regex_replace('(?m)^---$', '<hr style="border:none;border-top:1px solid var(--divider-color);margin:1em 0;">') %}
                    {% endif %}
                    {% set images = state_attr(state.entity_id, 'images') or [] %}
                    {% set img_count = images | length %}
                    {% set note_schedules = namespace(items=[], count=0) %}
                    {% for sched_id, sched in all_schedules.items() %}
                      {% if sched.note_id == note_id %}
                        {% set note_schedules.items = note_schedules.items + [{'id': sched_id, 'time': sched.scheduled_time, 'targets': sched.targets}] %}
                        {% set note_schedules.count = note_schedules.count + 1 %}
                      {% endif %}
                    {% endfor %}
                    <div class="note-card" data-noteid="{{ note_id }}" data-format="{{ 'md' if is_markdown else 'html' }}" data-encrypted="{{ 'true' if is_encrypted else 'false' }}" data-raw="{{ raw_content | e }}">
                      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
                        <div class="note-title" style="flex-grow:1; margin-bottom:0; padding-bottom:8px; border-bottom:none;">{{ state.state }}{% if img_count > 0 %}<span class="image-count">üì∑{{ img_count }}</span>{% endif %}{% if is_markdown %}<span class="format-badge">MD</span>{% endif %}{% if is_encrypted %}<span class="format-badge" style="background:var(--warning-color,#f59e0b);">üîí</span>{% endif %}</div>
                        <div style="display:flex;gap:4px;">
                          {% if not is_encrypted %}
                          <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-edit-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-send-section');if(sec)sec.classList.remove('show');}})(this);" title="Edit note">Edit</button>
                          <div class="send-btn-wrapper">
                            <button style="padding:4px 12px; background:var(--primary-color); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="(function(btn){var panel=btn.closest('.note-card').querySelector('.note-send-section');if(panel){panel.classList.toggle('show');var sec=btn.closest('.note-card').querySelector('.note-edit-section');if(sec)sec.classList.remove('show');}})(this);" title="Send to device">Send</button>
                            {% if note_schedules.count > 0 %}<span class="send-badge">{{ note_schedules.count }}</span>{% endif %}
                          </div>
                          {% endif %}
                          <button style="padding:4px 12px; background:var(--error-color, #ff5555); color:var(--text-primary-color, white); border:none; border-radius:4px; cursor:pointer; font-size:0.85em;" onclick="if(confirm('Delete {{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}?')){this.disabled=true; const el=document.querySelector('home-assistant'); if(el&&el.hass){el.hass.callService('script','jottick_delete_note_with_schedules',{note_id:'{{ note_id }}'});}}">Delete
                        </div>
                      </div>
                      {% if is_encrypted %}
                      <div class="note-locked" style="text-align:center;padding:20px;">
                        <div style="font-size:3em;margin-bottom:10px;">üîí</div>
                        <div style="color:var(--secondary-text-color);margin-bottom:15px;">This note is encrypted</div>
                        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                          <input type="password" class="unlock-password" placeholder="Enter password" style="padding:8px 12px;border:1px solid var(--divider-color);border-radius:4px;background:var(--card-background-color);color:var(--primary-text-color);width:180px;">
                          <button class="unlock-btn" style="padding:8px 16px;background:var(--primary-color);color:white;border:none;border-radius:4px;cursor:pointer;" onclick="(function(btn){var card=btn.closest('.note-card'),raw=card.dataset.raw,pwInput=card.querySelector('.unlock-password'),pw=pwInput.value,contentDiv=card.querySelector('.note-content'),lockedDiv=card.querySelector('.note-locked');if(!pw){alert('Enter password');return;}btn.disabled=true;btn.textContent='Decrypting...';try{var LT=String.fromCharCode(60),GT=String.fromCharCode(62),AMP=String.fromCharCode(38);var decoded=raw.split(AMP+'lt;').join(LT).split(AMP+'gt;').join(GT).split(AMP+'amp;').join(AMP).split(AMP+'quot;').join(String.fromCharCode(34));var encStart=LT+'!--ENC:';var idx=decoded.indexOf(encStart);if(idx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format');return;}var rest=decoded.substring(idx+encStart.length);var colonIdx=rest.indexOf(':');var dashIdx=rest.indexOf('--'+GT);if(colonIdx==-1||dashIdx==-1){btn.textContent='Unlock';btn.disabled=false;alert('Invalid format 2');return;}var saltB64=rest.substring(0,colonIdx);var ivB64=rest.substring(colonIdx+1,dashIdx);var cipherB64=rest.substring(dashIdx+3);var b64d=function(s){return Uint8Array.from(atob(s),function(c){return c.charCodeAt(0);});};var salt=b64d(saltB64),iv=b64d(ivB64),ciphertext=b64d(cipherB64);var enc=new TextEncoder();crypto.subtle.importKey('raw',enc.encode(pw),'PBKDF2',false,['deriveBits','deriveKey']).then(function(km){return crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['decrypt']);}).then(function(key){return crypto.subtle.decrypt({name:'AES-GCM',iv:iv},key,ciphertext);}).then(function(dec){var text=new TextDecoder().decode(dec);lockedDiv.style.display='none';contentDiv.style.display='block';contentDiv.textContent=text;btn.textContent='Unlock';btn.disabled=false;}).catch(function(e){btn.textContent='Unlock';btn.disabled=false;alert('Wrong password');});}catch(e){btn.textContent='Unlock';btn.disabled=false;alert('Error: '+e);}})(this);">Unlock</button>
                        </div>
                      </div>
                      <div class="note-content" style="display:none;"></div>
                      {% else %}
                      <div class="note-content">{{ display_content }}</div>
                      {% endif %}
                      {% if img_count > 0 %}
                      <div class="note-image-gallery">
                        {% for img in images %}
                        <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                          <img src="{{ img.url }}" loading="lazy" alt="">
                          <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='üì∑'+(n-1);}}}else{alert(d.error||'Error');}});}">√ó</button>
                        </div>
                        {% endfor %}
                      </div>
                      {% endif %}
                      <div class="note-timestamp">
                        Updated {{ relative_time(strptime(state_attr(state.entity_id, 'updated'), '%Y-%m-%dT%H:%M:%S.%fZ')) }} ago
                      </div>
                      <div class="note-send-section">
                        <h4>Send Note</h4>
                        <div class="send-targets">
                          {% for n in notifiers %}{% if n != 'Nobody' %}
                          <label><input type="checkbox" class="send-target-cb" value="{{ n }}"><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                          {% endif %}{% endfor %}
                        </div>
                        <div class="send-mode-tabs">
                          <button class="send-mode-tab active" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.remove('show');sec.querySelector('.send-now-btn').style.display='inline-block';sec.querySelector('.schedule-btn').style.display='none';})(this);">Send Now</button>
                          <button class="send-mode-tab" onclick="(function(btn){var sec=btn.closest('.note-send-section');sec.querySelectorAll('.send-mode-tab').forEach(function(t){t.classList.remove('active');});btn.classList.add('active');sec.querySelector('.schedule-picker').classList.add('show');sec.querySelector('.send-now-btn').style.display='none';sec.querySelector('.schedule-btn').style.display='inline-block';var picker=sec.querySelector('.schedule-datetime');var now=new Date();now.setMinutes(now.getMinutes()+30);var y=now.getFullYear(),m=String(now.getMonth()+1).padStart(2,'0'),d=String(now.getDate()).padStart(2,'0'),h=String(now.getHours()).padStart(2,'0'),mi=String(now.getMinutes()).padStart(2,'0');picker.value=y+'-'+m+'-'+d+'T'+h+':'+mi;})(this);">Schedule</button>
                        </div>
                        <div class="schedule-picker">
                          <label>Send at:</label>
                          <input type="datetime-local" class="schedule-datetime">
                        </div>
                        <div class="send-actions">
                          <button class="send-btn send-now-btn" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}btn.disabled=true;btn.textContent='Sending...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_send_note_to_devices',{targets:targets.join(','),title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}'});}setTimeout(function(){btn.disabled=false;btn.textContent='Send Now';sec.classList.remove('show');},2000);})(this);">Send Now</button>
                          <button class="send-btn schedule-btn" style="display:none;background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.note-send-section');var targets=Array.from(sec.querySelectorAll('.send-target-cb:checked')).map(function(cb){return cb.value;});if(!targets.length){alert('Select at least one device');return;}var dt=sec.querySelector('.schedule-datetime').value;if(!dt){alert('Please select a date and time');return;}var scheduled=new Date(dt);if(scheduled<=new Date()){alert('Please select a future time');return;}btn.disabled=true;btn.textContent='Scheduling...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_schedule_note',{note_id:'{{ note_id }}',title:'{{ state.state | replace('"', '&quot;') | replace("'", "\\'") }}',message:'{{ display_content | replace("\n", " ") | replace('"', '&quot;') | replace("'", "\\'") | truncate(200) }}',targets:targets.join(','),scheduled_time:scheduled.toISOString()});}setTimeout(function(){btn.disabled=false;btn.textContent='Schedule';sec.classList.remove('show');},2000);})(this);">Schedule</button>
                        </div>
                        {% if note_schedules.count > 0 %}
                        <div class="pending-schedules">
                          <h5>üìÖ Pending Scheduled Sends</h5>
                          {% for sched in note_schedules.items %}
                          <div class="pending-item">
                            <div class="pending-item-info">
                              <div class="pending-item-time">‚è∞ {{ as_timestamp(sched.time) | timestamp_custom('%b %d at %I:%M %p') }}</div>
                              <div style="font-size:0.8em;color:var(--secondary-text-color);">üì± {{ sched.targets | replace('notify.mobile_app_', '') }}</div>
                            </div>
                            <button class="pending-cancel-btn" onclick="if(confirm('Cancel this scheduled send?')){this.disabled=true;this.textContent='...';var el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_cancel_scheduled_note',{schedule_id:'{{ sched.id }}'});}}">Cancel</button>
                          </div>
                          {% endfor %}
                        </div>
                        {% endif %}
                      </div>
                      <div class="note-edit-section">
                        <h4>Edit Note</h4>
                        <input type="text" class="edit-title" value="{{ state.state | e }}" placeholder="Title">
                        <div class="format-toggle">
                          <button class="format-btn {{ '' if is_markdown else 'active' }}" data-format="html" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">HTML</button>
                          <button class="format-btn {{ 'active' if is_markdown else '' }}" data-format="md" onclick="this.parentElement.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active');">Markdown</button>
                        </div>
                        <textarea class="edit-content" placeholder="Note content...">{{ edit_content | e }}</textarea>
                        <div class="edit-images">
                          <h5>Images</h5>
                          {% if img_count > 0 %}
                          <div class="note-image-gallery">
                            {% for img in images %}
                            <div class="note-image-thumb" onclick="var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display=&quot;none&quot;;};document.body.appendChild(lb);}lb.querySelector('img').src='{{ img.url }}';lb.style.display='flex';">
                              <img src="{{ img.url }}" loading="lazy" alt="">
                              <button class="img-del" onclick="event.stopPropagation();if(confirm('Delete image?')){var btn=this,thumb=btn.closest('.note-image-thumb'),card=btn.closest('.note-card'),token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/delete-image',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({note_id:'{{ note_id }}',image_id:'{{ img.id }}'})}).then(function(r){return r.json();}).then(function(d){if(d.success){thumb.remove();var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;if(n<=1){badge.remove();}else{badge.textContent='üì∑'+(n-1);}}}else{alert(d.error||'Error');}});}">√ó</button>
                            </div>
                            {% endfor %}
                          </div>
                          {% endif %}
                          <label class="edit-upload-label">üì§ Add Image<input type="file" accept="image/*" onchange="var input=this,card=input.closest('.note-card'),editImages=input.closest('.edit-images'),status=editImages.querySelector('.upload-status'),maxBytes=15*1024*1024;if(input.files[0]){status.textContent='Processing...';var file=input.files[0];var doUpload=function(blob,fname){status.textContent='Uploading...';var fd=new FormData();fd.append('note_id','{{ note_id }}');fd.append('file',blob,fname);var token=document.querySelector('home-assistant').hass.auth.data.access_token;fetch('/api/jottick/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd}).then(function(r){return r.json();}).then(function(d){if(d.success){status.textContent='Done!';var gallery=editImages.querySelector('.note-image-gallery');if(!gallery){gallery=document.createElement('div');gallery.className='note-image-gallery';editImages.insertBefore(gallery,editImages.querySelector('.edit-upload-label'));}var thumb=document.createElement('div');thumb.className='note-image-thumb';var timg=document.createElement('img');timg.src=d.image.url;timg.loading='lazy';thumb.appendChild(timg);thumb.onclick=function(){var lb=document.getElementById('jottick-lb');if(!lb){lb=document.createElement('div');lb.id='jottick-lb';lb.style.cssText='display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:999999;justify-content:center;align-items:center;cursor:pointer;';lb.innerHTML='<img style=&quot;max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;&quot;>';lb.onclick=function(){lb.style.display='none';};document.body.appendChild(lb);}lb.querySelector('img').src=d.image.url;lb.style.display='flex';};gallery.appendChild(thumb);var badge=card.querySelector('.note-title .image-count');if(badge){var n=parseInt(badge.textContent.replace(/[^0-9]/g,''))||0;badge.textContent='üì∑'+(n+1);}else{badge=document.createElement('span');badge.className='image-count';badge.textContent='üì∑1';card.querySelector('.note-title').appendChild(badge);}setTimeout(function(){status.textContent='';},1500);}else{status.textContent='Error: '+(d.error||'Unknown');}}).catch(function(e){status.textContent='Error';});};if(file.size<=maxBytes){doUpload(file,file.name);}else{var reader=new FileReader();reader.onload=function(e){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.width,h=img.height,q=0.9,sc=1;var tryIt=function(){canvas.width=w*sc;canvas.height=h*sc;ctx.drawImage(img,0,0,canvas.width,canvas.height);canvas.toBlob(function(blob){if(blob.size<=maxBytes||q<0.1){doUpload(blob,file.name.replace(/\.[^.]+$/,'.jpg'));}else{q-=0.1;if(q<0.5)sc*=0.8;tryIt();}},'image/jpeg',q);};tryIt();};img.src=e.target.result;};reader.readAsDataURL(file);}input.value='';}"></label>
                          <div class="upload-status"></div>
                        </div>
                        <div class="edit-actions">
                          <button class="edit-save-btn" onclick="(function(btn){var sec=btn.closest('.note-edit-section');var t=sec.querySelector('.edit-title').value;var c=sec.querySelector('.edit-content').value;var formatBtn=sec.querySelector('.format-btn.active');var isMd=formatBtn&&formatBtn.dataset.format==='md';if(!t.trim()){alert('Title is required');return;}if(isMd){c='<!--MD-->'+c;}else{c=c.replace(/^<!--MD-->/,'');}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('jottick','update_note',{note_id:'{{ note_id }}',title:t,content:c});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="edit-cancel-btn" onclick="this.closest('.note-edit-section').classList.remove('show');">Cancel</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
  - title: Lists
    path: lists
    icon: mdi:format-list-checks
    sections:
      - type: grid
        cards:
          - type: entities
            title: New List
            entities:
              - entity: input_text.jottick_checklist_title
                name: Title
            footer:
              type: buttons
              entities:
                - entity: script.jottick_create_checklist
                  name: Create
                  icon: mdi:plus-circle
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                @keyframes slideDown { from {top:40px;opacity:0;} to {top:60px;opacity:1;} }
                #jottick-loading-lists {
                  display:none;
                  position:fixed;
                  top:60px;
                  left:50%;
                  transform:translateX(-50%);
                  z-index:9999;
                  background:var(--success-color);
                  color:var(--text-primary-color, white);
                  padding:12px 24px;
                  border-radius:8px;
                  box-shadow:0 4px 12px rgba(0,0,0,0.3);
                  font-weight:600;
                  animation:slideDown 0.3s ease;
                }
                .lists-container { padding: 4px; }
                .list-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .list-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .list-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .list-progress {
                  font-size: 0.9em;
                  background:var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .list-items { margin-top: 12px; }
                .list-item {
                  display: flex;
                  align-items: center;
                  padding: 8px;
                  margin-bottom: 8px;
                  background: var(--secondary-background-color, var(--secondary-background-color));
                  border-radius: 8px;
                  gap: 12px;
                  transition: opacity 0.2s;
                }
                .list-item:hover { background: var(--divider-color, var(--divider-color)); }
                .item-checkbox { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; }
                .item-checkbox:disabled { cursor: wait; }
                .item-text { flex-grow: 1; color: var(--primary-text-color); font-size: 1em; }
                .item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .add-item-section {
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 1px solid var(--divider-color);
                  display: flex;
                  gap: 8px;
                }
                .add-item-input {
                  flex-grow: 1;
                  padding: 8px 12px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                  font-size: 1em;
                }
                .add-item-btn {
                  padding: 8px 16px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.9em;
                }
                .add-item-btn:hover { opacity: 0.9; }
                .add-item-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .delete-list-btn {
                  padding: 4px 12px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85em;
                }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                .reminder-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1)));
                  border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color, #ff5555); color: white; border: none; border-radius: 4px; cursor: pointer; }
              </style>
              <div id="jottick-loading-lists">Loading...</div>
              <script>
                (function checkLoading(){
                  var banner=document.getElementById('jottick-loading-lists');
                  if(banner){
                    var el=document.querySelector('home-assistant');
                    if(el&&el.hass&&el.hass.states['input_boolean.jottick_is_loading']){
                      var state=el.hass.states['input_boolean.jottick_is_loading'].state;
                      banner.style.display=state==='on'?'block':'none';
                    }
                  }
                  setTimeout(checkLoading,300);
                })();
              </script>
              <div class="lists-container">
                {% set ns = namespace(count=0, lists=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick List:') and state.state != 'unavailable' %}
                    {% set list_type = state_attr(state.entity_id, 'type') %}
                    {% if list_type != 'task' %}
                      {% set ns.lists = ns.lists + [state] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.lists | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set list_id = state_attr(state.entity_id, 'checklist_id') %}
                    {% set list_title = state_attr(state.entity_id, 'title') %}
                    {% set items = state_attr(state.entity_id, 'items') or [] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and list_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and list_id in recurring_configs %}
                    {% set config = reminder_configs.get(list_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(list_id, {}) if recurring_configs is mapping else {} %}
                    <div class="list-card">
                      <div class="list-header">
                        <div class="list-title">{{ list_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Recurring</button>
                          <div class="list-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      <div class="list-items">
                        {% for item in items %}
                          <div class="list-item">
                            <input type="checkbox" class="item-checkbox" {{ 'checked' if item.completed else '' }} onchange="(function(cb){cb.disabled=true;cb.parentElement.style.opacity='0.5';const act=cb.checked?'check':'uncheck';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||{{ loop.index0 }}|||'+act});}setTimeout(function(){cb.disabled=false;cb.parentElement.style.opacity='1';},1000);})(this);">
                            <span class="item-text {{ 'completed' if item.completed else '' }}">{{ item.text }}</span>
                            <button style="padding:2px 8px;background:var(--error-color, #ff5555);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="if(confirm('Delete this item?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_delete_item_data',value:'{{ list_id }}|||{{ loop.index0 }}'});}})(this);}">Delete
                          </div>
                        {% endfor %}
                      </div>
                      <div class="add-item-section">
                        <input type="text" class="add-item-input" placeholder="Add new item...">
                        <button class="add-item-btn" onclick="(function(btn){const inp=btn.previousElementSibling;if(!inp.value.trim()){inp.placeholder='Type something first!';setTimeout(function(){inp.placeholder='Add new item...';},2000);return;}const txt=inp.value.trim();inp.value='';inp.placeholder='Adding...';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||add|||'+txt});}setTimeout(function(){inp.placeholder='Add new item...';btn.disabled=false;},2000);})(this);">Add Item</button>
                        <button class="delete-list-btn" onclick="if(confirm('Delete {{ list_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||delete'});}})(this);}">Delete
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notifications</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ list_id }}',item_type:'checklist',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save Notification';sec.classList.remove('show');},1500);})(this);">Save Notification</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ list_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ list_id }}',item_type:'checklist',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ list_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .lists-container { padding: 4px; }
                .list-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .list-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .list-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .list-progress {
                  font-size: 0.9em;
                  background: var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .list-items { margin-top: 12px; }
                .list-item {
                  display: flex;
                  align-items: center;
                  padding: 8px;
                  margin-bottom: 8px;
                  background: var(--secondary-background-color, var(--secondary-background-color));
                  border-radius: 8px;
                  gap: 12px;
                  transition: opacity 0.2s;
                }
                .list-item:hover { background: var(--divider-color, var(--divider-color)); }
                .item-checkbox { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; }
                .item-checkbox:disabled { cursor: wait; }
                .item-text { flex-grow: 1; color: var(--primary-text-color); font-size: 1em; }
                .item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .add-item-section {
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 1px solid var(--divider-color);
                  display: flex;
                  gap: 8px;
                }
                .add-item-input {
                  flex-grow: 1;
                  padding: 8px 12px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                  font-size: 1em;
                }
                .add-item-btn {
                  padding: 8px 16px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.9em;
                }
                .add-item-btn:hover { opacity: 0.9; }
                .add-item-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                .delete-list-btn {
                  padding: 4px 12px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.85em;
                }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                .reminder-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1)));
                  border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color, #ff5555); color: white; border: none; border-radius: 4px; cursor: pointer; }
              </style>
              <div class="lists-container">
                {% set ns = namespace(count=0, lists=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick List:') and state.state != 'unavailable' %}
                    {% set list_type = state_attr(state.entity_id, 'type') %}
                    {% if list_type != 'task' %}
                      {% set ns.lists = ns.lists + [state] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.lists | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set list_id = state_attr(state.entity_id, 'checklist_id') %}
                    {% set list_title = state_attr(state.entity_id, 'title') %}
                    {% set items = state_attr(state.entity_id, 'items') or [] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and list_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and list_id in recurring_configs %}
                    {% set config = reminder_configs.get(list_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(list_id, {}) if recurring_configs is mapping else {} %}
                    <div class="list-card">
                      <div class="list-header">
                        <div class="list-title">{{ list_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.list-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Reset</button>
                          <div class="list-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      <div class="list-items">
                        {% for item in items %}
                          <div class="list-item">
                            <input type="checkbox" class="item-checkbox" {{ 'checked' if item.completed else '' }} onchange="(function(cb){cb.disabled=true;cb.parentElement.style.opacity='0.5';const act=cb.checked?'check':'uncheck';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||{{ loop.index0 }}|||'+act});}setTimeout(function(){cb.disabled=false;cb.parentElement.style.opacity='1';},1000);})(this);">
                            <span class="item-text {{ 'completed' if item.completed else '' }}">{{ item.text }}</span>
                            <button style="padding:2px 8px;background:var(--error-color, #ff5555);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.8em;" onclick="if(confirm('Delete this item?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_delete_item_data',value:'{{ list_id }}|||{{ loop.index0 }}'});}})(this);}">Delete
                          </div>
                        {% endfor %}
                      </div>
                      <div class="add-item-section">
                        <input type="text" class="add-item-input" placeholder="Add new item...">
                        <button class="add-item-btn" onclick="(function(btn){const inp=btn.previousElementSibling;if(!inp.value.trim()){inp.placeholder='Type something first!';setTimeout(function(){inp.placeholder='Add new item...';},2000);return;}const txt=inp.value.trim();inp.value='';inp.placeholder='Adding...';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||add|||'+txt});}setTimeout(function(){inp.placeholder='Add new item...';btn.disabled=false;},2000);})(this);">Add Item</button>
                        <button class="delete-list-btn" onclick="if(confirm('Delete {{ list_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){(function(btn){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_action_data',value:'{{ list_id }}|||delete'});}})(this);}">Delete
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notifications</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ list_id }}',item_type:'checklist',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ list_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ list_id }}',item_type:'checklist',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ list_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
  - title: Tasks
    path: tasks
    icon: mdi:clipboard-list
    sections:
      - type: grid
        cards:
          - type: entities
            title: New Task List
            entities:
              - entity: input_text.jottick_task_title
                name: Title
            footer:
              type: buttons
              entities:
                - entity: script.jottick_create_task
                  name: Create
                  icon: mdi:plus-circle
            grid_options:
              columns: full
              rows: auto
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                @keyframes slideDown { from {top:40px;opacity:0;} to {top:60px;opacity:1;} }
                #jottick-loading-tasks {
                  display:none;
                  position:fixed;
                  top:60px;
                  left:50%;
                  transform:translateX(-50%);
                  z-index:9999;
                  background:var(--primary-color);
                  color:var(--text-primary-color, white);
                  padding:12px 24px;
                  border-radius:8px;
                  box-shadow:0 4px 12px rgba(0,0,0,0.3);
                  font-weight:600;
                  animation:slideDown 0.3s ease;
                }
                .tasks-container { padding: 4px; }
                .task-card {
                  background: var(--ha-card-background));
                  border: 1px solid var(--divider-color, var(--divider-color));
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 20px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .task-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  padding-bottom: 12px;
                  border-bottom: 2px solid var(--primary-color);
                }
                .task-title { font-size: 1.4em; font-weight: 600; color: var(--primary-text-color); }
                .task-progress {
                  font-size: 0.9em;
                  background: var(--primary-color);
                  color: white;
                  padding: 4px 12px;
                  border-radius: 12px;
                }
                .task-items { margin-top: 12px; }
                .task-item {
                  display: flex;
                  align-items: center;
                  padding: 8px;
                  margin-bottom: 4px;
                  background: var(--secondary-background-color, var(--secondary-background-color));
                  border-radius: 8px;
                  gap: 8px;
                }
                .task-item:hover { background: var(--divider-color, var(--divider-color)); }
                .task-item.depth-0 { margin-left: 0; border-left: 3px solid var(--success-color); }
                .task-item.depth-1 { margin-left: 30px; border-left: 3px solid var(--primary-color); }
                .task-item.depth-2 { margin-left: 60px; border-left: 3px solid var(--warning-color); }
                .task-item.depth-3 { margin-left: 90px; border-left: 3px solid var(--info-color); }
                .task-item.depth-4 { margin-left: 120px; border-left: 3px solid var(--accent-color); }
                .task-item.depth-5 { margin-left: 150px; border-left: 3px solid var(--primary-color); }
                .task-item-text { flex-grow: 1; color: var(--primary-text-color); font-size: 1em; }
                .task-item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .task-status-select {
                  padding: 4px 8px;
                  border-radius: 4px;
                  border: 1px solid var(--divider-color);
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                  font-size: 0.85em;
                  cursor: pointer;
                }
                .delete-item-btn {
                  padding: 2px 8px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.8em;
                }
                .add-sub-btn {
                  padding: 2px 6px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 0.75em;
                }
                .add-task-section {
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 1px solid var(--divider-color);
                  display: flex;
                  gap: 8px;
                  flex-wrap: wrap;
                }
                .add-task-input {
                  flex-grow: 1;
                  min-width: 150px;
                  padding: 8px 12px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                }
                .add-task-btn {
                  padding: 8px 16px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                }
                .delete-task-btn {
                  padding: 4px 12px;
                  background: var(--error-color, #ff5555);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                }
                .kanban-btn {
                  padding: 4px 12px;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                }
                .status-todo { border-left: 3px solid var(--warning-color, #ff9800); }
                .status-in_progress { border-left: 3px solid var(--primary-color); }
                .status-completed { border-left: 3px solid var(--success-color); }
                .status-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: var(--secondary-background-color);
                  border-radius: 8px;
                  display: none;
                }
                .status-section.show { display: block; }
                .status-list { margin: 8px 0; }
                .status-item {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  padding: 6px;
                  background: var(--card-background-color);
                  border-radius: 4px;
                  margin-bottom: 4px;
                }
                .status-color {
                  width: 20px;
                  height: 20px;
                  border-radius: 4px;
                  flex-shrink: 0;
                }
                .status-name { flex-grow: 1; font-weight: 500; }
                .status-id { font-size: 0.8em; color: var(--secondary-text-color); }
                .new-status-form {
                  display: flex;
                  gap: 8px;
                  flex-wrap: wrap;
                  margin-top: 8px;
                  padding-top: 8px;
                  border-top: 1px solid var(--divider-color);
                }
                .new-status-form input {
                  padding: 6px 10px;
                  border: 1px solid var(--divider-color);
                  border-radius: 4px;
                  background: var(--card-background-color);
                  color: var(--primary-text-color);
                }
                .new-status-form input[type="color"] {
                  width: 40px;
                  padding: 2px;
                }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
                .reminder-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1)));
                  border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"], .reminder-row input[type="text"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color, #ff5555); color: white; border: none; border-radius: 4px; cursor: pointer; }
              </style>
              <div id="jottick-loading-tasks">Loading...</div>
              <script>
                (function checkLoading(){
                  var banner=document.getElementById('jottick-loading-tasks');
                  if(banner){
                    var el=document.querySelector('home-assistant');
                    if(el&&el.hass&&el.hass.states['input_boolean.jottick_is_loading']){
                      banner.style.display=el.hass.states['input_boolean.jottick_is_loading'].state==='on'?'block':'none';
                    }
                  }
                  setTimeout(checkLoading,300);
                })();
              </script>
              <div class="tasks-container">
                {% set ns = namespace(count=0, tasks=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Task:') and state.state != 'unavailable' %}
                    {% set ns.tasks = ns.tasks + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.tasks | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is odd %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% set flat_items = state_attr(state.entity_id, 'flat_items') or [] %}
                    {% set statuses = state_attr(state.entity_id, 'statuses') or [{'id':'todo','name':'To Do','order':0},{'id':'in_progress','name':'In Progress','order':1},{'id':'completed','name':'Completed','order':2}] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and task_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and task_id in recurring_configs %}
                    {% set config = reminder_configs.get(task_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(task_id, {}) if recurring_configs is mapping else {} %}
                    <div class="task-card">
                      <div class="task-header">
                        <div class="task-title">{{ task_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Recurring</button>
                          <div class="task-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      <div class="task-items">
                        {% for item in flat_items %}
                          {% set index_path = item.index_path | default('0') %}
                          {% set depth = index_path.split('.') | length - 1 %}
                          <div class="task-item depth-{{ depth }} status-{{ item.status }}">
                            <span class="task-item-text {{ 'completed' if item.status == 'completed' else '' }}">{{ item.text }}</span>
                            <select class="task-status-select" onchange="(function(sel){sel.disabled=true;sel.parentElement.style.opacity='0.5';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||status|||'+sel.value});}setTimeout(function(){sel.disabled=false;sel.parentElement.style.opacity='1';},1000);})(this);">
                              {% for status in statuses | sort(attribute='order') %}
                                <option value="{{ status.id }}" {{ 'selected' if item.status == status.id else '' }}>{{ status.name }}</option>
                              {% endfor %}
                            </select>
                            <button class="add-sub-btn" title="Add sub-task" onclick="(function(btn){const txt=prompt('Enter sub-task:');if(txt&&txt.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt.trim()+'|||todo|||{{ index_path }}'});}}})(this);">+</button>
                            <button class="delete-item-btn" onclick="if(confirm('Delete?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||delete_item'});}}">Delete
                          </div>
                        {% endfor %}
                      </div>
                      <div class="add-task-section">
                        <input type="text" class="add-task-input" placeholder="Add new task...">
                        <select class="task-status-select" style="min-width:100px;">
                          {% for status in statuses | sort(attribute='order') %}
                            <option value="{{ status.id }}">{{ status.name }}</option>
                          {% endfor %}
                        </select>
                        <button class="add-task-btn" onclick="(function(btn){const inp=btn.parentElement.querySelector('.add-task-input');const sel=btn.parentElement.querySelector('.task-status-select');if(!inp.value.trim())return;const txt=inp.value.trim();const st=sel.value;inp.value='';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt+'|||'+st});}setTimeout(function(){btn.disabled=false;},2000);})(this);">Add Item</button>
                        <button class="kanban-btn" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.status-section');if(panel){panel.classList.toggle('show');}})(this);">Columns</button>
                        <button class="delete-task-btn" onclick="if(confirm('Delete {{ task_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||delete'});}}">Delete
                      </div>
                      <div class="status-section">
                        <strong>Kanban Task Columns</strong>
                        <div class="status-list">
                          {% for status in statuses | sort(attribute='order') %}
                            <div class="status-item">
                              <div class="status-color" style="background:{{ status.color if status.color else 'var(--secondary-text-color)' }};"></div>
                              <span class="status-name">{{ status.name }}</span>
                              <span class="status-id">({{ status.id }})</span>
                              <button style="padding:2px 6px;background:var(--warning-color, #ff9800);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="(function(btn){const newLabel=prompt('New label:','{{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}');if(newLabel&&newLabel.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'update_status|||{{ task_id }}|||{{ status.id }}|||'+newLabel.trim()});}}})(this);">Edit</button>
                              {% if statuses | length > 1 %}
                              <button style="padding:2px 6px;background:var(--error-color);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="if(confirm('Delete {{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'delete_status|||{{ task_id }}|||{{ status.id }}'});}}">Delete
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        <div class="new-status-form">
                          <input type="text" placeholder="ID (e.g. review)" style="width:100px;" class="new-status-id">
                          <input type="text" placeholder="Label" style="width:120px;" class="new-status-label">
                          <input type="color" value="var(--info-color, #3b82f6)" class="new-status-color">
                          <button class="add-task-btn" style="padding:6px 12px;" onclick="(function(btn){const form=btn.closest('.new-status-form');const idInp=form.querySelector('.new-status-id');const labelInp=form.querySelector('.new-status-label');const colorInp=form.querySelector('.new-status-color');if(!idInp.value.trim()||!labelInp.value.trim()){alert('ID and Label required');return;}btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'create_status|||{{ task_id }}|||'+idInp.value.trim()+'|||'+labelInp.value.trim()+'|||'+colorInp.value});}idInp.value='';labelInp.value='';setTimeout(function(){btn.disabled=false;},2000);})(this);">Add Column</button>
                        </div>
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notifications</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ task_id }}',item_type:'task',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ task_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ task_id }}',item_type:'task',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ task_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
      - type: grid
        cards:
          - type: custom:html-template-card
            ignore_line_breaks: true
            content: |
              <style>
                .tasks-container { padding: 4px; }
                .task-card { background: var(--ha-card-background); border: 1px solid var(--divider-color); border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--primary-color); }
                .task-title { font-size: 1.4em; font-weight: 600; }
                .task-progress { font-size: 0.9em; background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 12px; }
                .task-items { margin-top: 12px; }
                .task-item { display: flex; align-items: center; padding: 8px; margin-bottom: 4px; background: var(--secondary-background-color); border-radius: 8px; gap: 8px; }
                .task-item:hover { background: var(--divider-color); }
                .task-item.depth-0 { margin-left: 0; border-left: 3px solid var(--success-color); }
                .task-item.depth-1 { margin-left: 30px; border-left: 3px solid var(--primary-color); }
                .task-item.depth-2 { margin-left: 60px; border-left: 3px solid var(--warning-color); }
                .task-item.depth-3 { margin-left: 90px; border-left: 3px solid var(--info-color); }
                .task-item.depth-4 { margin-left: 120px; border-left: 3px solid var(--accent-color); }
                .task-item.depth-5 { margin-left: 150px; border-left: 3px solid var(--primary-color); }
                .task-item-text { flex-grow: 1; }
                .task-item-text.completed { text-decoration: line-through; opacity: 0.6; }
                .task-status-select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--divider-color); background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.85em; cursor: pointer; }
                .delete-item-btn { padding: 2px 8px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
                .add-sub-btn { padding: 2px 6px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
                .add-task-section { margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--divider-color); display: flex; gap: 8px; flex-wrap: wrap; }
                .add-task-input { flex-grow: 1; min-width: 150px; padding: 8px 12px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); }
                .add-task-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .delete-task-btn { padding: 4px 12px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .kanban-btn { padding: 4px 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .status-todo { border-left: 3px solid var(--warning-color, #ff9800); }
                .status-in_progress { border-left: 3px solid var(--primary-color); }
                .status-completed { border-left: 3px solid var(--success-color); }
                .status-section { margin-top: 12px; padding: 12px; background: var(--secondary-background-color); border-radius: 8px; display: none; }
                .status-section.show { display: block; }
                .status-list { margin: 8px 0; }
                .status-item { display: flex; align-items: center; gap: 8px; padding: 6px; background: var(--card-background-color); border-radius: 4px; margin-bottom: 4px; }
                .status-color { width: 20px; height: 20px; border-radius: 4px; }
                .status-name { flex-grow: 1; font-weight: 500; }
                .status-id { font-size: 0.8em; color: var(--secondary-text-color); }
                .new-status-form { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--divider-color); }
                .new-status-form input { padding: 6px 10px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); }
                .new-status-form input[type="color"] { width: 40px; padding: 2px; }
                .reminder-section { margin-top: 12px; padding: 12px; background: linear-gradient(135deg, var(--primary-color-translucent, rgba(156,39,176,0.1)), var(--primary-color-translucent, rgba(103,58,183,0.1))); border: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.3)); border-radius: 8px; display: none; }
                .reminder-section.show { display: block; }
                .reminder-section h4 { margin: 0 0 12px 0; color: var(--text-primary-color, #fff); }
                .reminder-row { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center; }
                .reminder-row label { font-size: 0.85em; color: var(--secondary-text-color); min-width: 50px; }
                .reminder-row select, .reminder-row input[type="time"] { padding: 6px 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--card-background-color); color: var(--primary-text-color); font-size: 0.9em; }
                .reminder-row select { min-width: 120px; }
                .reminder-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--primary-color-translucent, rgba(156,39,176,0.2)); }
                .reminder-save-btn { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .reminder-remove-btn { padding: 8px 16px; background: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
                .reminder-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .reminder-btn:hover { background: var(--primary-color-translucent, rgba(156,39,176,0.1)); }
                .reminder-btn.active { color: var(--primary-color); }
                .reminder-btn.inactive { opacity: 0.4; }
                .recurring-btn {
                  background: none;
                  border: none;
                  cursor: pointer;
                  padding: 4px 8px;
                  font-size: 1.1em;
                  border-radius: 4px;
                  transition: all 0.2s;
                }
                .recurring-btn:hover { background: var(--success-color-translucent, rgba(76,175,80,0.1)); }
                .recurring-btn.active { color: var(--success-color); }
                .recurring-btn.inactive { opacity: 0.4; }
                .recurring-section {
                  margin-top: 12px;
                  padding: 12px;
                  background: linear-gradient(135deg, var(--success-color-translucent, rgba(76,175,80,0.1)), var(--success-color-translucent, rgba(56,142,60,0.1)));
                  border: 1px solid var(--success-color-translucent, rgba(76,175,80,0.3));
                  border-radius: 8px;
                  display: none;
                }
                .recurring-section.show { display: block; }
                .recurring-section h4 { margin: 0 0 12px 0; color: var(--success-color); }
                .header-actions {
                  display: flex;
                  align-items: center;
                  gap: 8px;
                }
              </style>
              <div class="tasks-container">
                {% set ns = namespace(count=0, tasks=[]) %}
                {% set reminder_configs = state_attr('sensor.jottick_reminders', 'configs') or {} %}
                {% set recurring_configs = state_attr('sensor.jottick_recurring', 'configs') or {} %}
                {% set notifiers = state_attr('sensor.jottick_available_notifiers', 'notifiers') or ['Nobody'] %}
                {% for state in states.sensor %}
                  {% if state.name.startswith('JotTick Task:') and state.state != 'unavailable' %}
                    {% set ns.tasks = ns.tasks + [state] %}
                  {% endif %}
                {% endfor %}
                {% for state in ns.tasks | sort(attribute='attributes.updated', reverse=true) %}
                  {% set ns.count = ns.count + 1 %}
                  {% if ns.count is even %}
                    {% set task_id = state_attr(state.entity_id, 'task_id') %}
                    {% set task_title = state_attr(state.entity_id, 'title') %}
                    {% set flat_items = state_attr(state.entity_id, 'flat_items') or [] %}
                    {% set statuses = state_attr(state.entity_id, 'statuses') or [{'id':'todo','name':'To Do','order':0},{'id':'in_progress','name':'In Progress','order':1},{'id':'completed','name':'Completed','order':2}] %}
                    {% set completed = state_attr(state.entity_id, 'completed') %}
                    {% set total = state_attr(state.entity_id, 'total') %}
                    {% set has_reminder = reminder_configs is mapping and task_id in reminder_configs %}
                    {% set has_recurring = recurring_configs is mapping and task_id in recurring_configs %}
                    {% set config = reminder_configs.get(task_id, {}) if reminder_configs is mapping else {} %}
                    {% set rec_config = recurring_configs.get(task_id, {}) if recurring_configs is mapping else {} %}
                    <div class="task-card">
                      <div class="task-header">
                        <div class="task-title">{{ task_title }}</div>
                        <div class="header-actions">
                          <button class="reminder-btn {{ 'active' if has_reminder else 'inactive' }}" title="{{ 'Edit reminder' if has_reminder else 'Add reminder' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.reminder-section');if(panel){panel.classList.toggle('show');}})(this);">Remind</button>
                          <button class="recurring-btn {{ 'active' if has_recurring else 'inactive' }}" title="{{ 'Edit recurring reset' if has_recurring else 'Add recurring reset' }}" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.recurring-section');if(panel){panel.classList.toggle('show');}})(this);">Reset</button>
                          <div class="task-progress">{{ completed }}/{{ total }}</div>
                        </div>
                      </div>
                      <div class="task-items">
                        {% for item in flat_items %}
                          {% set index_path = item.index_path | default('0') %}
                          {% set depth = index_path.split('.') | length - 1 %}
                          <div class="task-item depth-{{ depth }} status-{{ item.status }}">
                            <span class="task-item-text {{ 'completed' if item.status == 'completed' else '' }}">{{ item.text }}</span>
                            <select class="task-status-select" onchange="(function(sel){sel.disabled=true;sel.parentElement.style.opacity='0.5';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||status|||'+sel.value});}})(this);">
                              {% for status in statuses | sort(attribute='order') %}
                                <option value="{{ status.id }}" {{ 'selected' if item.status == status.id else '' }}>{{ status.name }}</option>
                              {% endfor %}
                            </select>
                            <button class="add-sub-btn" title="Add sub-task" onclick="(function(btn){const txt=prompt('Enter sub-task:');if(txt&&txt.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt.trim()+'|||todo|||{{ index_path }}'});}}})(this);">+</button>
                            <button class="delete-item-btn" onclick="if(confirm('Delete?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||{{ index_path }}|||delete_item'});}}">Delete
                          </div>
                        {% endfor %}
                      </div>
                      <div class="add-task-section">
                        <input type="text" class="add-task-input" placeholder="Add new task...">
                        <select class="task-status-select" style="min-width:100px;">
                          {% for status in statuses | sort(attribute='order') %}
                            <option value="{{ status.id }}">{{ status.name }}</option>
                          {% endfor %}
                        </select>
                        <button class="add-task-btn" onclick="(function(btn){const inp=btn.parentElement.querySelector('.add-task-input');const sel=btn.parentElement.querySelector('.task-status-select');if(!inp.value.trim())return;const txt=inp.value.trim();const st=sel.value;inp.value='';btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||add|||'+txt+'|||'+st});}setTimeout(function(){btn.disabled=false;},2000);})(this);">Add Item</button>
                        <button class="kanban-btn" onclick="(function(btn){var panel=btn.closest('.task-card').querySelector('.status-section');if(panel){panel.classList.toggle('show');}})(this);">Task Categories</button>
                        <button class="delete-task-btn" onclick="if(confirm('Delete {{ task_title | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_quick_task_action_data',value:'{{ task_id }}|||delete'});}}">Delete
                      </div>
                      <div class="status-section">
                        <strong>Kanban Task Columns</strong>
                        <div class="status-list">
                          {% for status in statuses | sort(attribute='order') %}
                            <div class="status-item">
                              <div class="status-color" style="background:{{ status.color if status.color else 'var(--secondary-text-color)' }};"></div>
                              <span class="status-name">{{ status.name }}</span>
                              <span class="status-id">({{ status.id }})</span>
                              <button style="padding:2px 6px;background:var(--warning-color, #ff9800);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="(function(btn){const newLabel=prompt('New label:','{{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}');if(newLabel&&newLabel.trim()){btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'update_status|||{{ task_id }}|||{{ status.id }}|||'+newLabel.trim()});}}})(this);">Edit</button>
                              {% if statuses | length > 1 %}
                              <button style="padding:2px 6px;background:var(--error-color);color:var(--text-primary-color, white);border:none;border-radius:4px;cursor:pointer;font-size:0.75em;" onclick="if(confirm('Delete {{ status.name | replace('"', '&quot;') | replace("'", "\\'") }}?')){const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'delete_status|||{{ task_id }}|||{{ status.id }}'});}}">Delete
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        <div class="new-status-form">
                          <input type="text" placeholder="ID (e.g. review)" style="width:100px;" class="new-status-id">
                          <input type="text" placeholder="Label" style="width:120px;" class="new-status-label">
                          <input type="color" value="var(--info-color, #3b82f6)" class="new-status-color">
                          <button class="add-task-btn" style="padding:6px 12px;" onclick="(function(btn){const form=btn.closest('.new-status-form');const idInp=form.querySelector('.new-status-id');const labelInp=form.querySelector('.new-status-label');const colorInp=form.querySelector('.new-status-color');if(!idInp.value.trim()||!labelInp.value.trim()){alert('ID and Label required');return;}btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('input_text','set_value',{entity_id:'input_text.jottick_kanban_action_data',value:'create_status|||{{ task_id }}|||'+idInp.value.trim()+'|||'+labelInp.value.trim()+'|||'+colorInp.value});}idInp.value='';labelInp.value='';setTimeout(function(){btn.disabled=false;},2000);})(this);">Add Task Column</button>
                        </div>
                      </div>
                      <div class="reminder-section">
                        <h4>Reminder Notification Settings</h4>
                        <div class="reminder-row" style="flex-direction:column;align-items:flex-start;">
                          <label>Notify:</label>
                          <div class="r-targets" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;">
                            {% set saved_targets = (config.get('targets','') or config.get('target','')) %}
                            {% for n in notifiers %}{% if n != 'Nobody' %}
                            <label style="display:flex;align-items:center;gap:4px;font-size:0.9em;cursor:pointer;"><input type="checkbox" class="r-target-cb" value="{{ n }}" {{ 'checked' if n in saved_targets else '' }}><span>{{ n.replace('notify.mobile_app_','') }}</span></label>
                            {% endif %}{% endfor %}
                          </div>
                        </div>
                        <div class="reminder-row">
                          <label>Every:</label>
                          <select class="r-interval">
                            {% for iv in ['30 minutes','1 hour','2 hours','4 hours','8 hours','12 hours','Once a day'] %}<option value="{{ iv }}" {{ 'selected' if config.get('interval','1 hour')==iv else '' }}>{{ iv }}</option>{% endfor %}
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="r-days">
                            <option value="weekdays" {{ 'selected' if config.get('days','weekdays')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if config.get('days','weekdays')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if config.get('days','weekdays')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Title:</label>
                          <input type="text" class="r-title" placeholder="List/Task name" value="{{ config.get('custom_title','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>Message:</label>
                          <input type="text" class="r-message" placeholder="X item(s) remaining" value="{{ config.get('custom_message','') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-row">
                          <label>From:</label>
                          <input type="time" class="r-start" value="{{ config.get('start','09:00') }}">
                          <label>To:</label>
                          <input type="time" class="r-end" value="{{ config.get('end','21:00') }}">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" onclick="(function(btn){var sec=btn.closest('.reminder-section');var t=Array.from(sec.querySelectorAll('.r-target-cb:checked')).map(cb=>cb.value).join(',');if(!t){alert('Select at least one device');return;}var i=sec.querySelector('.r-interval').value;var d=sec.querySelector('.r-days').value;var s=sec.querySelector('.r-start').value;var e=sec.querySelector('.r-end').value;var ti=sec.querySelector('.r-title').value;var m=sec.querySelector('.r-message').value;btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_reminder_inline',{item_id:'{{ task_id }}',item_type:'task',target:t,interval:i,days:d,start_time:s,end_time:e,custom_title:ti,custom_message:m});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove reminder?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_reminder_inline',{item_id:'{{ task_id }}'});}var sec=btn.closest('.reminder-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                      <div class="recurring-section">
                        <h4>Daily Reset</h4>
                        <div class="reminder-row">
                          <label>Days:</label>
                          <select class="rec-days">
                            <option value="weekdays" {{ 'selected' if rec_config.get('days','every_day')=='weekdays' else '' }}>Weekdays</option>
                            <option value="weekends" {{ 'selected' if rec_config.get('days','every_day')=='weekends' else '' }}>Weekends</option>
                            <option value="every_day" {{ 'selected' if rec_config.get('days','every_day')=='every_day' else '' }}>Every day</option>
                          </select>
                        </div>
                        <div class="reminder-row">
                          <label>Preset:</label>
                          <select class="rec-preset" onchange="(function(sel){var t=sel.closest('.recurring-section').querySelector('.rec-times');if(sel.value!='custom'){t.value=sel.value;}t.style.display=sel.value=='custom'?'block':'none';})(this);" style="flex:1;min-width:180px;">
                            <option value="custom">Custom...</option>
                            <optgroup label="Once Daily">
                              <option value="05:00">5:00 AM</option>
                              <option value="06:00">6:00 AM</option>
                              <option value="07:00">7:00 AM</option>
                              <option value="08:00">8:00 AM</option>
                              <option value="09:00">9:00 AM</option>
                              <option value="12:00">12:00 PM</option>
                              <option value="18:00">6:00 PM</option>
                              <option value="21:00">9:00 PM</option>
                              <option value="00:00">12:00 AM (midnight)</option>
                            </optgroup>
                            <optgroup label="Twice Daily">
                              <option value="06:00, 18:00">6:00 AM, 6:00 PM</option>
                              <option value="06:00, 21:00">6:00 AM, 9:00 PM</option>
                              <option value="08:00, 20:00">8:00 AM, 8:00 PM</option>
                              <option value="09:00, 17:00">9:00 AM, 5:00 PM</option>
                              <option value="09:00, 21:00">9:00 AM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Three Times Daily">
                              <option value="06:00, 12:00, 18:00">6:00 AM, 12:00 PM, 6:00 PM</option>
                              <option value="06:00, 12:00, 21:00">6:00 AM, 12:00 PM, 9:00 PM</option>
                              <option value="07:00, 12:00, 19:00">7:00 AM, 12:00 PM, 7:00 PM</option>
                              <option value="08:00, 14:00, 20:00">8:00 AM, 2:00 PM, 8:00 PM</option>
                              <option value="09:00, 15:00, 21:00">9:00 AM, 3:00 PM, 9:00 PM</option>
                            </optgroup>
                            <optgroup label="Frequent">
                              <option value="06:00, 14:00, 22:00">Every 8 hours (6 AM, 2 PM, 10 PM)</option>
                              <option value="06:00, 12:00, 18:00, 00:00">Every 6 hours (6 AM, 12 PM, 6 PM, 12 AM)</option>
                              <option value="06:00, 10:00, 14:00, 18:00, 22:00">Every 4 hours (6 AM - 10 PM)</option>
                              <option value="06:00, 09:00, 12:00, 15:00, 18:00, 21:00">Every 3 hours (6 AM - 9 PM)</option>
                            </optgroup>
                          </select>
                        </div>
                        <div class="reminder-row" style="display:{{ 'flex' if rec_config.get('reset_times') else 'none' }};">
                          <label>Times:</label>
                          <input type="text" class="rec-times" placeholder="06:00, 14:00" value="{{ rec_config.get('reset_times', []) | join(', ') }}" style="flex:1;min-width:150px;">
                        </div>
                        <div class="reminder-actions">
                          <button class="reminder-save-btn" style="background:var(--success-color);" onclick="(function(btn){var sec=btn.closest('.recurring-section');var d=sec.querySelector('.rec-days').value;var preset=sec.querySelector('.rec-preset').value;var timesInput=sec.querySelector('.rec-times');var t=preset!='custom'?preset:timesInput.value;if(!t.trim()){alert('Select a preset or enter custom times');return;}btn.disabled=true;btn.textContent='Saving...';const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_save_recurring',{item_id:'{{ task_id }}',item_type:'task',days:d,reset_times:t});}setTimeout(function(){btn.disabled=false;btn.textContent='Save';sec.classList.remove('show');},1500);})(this);">Save</button>
                          <button class="reminder-remove-btn" onclick="(function(btn){if(!confirm('Remove recurring reset?'))return;btn.disabled=true;const el=document.querySelector('home-assistant');if(el&&el.hass){el.hass.callService('script','jottick_remove_recurring',{item_id:'{{ task_id }}'});}var sec=btn.closest('.recurring-section');setTimeout(function(){sec.classList.remove('show');},1000);})(this);">Remove</button>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
  - title: Quick
    path: quick
    icon: mdi:lightning-bolt
    cards:
      - type: markdown
        content: |
          # Quick Actions
          One-tap notes and lists!
      - type: button
        name: Refresh All Data
        icon: mdi:refresh
        tap_action:
          action: call-service
          service: script.jottick_refresh_dashboard_data
        show_state: false
      - type: grid
        columns: 2
        cards:
          - type: button
            name: Shopping List
            icon: mdi:cart
            tap_action:
              action: call-service
              service: jottick.create_checklist
              service_data:
                title: Shopping List
                type: simple
          - type: button
            name: To-Do Today
            icon: mdi:calendar-today
            tap_action:
              action: call-service
              service: jottick.create_task
              service_data:
                title: '{{ now().strftime(''%A'') }} Tasks'
          - type: button
            name: Quick Note
            icon: mdi:note-plus
            tap_action:
              action: call-service
              service: jottick.create_note
              service_data:
                title: 'Note: {{ now().strftime(''%H:%M'') }}'
                content: ''
          - type: button
            name: Reminder
            icon: mdi:bell
            tap_action:
              action: call-service
              service: jottick.create_note
              service_data:
                title: Reminder
                content: Don't forget to...
          - type: button
            name: Meal Plan
            icon: mdi:food
            tap_action:
              action: call-service
              service: jottick.create_note
              service_data:
                title: Meal Plan
                content: |-
                  Monday:
                  Tuesday:
                  Wednesday:
          - type: button
            name: Packing List
            icon: mdi:bag-checked
            tap_action:
              action: call-service
              service: jottick.create_checklist
              service_data:
                title: Packing List
                type: simple
          - type: button
            name: New Task List
            icon: mdi:clipboard-plus
            tap_action:
              action: call-service
              service: jottick.create_task
              service_data:
                title: Tasks {{ now().strftime('%m/%d') }}
          - type: button
            name: Update Dropdowns
            icon: mdi:sync
            tap_action:
              action: call-service
              service: script.jottick_update_both_dropdowns
          - type: button
            name: Force Refresh
            icon: mdi:database-refresh
            tap_action:
              action: call-service
              service: homeassistant.update_entity
              service_data:
                entity_id:
                  - sensor.jottick_total_notes
                  - sensor.jottick_total_checklists
                  - sensor.jottick_total_tasks
          - type: button
            name: Refresh Notifiers
            icon: mdi:bell-ring
            tap_action:
              action: call-service
              service: script.jottick_refresh_notifiers
  - title: Stats
    path: stats
    icon: mdi:chart-box
    cards:
      - type: markdown
        content: |
          # Family Stats
      - type: horizontal-stack
        cards:
          - type: statistic
            entity: sensor.jottick_total_notes
            name: Notes
            stat_type: mean
            period: 999
          - type: statistic
            entity: sensor.jottick_total_checklists
            name: Lists
            stat_type: mean
            period: 999
          - type: statistic
            entity: sensor.jottick_total_tasks
            name: Tasks
            stat_type: mean
            period: 999
          - type: statistic
            entity: sensor.jottick_completion_rate
            name: Done
            unit: '%'
            stat_type: mean
            period: 999
      - type: horizontal-stack
        cards:
          - type: statistic
            entity: sensor.jottick_total_items
            name: Items
            stat_type: mean
            period: 99
          - type: statistic
            entity: sensor.jottick_completed_items
            name: Done
            stat_type: mean
            period: 99
          - type: statistic
            entity: sensor.jottick_pending_items
            name: Pending
            stat_type: mean
            period: 99
      - type: entities
        title: Detailed Statistics
        entities:
          - entity: sensor.jottick_total_notes
            name: Total Notes
            icon: mdi:note-text
          - entity: sensor.jottick_total_checklists
            name: Total Lists
            icon: mdi:format-list-checks
          - entity: sensor.jottick_total_tasks
            name: Total Tasks
            icon: mdi:clipboard-list
          - entity: sensor.jottick_total_items
            name: Total Items
            icon: mdi:checkbox-multiple-marked
          - entity: sensor.jottick_completed_items
            name: Completed Items
            icon: mdi:check-all
          - entity: sensor.jottick_pending_items
            name: Pending Items
            icon: mdi:clock-outline
          - entity: sensor.jottick_completion_rate
            name: Completion Rate
            icon: mdi:percent
