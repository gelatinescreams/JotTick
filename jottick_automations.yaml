# =============================================================================
# JotTick HOME ASSISTANT INTEGRATION VIA HACS
# Copy and paste this at the bottom of automations.yaml
# =============================================================================

- id: jottick_auto_update_note_picker_fixed
  alias: 'JotTick: Auto Update Note Picker'
  trigger:
  - platform: state
    entity_id:
    - sensor.jottick_total_notes
  - platform: homeassistant
    event: start
  action:
  - service: input_select.set_options
    target:
      entity_id: input_select.jottick_note_picker
    data:
      options: "{%- set ns = namespace(items=['-- Pick a note --'], titles={}) -%}
        {%- set notes = states.sensor | selectattr('name', 'search', '^JotTick Note:')
        | rejectattr('state', 'eq', 'unavailable') | list -%} {%- for state in notes
        -%}\n  {%- set title = state.state -%}\n  {%- if title in ns.titles -%}\n
        \   {%- set ns.titles = dict(ns.titles, **{title: ns.titles[title] + 1}) -%}\n
        \ {%- else -%}\n    {%- set ns.titles = dict(ns.titles, **{title: 1}) -%}\n
        \ {%- endif -%}\n{%- endfor -%} {%- set ns2 = namespace(counts={}) -%} {%-
        for state in notes | sort(attribute='attributes.updated', reverse=true) -%}\n
        \ {%- set title = state.state -%}\n  {%- set note_id = state_attr(state.entity_id,
        'note_id') -%}\n  {%- if ns.titles[title] > 1 -%}\n    {%- set current_count
        = ns2.counts.get(title, 0) + 1 -%}\n    {%- set ns2.counts = dict(ns2.counts,
        **{title: current_count}) -%}\n    {%- set display_title = title ~ ' (' ~
        note_id[-6:] ~ ')' -%}\n  {%- else -%}\n    {%- set display_title = title
        -%}\n  {%- endif -%}\n  {%- set ns.items = ns.items + [display_title] -%}\n{%-
        endfor -%} {{ ns.items }}"

- id: jottick_auto_update_checklist_picker_fixed
  alias: 'JotTick: Auto Update Checklist Picker'
  trigger:
  - platform: state
    entity_id:
    - sensor.jottick_total_checklists
  - platform: homeassistant
    event: start
  action:
  - service: input_select.set_options
    target:
      entity_id: input_select.jottick_checklist_picker
    data:
      options: "{%- set ns = namespace(items=['-- Pick a checklist --'], titles={})
        -%} {%- set lists = states.sensor | selectattr('name', 'search', '^JotTick List:')
        | rejectattr('state', 'eq', 'unavailable') | list -%} {%- for state in lists
        -%}\n  {%- set title = state_attr(state.entity_id, 'title') -%}\n  {%- if
        title -%}\n    {%- if title in ns.titles -%}\n      {%- set ns.titles = dict(ns.titles,
        **{title: ns.titles[title] + 1}) -%}\n    {%- else -%}\n      {%- set ns.titles
        = dict(ns.titles, **{title: 1}) -%}\n    {%- endif -%}\n  {%- endif -%}\n{%-
        endfor -%} {%- set ns2 = namespace(counts={}) -%} {%- for state in lists |
        sort(attribute='attributes.updated', reverse=true) -%}\n  {%- set title =
        state_attr(state.entity_id, 'title') -%}\n  {%- if title -%}\n    {%- set
        list_id = state_attr(state.entity_id, 'checklist_id') -%}\n    {%- if ns.titles[title]
        > 1 -%}\n      {%- set current_count = ns2.counts.get(title, 0) + 1 -%}\n
        \     {%- set ns2.counts = dict(ns2.counts, **{title: current_count}) -%}\n
        \     {%- set display_title = title ~ ' (' ~ list_id[-6:] ~ ')' -%}\n    {%-
        else -%}\n      {%- set display_title = title -%}\n    {%- endif -%}\n    {%-
        set ns.items = ns.items + [display_title] -%}\n  {%- endif -%}\n{%- endfor
        -%} {{ ns.items }}"

- id: jottick_load_note_when_picked
  alias: 'JotTick: Load Note When Picked'
  trigger:
  - platform: state
    entity_id: input_select.jottick_note_picker
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state not in [''unknown'', ''unavailable'',
      ''-- Pick a note --''] }}'
  action:
  - variables:
      selected_option: '{{ states(''input_select.jottick_note_picker'') }}'
      selected_title: "{%- if '(' in selected_option and selected_option.endswith(')')
        -%}\n  {{ selected_option.split(' (')[0] }}\n{%- else -%}\n  {{ selected_option
        }}\n{%- endif -%}"
      note_id_hint: "{%- if '(' in selected_option and selected_option.endswith(')')
        -%}\n  {{ selected_option.split('(')[-1].rstrip(')') }}\n{%- else -%}\n  \n{%-
        endif -%}"
      note_entity: "{%- for s in states.sensor -%}\n  {%- if s.name.startswith('JotTick
        Note:') -%}\n    {%- if note_id_hint and state_attr(s.entity_id, 'note_id')
        and state_attr(s.entity_id, 'note_id').endswith(note_id_hint) -%}\n      {{
        s.entity_id }}\n    {%- elif not note_id_hint and s.state == selected_title
        -%}\n      {{ s.entity_id }}\n    {%- endif -%}\n  {%- endif -%}\n{%- endfor
        -%}"
  - condition: template
    value_template: '{{ note_entity | trim != '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jottick_note_id
    data:
      value: '{{ state_attr(note_entity, ''note_id'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jottick_edit_note_title
    data:
      value: '{{ states(note_entity) }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jottick_edit_note_content
    data:
      value: '{{ state_attr(note_entity, ''content'') or '''' }}'
      
- id: jottick_load_checklist_when_picked
  alias: 'JotTick: Load Checklist When Picked'
  trigger:
  - platform: state
    entity_id: input_select.jottick_checklist_picker
  condition:
  - condition: template
    value_template: '{{ trigger.to_state.state not in [''unknown'', ''unavailable'',
      ''-- Pick a checklist --''] }}'
  action:
  - variables:
      selected_option: '{{ states(''input_select.jottick_checklist_picker'') }}'
      selected_title: "{%- if '(' in selected_option and selected_option.endswith(')')
        -%}\n  {{ selected_option.split(' (')[0] }}\n{%- else -%}\n  {{ selected_option
        }}\n{%- endif -%}"
      list_id_hint: "{%- if '(' in selected_option and selected_option.endswith(')')
        -%}\n  {{ selected_option.split('(')[-1].rstrip(')') }}\n{%- else -%}\n  \n{%-
        endif -%}"
      list_entity: "{%- for s in states.sensor -%}\n  {%- if s.name.startswith('JotTick
        List:') -%}\n    {%- set title = state_attr(s.entity_id, 'title') -%}\n    {%-
        set list_id = state_attr(s.entity_id, 'checklist_id') -%}\n    {%- if list_id_hint
        and list_id and list_id.endswith(list_id_hint) -%}\n      {{ s.entity_id }}\n
        \   {%- elif not list_id_hint and title == selected_title -%}\n      {{ s.entity_id
        }}\n    {%- endif -%}\n  {%- endif -%}\n{%- endfor -%}"
  - condition: template
    value_template: '{{ list_entity | trim != '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jottick_selected_checklist_id
    data:
      value: '{{ state_attr(list_entity, ''checklist_id'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jottick_selected_checklist_title
    data:
      value: '{{ state_attr(list_entity, ''title'') or '''' }}'
  - service: input_text.set_value
    target:
      entity_id: input_text.jottick_selected_checklist_type
    data:
      value: '{{ state_attr(list_entity, ''type'') or ''simple'' }}'
      
- id: jottick_load_checklist_items
  alias: 'JotTick: Load Checklist Items'
  trigger:
  - platform: state
    entity_id: input_text.jottick_selected_checklist_id
  condition:
  - condition: template
    value_template: '{{ states(''input_text.jottick_selected_checklist_id'') not in
      ['''', ''unknown'', ''unavailable''] }}'
  action:
  - variables:
      checklist_id: '{{ states(''input_text.jottick_selected_checklist_id'') }}'
      list_entity: "{%- for s in states.sensor -%}\n  {%- if s.name.startswith('JotTick
        List:') -%}\n    {%- if state_attr(s.entity_id, 'checklist_id') == checklist_id
        -%}\n      {{ s.entity_id }}\n    {%- endif -%}\n  {%- endif -%}\n{%- endfor
        -%}"
  - condition: template
    value_template: '{{ list_entity | trim != '''' }}'
  - service: input_select.set_options
    target:
      entity_id: input_select.jottick_item_picker
    data:
      options: "{%- set items = state_attr(list_entity, 'items') or [] -%}\n{%- set
        ns = namespace(options=['-- Select item --']) -%}\n{%- for item in items -%}\n
        \ {%- set text = item.text | default('') -%}\n  {%- if text -%}\n    {%- set
        display = '[✓] ' ~ text if item.completed else '[ ] ' ~ text -%}\n    {%- set
        ns.options = ns.options + [display] -%}\n  {%- endif -%}\n{%- endfor -%}\n{{
        ns.options }}"

- id: jottick_check_reminder_notifications
  alias: "JotTick: Check Reminder Notifications"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/5"
  condition:
    - condition: template
      value_template: "{{ (state_attr('sensor.jottick_reminders', 'configs') or {}) | length > 0 }}"
  action:
    - variables:
        configs: "{{ state_attr('sensor.jottick_reminders', 'configs') or {} }}"
        current_hour: "{{ now().hour }}"
        current_minute: "{{ now().minute }}"
        current_day: "{{ now().strftime('%A') }}"
        is_weekday: "{{ current_day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] }}"
    - repeat:
        for_each: "{{ configs.keys() | list if configs is mapping else [] }}"
        sequence:
          - variables:
              item_id: "{{ repeat.item }}"
              config: "{{ configs[item_id] if configs[repeat.item] is defined else {} }}"
              item_type: "{{ config.type | default('checklist') }}"
              days: "{{ config.days | default('every_day') }}"
              start_time: "{{ config.start_time | default('08:00') }}"
              end_time: "{{ config.end_time | default('20:00') }}"
              interval_str: "{{ config.interval | default('1_hour') }}"
              last_sent: "{{ config.last_sent | default(0) }}"
              interval_minutes: >
                {% set i = interval_str %}
                {% if i == '30_min' %}30
                {% elif i == '1_hour' %}60
                {% elif i == '2_hours' %}120
                {% elif i == '4_hours' %}240
                {% elif i == '8_hours' %}480
                {% elif i == '12_hours' %}720
                {% elif i == 'once_daily' %}1440
                {% else %}60{% endif %}
              should_run_today: >
                {% if days == 'weekdays' %}
                  {{ is_weekday }}
                {% elif days == 'weekends' %}
                  {{ not is_weekday }}
                {% else %}
                  true
                {% endif %}
              start_parts: "{{ start_time.split(':') }}"
              end_parts: "{{ end_time.split(':') }}"
              start_minutes: "{{ (start_parts[0] | int) * 60 + (start_parts[1] | int) }}"
              end_minutes: "{{ (end_parts[0] | int) * 60 + (end_parts[1] | int) }}"
              current_minutes: "{{ current_hour * 60 + current_minute }}"
              in_time_window: "{{ current_minutes >= start_minutes | int and current_minutes <= end_minutes | int }}"
              minutes_since_last: "{{ ((as_timestamp(now()) - last_sent) / 60) | int if last_sent else 9999 }}"
              should_send: "{{ should_run_today and in_time_window and minutes_since_last >= interval_minutes | int }}"
          - condition: template
            value_template: "{{ should_send }}"
          - variables:
              sensor_entity: >
                {% set ns = namespace(found='') %}
                {% if item_type == 'task' %}
                  {% for s in states.sensor %}
                    {% if s.attributes.task_id is defined and s.attributes.task_id == item_id %}
                      {% set ns.found = s.entity_id %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {% for s in states.sensor %}
                    {% if s.attributes.checklist_id is defined and s.attributes.checklist_id == item_id %}
                      {% set ns.found = s.entity_id %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {{ ns.found }}
          - condition: template
            value_template: "{{ sensor_entity | trim != '' }}"
          - variables:
              total_items: "{{ state_attr(sensor_entity, 'total') | int(0) }}"
              completed_items: "{{ state_attr(sensor_entity, 'completed') | int(0) }}"
              has_incomplete: "{{ total_items > completed_items }}"
              item_title: "{{ state_attr(sensor_entity, 'title') | default('Reminder') }}"
              incomplete_count: "{{ total_items - completed_items }}"
          - condition: template
            value_template: "{{ has_incomplete }}"
          - variables:
              custom_title: "{{ config.custom_title | default('') }}"
              custom_message: "{{ config.custom_message | default('') }}"
              targets: "{{ config.targets | default(config.target | default('')) }}"
              target_list: "{{ targets.split(',') if targets else [] }}"
              notification_title: "{% if custom_title != '' %}{{ custom_title }}{% else %}{{ item_title }}{% endif %}"
              incomplete_items_list: >
                {% if item_type == 'task' %}
                  {% set items = state_attr(sensor_entity, 'flat_items') | default([]) %}
                  {% set incomplete = items | rejectattr('status', 'eq', 'completed') | map(attribute='text') | list %}
                {% else %}
                  {% set items = state_attr(sensor_entity, 'items') | default([]) %}
                  {% set incomplete = items | selectattr('completed', 'eq', false) | map(attribute='text') | list %}
                {% endif %}
                {{ incomplete | join('\n• ') }}
              notification_message: >
                {% if custom_message != '' %}
                  {{ custom_message }}
                {% else %}
                  • {{ incomplete_items_list | trim }}
                {% endif %}
          - repeat:
              count: "{{ target_list | length }}"
              sequence:
                - service: "{{ target_list[repeat.index - 1] }}"
                  data:
                    title: "{{ notification_title }}"
                    message: "{{ notification_message }}"
                    data:
                      tag: "jottick_{{ item_id }}"
                      actions:
                        - action: "JotTick_OPEN_{{ item_id }}"
                          title: "Open"
                        - action: "JotTick_SNOOZE_{{ item_id }}"
                          title: "Snooze"
          - service: script.jottick_update_last_sent
            data:
              item_id: "{{ item_id }}"

- id: jottick_handle_notification_actions
  alias: "JotTick: Handle Notification Actions"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
  condition:
    - condition: template
      value_template: "{{ trigger.event.data.action.startswith('JotTick_') }}"
  action:
    - variables:
        action: "{{ trigger.event.data.action }}"
        item_id: "{{ action.split('_', 2)[2] if action.split('_') | length > 2 else '' }}"
    - choose:
        - conditions: "{{ 'SNOOZE' in action }}"
          sequence:
            - service: script.jottick_update_last_sent
              data:
                item_id: "{{ item_id }}"
        - conditions: "{{ 'OPEN' in action }}"
          sequence:
            - service: persistent_notification.create
              data:
                title: "JotTick Item"
                message: "Open your JotTick dashboard to view this item."
                notification_id: "jottick_open_{{ item_id }}"        

- id: jottick_check_recurring_resets
  alias: "JotTick: Check Recurring Resets"
  trigger:
    - platform: time_pattern
      minutes: "/1"
  action:
    - variables:
        configs: "{{ state_attr('sensor.jottick_recurring', 'configs') or {} }}"
        current_time: "{{ now().strftime('%H:%M') }}"
        current_day: "{{ now().strftime('%A') }}"
        is_weekday: "{{ current_day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] }}"
    - condition: template
      value_template: "{{ configs is mapping and configs | length > 0 }}"
    - repeat:
        for_each: "{{ configs.keys() | list if configs is mapping else [] }}"
        sequence:
          - variables:
              item_id: "{{ repeat.item }}"
              config: "{{ configs[item_id] if configs[repeat.item] is defined else {} }}"
              item_type: "{{ config.type | default('checklist') }}"
              days: "{{ config.days | default('every_day') }}"
              reset_times: "{{ config.reset_times | default([]) if config.reset_times is defined else [] }}"
              should_run_today: >
                {% if days == 'weekdays' %}
                  {{ is_weekday }}
                {% elif days == 'weekends' %}
                  {{ not is_weekday }}
                {% else %}
                  true
                {% endif %}
              time_matches: "{{ current_time in reset_times }}"
          - condition: template
            value_template: "{{ should_run_today and time_matches }}"
          - choose:
              - conditions: "{{ item_type == 'task' }}"
                sequence:
                  - service: script.jottick_reset_task
                    data:
                      task_id: "{{ item_id }}"
              - conditions: "{{ item_type == 'checklist' }}"
                sequence:
                  - service: script.jottick_reset_checklist
                    data:
                      checklist_id: "{{ item_id }}"

- id: jottick_process_scheduled_notes
  alias: "JotTick Process Scheduled Notes"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/1"
  condition:
    - condition: template
      value_template: "{{ (state_attr('sensor.jottick_scheduled_notes', 'schedules') or {}) | length > 0 }}"
  action:
    - variables:
        schedules: "{{ state_attr('sensor.jottick_scheduled_notes', 'schedules') or {} }}"
        now_ts: "{{ as_timestamp(now()) }}"
    - repeat:
        for_each: "{{ schedules.keys() | list }}"
        sequence:
          - variables:
              sched_id: "{{ repeat.item }}"
              sched: "{{ schedules[sched_id] }}"
              sched_time: "{{ sched.scheduled_time | default('') }}"
              sched_ts: "{{ as_timestamp(sched_time) if sched_time else 0 }}"
          - condition: template
            value_template: "{{ sched_ts > 0 and sched_ts <= now_ts }}"
          - service: script.jottick_send_scheduled_note
            data:
              schedule_id: "{{ sched_id }}"
              title: "{{ sched.title | default('Reminder') }}"
              message: "{{ sched.message | default('') }}"
              targets: "{{ sched.targets | default('') }}"
              auto_delete: "{{ sched.auto_delete | default(false) }}" 
              
- id: jottick_process_quick_delete_item
  alias: "JotTick: Process Quick Delete Item"
  trigger:
    - platform: state
      entity_id: input_text.jottick_quick_delete_item_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        parts: "{{ trigger.to_state.state.split('|||') }}"
        list_id: "{{ parts[0] }}"
        item_index: "{{ parts[1] }}"
    - service: jottick.delete_checklist_item
      data:
        checklist_id: "{{ list_id }}"
        item_index: "{{ item_index }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jottick_quick_delete_item_data
      data:
        value: ""

- id: jottick_process_quick_task_action
  alias: "JotTick: Process Quick Task Action"
  trigger:
    - platform: state
      entity_id: input_text.jottick_quick_task_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        parts: "{{ trigger.to_state.state.split('|||') }}"
        task_id: "{{ parts[0] }}"
        action: "{{ parts[1] }}"
    - choose:
        - conditions: "{{ action == 'delete' }}"
          sequence:
            - service: jottick.delete_task
              data:
                task_id: "{{ task_id }}"
        - conditions: "{{ action == 'add' }}"
          sequence:
            - service: jottick.add_task_item
              data:
                task_id: "{{ task_id }}"
                text: "{{ parts[2] }}"
                status: "{{ parts[3] | default('todo') }}"
                parent_index: "{{ parts[4] if parts | length > 4 and parts[4] != '' else none }}"
        - conditions: "{{ parts[2] | default('') == 'status' }}"
          sequence:
            - service: jottick.update_task_item_status
              data:
                task_id: "{{ task_id }}"
                item_index: "{{ action }}"
                status: "{{ parts[3] }}"
        - conditions: "{{ parts[2] | default('') == 'delete_item' }}"
          sequence:
            - service: jottick.delete_task_item
              data:
                task_id: "{{ task_id }}"
                item_index: "{{ action }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jottick_quick_task_action_data
      data:
        value: ""

- id: jottick_process_kanban_action
  alias: "JotTick: Process Kanban Action"
  trigger:
    - platform: state
      entity_id: input_text.jottick_kanban_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        parts: "{{ trigger.to_state.state.split('|||') }}"
        action: "{{ parts[0] }}"
        task_id: "{{ parts[1] }}"
    - choose:
        - conditions: "{{ action == 'create_status' }}"
          sequence:
            - service: jottick.create_task_status
              data:
                task_id: "{{ task_id }}"
                status_id: "{{ parts[2] }}"
                label: "{{ parts[3] }}"
                color: "{{ parts[4] | default('#6b7280') }}"
        - conditions: "{{ action == 'update_status' }}"
          sequence:
            - service: jottick.update_task_status
              data:
                task_id: "{{ task_id }}"
                status_id: "{{ parts[2] }}"
                label: "{{ parts[3] }}"
        - conditions: "{{ action == 'delete_status' }}"
          sequence:
            - service: jottick.delete_task_status
              data:
                task_id: "{{ task_id }}"
                status_id: "{{ parts[2] }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jottick_kanban_action_data
      data:
        value: ""

- id: jottick_process_quick_action
  alias: "JotTick: Process Quick Action"
  trigger:
    - platform: state
      entity_id: input_text.jottick_quick_action_data
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['', 'unknown', 'unavailable'] }}"
  action:
    - variables:
        parts: "{{ trigger.to_state.state.split('|||') }}"
        list_id: "{{ parts[0] }}"
        action: "{{ parts[1] }}"
    - choose:
        - conditions: "{{ action == 'delete' }}"
          sequence:
            - service: jottick.delete_checklist
              data:
                checklist_id: "{{ list_id }}"
        - conditions: "{{ action == 'add' }}"
          sequence:
            - service: jottick.add_checklist_item
              data:
                checklist_id: "{{ list_id }}"
                text: "{{ parts[2] }}"
        - conditions: "{{ action == 'check' }}"
          sequence:
            - service: jottick.check_item
              data:
                checklist_id: "{{ list_id }}"
                item_index: "{{ parts[2] }}"
        - conditions: "{{ action == 'uncheck' }}"
          sequence:
            - service: jottick.uncheck_item
              data:
                checklist_id: "{{ list_id }}"
                item_index: "{{ parts[2] }}"
      default:
        - variables:
            item_index: "{{ action }}"
            check_action: "{{ parts[2] }}"
        - choose:
            - conditions: "{{ check_action == 'check' }}"
              sequence:
                - service: jottick.check_item
                  data:
                    checklist_id: "{{ list_id }}"
                    item_index: "{{ item_index }}"
            - conditions: "{{ check_action == 'uncheck' }}"
              sequence:
                - service: jottick.uncheck_item
                  data:
                    checklist_id: "{{ list_id }}"
                    item_index: "{{ item_index }}"
    - service: input_text.set_value
      target:
        entity_id: input_text.jottick_quick_action_data
      data:
        value: ""        